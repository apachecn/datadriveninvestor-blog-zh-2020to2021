<html>
<head>
<title>Detecting Pneumonia With 99.5% Accuracy Using FastAI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用FastAI以99.5%的准确率检测肺炎</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/detecting-pneumonia-with-99-5-accuracy-using-fastai-2de2157a9d2b?source=collection_archive---------9-----------------------#2021-01-15">https://medium.datadriveninvestor.com/detecting-pneumonia-with-99-5-accuracy-using-fastai-2de2157a9d2b?source=collection_archive---------9-----------------------#2021-01-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3aef50da4d61761a7a3cc6f6b5ac48ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PKe67s0bCNNaJqMC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@cdc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">CDC</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a7ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你醒来发现胸口有些痛。你开始咳嗽。你觉得呼吸困难，发烧。你现在非常担心自己的身体出了什么问题，并匆忙赶往医院。那里的医生怀疑是肺炎，但想进行胸部x光检查以证实。</p><blockquote class="le lf lg"><p id="a29a" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">肺炎是由一些病毒和细菌引起的感染，这些病毒和细菌使一个或两个肺部的气囊发炎。</p></blockquote><p id="bfc6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">测试结果呈阴性，但你和医生都不知道，这是假阴性。根据<a class="ae kf" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4608340/#:~:text=The%20sensitivity%20of%20CUS%20in,0.0%2D94.5)%2C%20respectively." rel="noopener ugc nofollow" target="_blank">国家生物技术信息中心</a>的数据，使用胸部x光检查肺炎只有93.3%的准确率。仅在美国，每年就有130万人感染肺炎，5万人死于肺炎。</p><p id="b1a2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是如果我们可以利用卷积神经网络来检测肺炎呢？事实证明，我们可以！</p><blockquote class="le lf lg"><p id="f0f3" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">阅读这篇文章了解<a class="ae kf" href="https://medium.com/swlh/ai-can-see-you-heres-how-425dd3ca7322" rel="noopener">卷积神经网络是如何工作的</a>！</p><p id="4c42" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">观看<a class="ae kf" href="https://youtu.be/MVx3JqXB_yk" rel="noopener ugc nofollow" target="_blank">我在这个项目上制作的</a>视频以及<a class="ae kf" href="https://github.com/eason-w/PneumoniaClassifier" rel="noopener ugc nofollow" target="_blank">我的GitHub库</a>！</p></blockquote></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><h1 id="5542" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">获取数据</h1><p id="562d" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">对于人工智能来说，数据是创建一个好的模型最重要的部分之一。如果你的模型在坏数据上训练，预测也将是坏的。垃圾进，垃圾出。</p><p id="cc53" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">寻找数据集的一个好地方是Kaggle。我使用的数据集<a class="ae kf" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia" rel="noopener ugc nofollow" target="_blank">有近6000张胸部x光照片，这些照片已经过质量控制筛选，删除了所有低质量或不可读的扫描。</a></p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/95d88eedd777c090a428957c8e1bb0fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zFLUPS0hAbKAeqgIMhDQrg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">A sample from the dataset of viral pneumonia</figcaption></figure><h1 id="98d2" class="ls lt it bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">破解密码</h1><p id="79a5" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">为了创建分类模型，我使用了FastAI，这是PyTorch的一个非常强大的API。</p><h2 id="ed0d" class="nf lt it bd lu ng nh dn ly ni nj dp mc kr nk nl mg kv nm nn mk kz no np mo nq bi translated">训练人工智能</h2><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="988c" class="nf lt it ns b gy nw nx l ny nz">!pip install -Uqq fastbook</span><span id="7f37" class="nf lt it ns b gy oa nx l ny nz">import fastbook</span><span id="5509" class="nf lt it ns b gy oa nx l ny nz">fastbook.setup_book()</span><span id="ed9a" class="nf lt it ns b gy oa nx l ny nz">from fastbook import *</span></pre><p id="341c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">代码的第一部分是将FastAI导入Jupyter笔记本，这允许我开始用FastAI而不仅仅是普通Python编码。它还允许我在上面安装Google Drive来导入文件。</p><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="a94e" class="nf lt it ns b gy nw nx l ny nz">lung_types = 'NORMAL','PNEUMONIA'</span><span id="7066" class="nf lt it ns b gy oa nx l ny nz">path = Path('/content/gdrive/My Drive/ReplicateFiles/train')</span></pre><p id="1b2a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这段代码定义了两种肺类型，并定义了获取文件的路径。</p><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="0f8c" class="nf lt it ns b gy nw nx l ny nz">lungs = DataBlock(</span><span id="e7e2" class="nf lt it ns b gy oa nx l ny nz">blocks=(ImageBlock, CategoryBlock),</span><span id="461d" class="nf lt it ns b gy oa nx l ny nz">get_items=get_image_files,</span><span id="9e0a" class="nf lt it ns b gy oa nx l ny nz">splitter=RandomSplitter(valid_pct=0.2, seed=42),</span><span id="1cba" class="nf lt it ns b gy oa nx l ny nz">get_y=parent_label,</span><span id="936e" class="nf lt it ns b gy oa nx l ny nz">item_tfms = Resize(256)</span><span id="4070" class="nf lt it ns b gy oa nx l ny nz">)<br/></span><span id="4c71" class="nf lt it ns b gy oa nx l ny nz">dls = lungs.dataloaders(path)</span></pre><p id="6d92" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这段代码通过将数据分割成一个验证集并将其调整为相同的大小来准备图像文件。它还定义了“<em class="lh">DLS”</em>，我们将在培训中使用它来定义从哪里获取文件。</p><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="286f" class="nf lt it ns b gy nw nx l ny nz">dls.valid.show_batch(max_n=16, nrows=2)</span></pre><p id="2087" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这显示了文件中的16个图像，我用它来验证所有文件都被正确导入，并且可以通过“<em class="lh"> dls </em>访问。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/b04b33913d532b1ae072219cfa7f7ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JHbgc2Rqz_NZkCQCmAcoDA.png"/></div></div></figure><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="3de8" class="nf lt it ns b gy nw nx l ny nz">learn = cnn_learner(dls, resnet152, metrics=accuracy)<br/>learn.fine_tune(25)</span></pre><p id="96ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将“<em class="lh">学习</em>功能定义为CNN学习者，它从“<em class="lh"> dls </em>获取文件，使用Resnet 152，并使用准确性度量。然后，它使用“<em class="lh">微调</em>进行25个时期的训练。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/1d7bac38cb371175eee16696cd93170a.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*hM-nwLyScoaQxZ-xRTu2MA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">After 25 epochs the model reaches 99.46% accuracy</figcaption></figure><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="678d" class="nf lt it ns b gy nw nx l ny nz">interp = ClassificationInterpretation.from_learner(learn)</span><span id="2eae" class="nf lt it ns b gy oa nx l ny nz">interp.plot_confusion_matrix()</span></pre><p id="3c68" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将绘制一个混淆矩阵，以查看模型哪里出错了，然而，这在检测两个以上事物的模型中会更有用。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi od"><img src="../Images/6e69c6c1cf48368369cac255e2244753.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*JUOSI8OIGVTYkYW6-_DYUA.png"/></div></figure><p id="fae8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！在大约80分钟的训练中，我们可以达到比医生更高的检测肺炎的准确率！</p><h2 id="94a0" class="nf lt it bd lu ng nh dn ly ni nj dp mc kr nk nl mg kv nm nn mk kz no np mo nq bi translated">导出和测试人工智能</h2><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="ea24" class="nf lt it ns b gy nw nx l ny nz">learn.export()</span><span id="e7f4" class="nf lt it ns b gy oa nx l ny nz">path = Path()</span><span id="1ebd" class="nf lt it ns b gy oa nx l ny nz">path.ls(file_exts='.pkl')</span></pre><p id="8f7a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这段代码简单地导出了模型，这样我们就可以重用它，而不需要重新训练整个模型。如果我们希望保留模型以备将来使用，这是很有用的(这样我们就不必再花80分钟来训练它)。通过导出模型，可以更容易地使用它制作web应用程序，并保持一致的准确性。</p><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="27af" class="nf lt it ns b gy nw nx l ny nz">learn_inf = load_learner(path/'export.pkl')</span><span id="4bc1" class="nf lt it ns b gy oa nx l ny nz">learn_inf.predict('/content/gdrive/MyDrive/ReplicateFiles/test/PNEUMONIA/person100_bacteria_481.jpeg')</span></pre><p id="4063" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这段代码定义了一个名为“<em class="lh"> learn_inf </em>的函数，它将使用我们刚刚导出的模型来做一些事情。第二行使用"<em class="lh"> predict </em>"函数对"<em class="lh"> learn_inf </em>"预测一个图像，根据文件名，可以判断是细菌性肺炎。但是模型能预测什么呢？结果如下:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/f3432fbc79f97ee2400c855f5d0b5ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*hWKhosWgE9NIsGUvQIBNCA.png"/></div></figure><p id="8cdf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我训练的模型以99.995%的置信度预测为肺炎。</p><h1 id="472e" class="ls lt it bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">病毒性和细菌性肺炎的鉴别</h1><p id="0474" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">既然我们知道该模型可以区分健康的和患有肺炎的肺部——那么，我们如何区分细菌性和病毒性肺炎呢？</p><p id="199c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">事实证明，我们不需要做太多的修改，只需要一行代码(将两种类型的肺炎分别添加到两个文件夹中)。</p><pre class="mw mx my mz gt nr ns nt nu aw nv bi"><span id="5390" class="nf lt it ns b gy nw nx l ny nz">lung_types = 'NORMAL','VIRUS','BACTERIA'</span></pre><p id="5e61" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更改后，代码的其余部分完全相同，结果如下:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi of"><img src="../Images/6ce2c696d812e28ebf2f83f40d20aa80.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/format:webp/1*B9lI0lFBgljDOZWHVLQ0NA.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">This model only has a 85% accuracy after 25 epochs.</figcaption></figure><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi og"><img src="../Images/9e6caf1c8908818fd61fdbb6a959fb87.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*3AgDxsGgtP1HhubCzaXMtA.png"/></div></figure><p id="32f7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如你所看到的，这个模型经常混淆细菌性和病毒性肺炎，导致第一个模型(99.5%)和这个模型(85%)之间的准确性下降了14.5%。</p><h1 id="cd66" class="ls lt it bd lu lv na lx ly lz nb mb mc md nc mf mg mh nd mj mk ml ne mn mo mp bi translated">最终要点和关键要点</h1><p id="7b92" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">由于<a class="ae kf" href="https://www.youtube.com/watch?v=lG4VkPoG3ko" rel="noopener ugc nofollow" target="_blank">贝叶斯法则</a>，使用人工智能诊断肺炎的准确性并不等同于你患肺炎的概率为阳性结果。正因为如此，医生很可能仍然需要，像这样的模型只会被用作建议。</p><p id="4479" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，医生们一直在利用人工智能来提高他们诊断的准确性，并且已经被证明是有效的。2019年，人工智能算法实现了93.73%的肺炎检测准确率，仅在医生准确率方面略有提高。当人工智能与医生一起作为推荐工具时，整体准确性应该会提高。</p><p id="f557" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像这样的模型对于医生和医院来说是非常有益的，可以用作提高诊断准确性的工具。</p><ul class=""><li id="ab48" class="oh oi it ki b kj kk kn ko kr oj kv ok kz ol ld om on oo op bi translated">数据对于拥有一个好的人工智能模型至关重要</li><li id="cce7" class="oh oi it ki b kj oq kn or kr os kv ot kz ou ld om on oo op bi translated">FastAI是人工智能的一个非常有用的工具，可以用来实现非常高的准确率</li><li id="1c10" class="oh oi it ki b kj oq kn or kr os kv ot kz ou ld om on oo op bi translated">创建一个人工智能模型有许多不同的步骤，通常遵循以下结构:导入必要的东西、处理数据、训练、导出和测试</li><li id="56f2" class="oh oi it ki b kj oq kn or kr os kv ot kz ou ld om on oo op bi translated">CNN非常强大，已经在帮助医生进行诊断，尽管他们应该只是提供一个建议</li></ul></div><div class="ab cl ll lm hx ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="im in io ip iq"><blockquote class="le lf lg"><p id="f303" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">嘿！非常感谢你阅读这篇文章！如果你想在我下次写文章时得到通知，请在<a class="ae kf" href="https://bit.ly/EWUMedium" rel="noopener ugc nofollow" target="_blank"> Medium </a>上关注我！真的很感谢！</p><p id="a6de" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">你也可以查看我的<a class="ae kf" href="https://bit.ly/EWUSite" rel="noopener ugc nofollow" target="_blank">网站</a>，订阅我的<a class="ae kf" href="https://bit.ly/EWUNewsletter" rel="noopener ugc nofollow" target="_blank">时事通讯</a>，关注我的<a class="ae kf" href="http://bit.ly/EWUTwitter" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae kf" href="https://bit.ly/EWULink" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>！</p></blockquote></div></div>    
</body>
</html>