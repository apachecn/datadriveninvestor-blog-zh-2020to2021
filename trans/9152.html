<html>
<head>
<title>I tried Google’s new Python fuzzer: Atheris</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我尝试了谷歌的新Python fuzzer: Atheris</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/i-tried-googles-new-python-fuzzer-atheris-f0b8b667794?source=collection_archive---------4-----------------------#2021-02-02">https://medium.datadriveninvestor.com/i-tried-googles-new-python-fuzzer-atheris-f0b8b667794?source=collection_archive---------4-----------------------#2021-02-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a67d920db69c6859618634962ac28d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7j_BSQ9mduzz_Iecc886vA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><a class="ae kc" href="https://pixabay.com/photos/green-buschviper-atheris-squamigera-1571957/" rel="noopener ugc nofollow" target="_blank">Atheris viper</a></figcaption></figure><p id="2ec0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模糊化是最近最流行的自动查找bug的方法之一。而像<a class="ae kc" href="https://github.com/AFLplusplus/AFLplusplus" rel="noopener ugc nofollow" target="_blank">美国Fuzzy Lop </a>、<a class="ae kc" href="https://github.com/google/honggfuzz" rel="noopener ugc nofollow" target="_blank">hongfuzz</a>等fuzzers。主要关注C/C++代码，直到现在Python还没有突破。最近，谷歌开源了他们的Python fuzzer <a class="ae kc" href="https://github.com/google/atheris" rel="noopener ugc nofollow" target="_blank"> Atheris </a>！</p><p id="28e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里阅读他们的博文:<a class="ae kc" href="https://opensource.googleblog.com/2020/12/announcing-atheris-python-fuzzer.html" rel="noopener ugc nofollow" target="_blank">宣布Atheris Python Fuzzer </a></p><p id="e5b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我开始之前，让我快速解释一下关于fuzzing的一些事情。每次我告诉我的朋友我在研究fuzzing/fuzzers，10次中有8次我得到的回答是“哦，是的，我知道模糊逻辑”。如果你是这些人中的一员，请花几分钟时间阅读下一节中的一些定义，然后再继续，否则你可以跳到下一节。</p><h2 id="d12f" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">起毛/起毛器:什么和类型？</h2><p id="5fb1" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">模糊测试是发现软件中的错误或漏洞的有效方法。用来模糊的程序叫做模糊器，被模糊的程序就是我们的目标。模糊器通常在观察目标程序的行为时开始向其输入随机输入。每当目标崩溃时，fuzzer会将导致崩溃的输入作为bug报告给用户。</p><p id="182a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有不同种类的起毛:</p><p id="50f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">黑盒模糊化:</strong>在没有关于被模糊化代码的信息的情况下进行模糊化。</p><p id="19dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">白盒模糊化:</strong>这里的模糊化器知道目标的完整结构，主要遵循符号执行。</p><p id="088d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">灰箱模糊化:</strong>模糊化器知道目标的部分信息，主要度量代码覆盖率。</p><p id="7cba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">灰盒模糊化的有趣之处在于，每当模糊化器发现一个生成唯一代码覆盖的新输入时，它会保存这个输入，以便在下一次迭代中进一步变异它。这被称为<strong class="kf ir">覆盖引导的模糊化</strong>。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="aed9" class="mg lc iq bd ld mh mi mj lg mk ml mm lj mn mo mp lm mq mr ms lp mt mu mv ls mw bi translated">atheris:Python fuzzer</h1><p id="bb91" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Atheris是第一个覆盖导向的Python fuzzers之一。这意味着，模糊器测量代码覆盖率，并在执行过程中观察目标程序，记下导致独特执行行为的输入。</p><p id="2b77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Atheris是一个高性能的fuzzer，支持本地和纯Python fuzzing。但我迫不及待想探索的功能是它的<em class="mx">差分模糊</em>！顾名思义，fuzzer试图找出两个不同库的行为差异，这两个库打算做同样的事情！！<br/>(我会单独写一篇关于微分模糊化的帖子。)</p><h2 id="afcd" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">装置</h2><p id="9619" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我在我的Linux机器上试了Atheris，安装很简单。</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="2731" class="lb lc iq nd b gy nh ni l nj nk">pip install atheris</span></pre><p id="be89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的，就这样。如果你在MacOS上(很快会尝试)，你需要安装完全成熟的Clang，而不是苹果发布的残缺版本，因为Artheris利用<a class="ae kc" href="https://llvm.org/docs/LibFuzzer.html" rel="noopener ugc nofollow" target="_blank"> libFuzzer </a>进行代码覆盖和输入生成。<br/>Atheris github上的安装说明简单易懂。</p><h2 id="93c7" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated"><strong class="ak">我们开始起毛吧</strong></h2><p id="fd25" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Atheris github页面和blogposts上给出的例子很少。先试用一下吧！</p><p id="0efa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">示例程序1: </strong></p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="4a8f" class="lb lc iq nd b gy nh ni l nj nk">import atheris<br/>import sys<br/><br/>def TestOneInput(data):<br/>  if data == b"bad":<br/>    raise RuntimeError("Badness!")<br/><br/>atheris.Setup(sys.argv, TestOneInput)<br/>atheris.Fuzz()</span></pre><p id="8ef8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将上述程序保存在您的计算机上。比如我保存为<em class="mx"> example1.py </em></p><p id="ef62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的例子中，我们模糊了函数“TestOneInput ”,它接受一个参数。如果参数为“bad ”,程序将抛出一个RuntimeError！</p><p id="9db8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行fuzzer很简单。只要执行代码！</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="5faa" class="lb lc iq nd b gy nh ni l nj nk">python ./example1.py</span></pre><p id="3dd7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果到目前为止您做的一切都是正确的，您将会看到fuzzer会在几秒钟内找到导致RuntimeError的输入，并将其写入文件。</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/3b069c8f7e37415ffb4126f13f7fea5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WLOUThZ6E6hiHcnUsCHljw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Fuzzing the example1.py program</figcaption></figure><p id="938e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在对生成的文件进行hexdump时，您会看到单词“bad”</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/f52ba9da61cac84f4ef4b8976e32c44d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-zP6108Gc4ORsqhAVuFvBA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">hexdump on crash log</figcaption></figure><p id="a165" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">示例程序2: </strong></p><p id="d6f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然最后一个程序相当简单，但为了测试fuzzer的代码覆盖能力，让我们尝试用一些嵌套的if语句进行fuzzing。这个想法是模糊器必须浏览if语句来找到bug。为此，我使用以下程序:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="0bc2" class="lb lc iq nd b gy nh ni l nj nk">import sys<br/>import atheris</span><span id="12c9" class="lb lc iq nd b gy nn ni l nj nk">def TestOneInput(data):  # Our entry point</span><span id="600b" class="lb lc iq nd b gy nn ni l nj nk">if len(data) != 8:<br/>        return</span><span id="e888" class="lb lc iq nd b gy nn ni l nj nk">if chr(data[0]) == "d":<br/>   if chr(data[1]) == "e":<br/>      if chr(data[2]) == "a":<br/>          if chr(data[3]) == "d":<br/>             if chr(data[4]) == "b":<br/>                if chr(data[5]) == "e":<br/>                   if chr(data[6]) == "e":<br/>                      if chr(data[7]) == "f":<br/>                         raise RuntimeError("Error input found!")</span><span id="6e6e" class="lb lc iq nd b gy nn ni l nj nk">atheris.Setup(sys.argv, TestOneInput)<br/>atheris.Fuzz()</span></pre><p id="1b60" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将上述代码保存为<em class="mx"> example2.py </em></p><p id="834c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的程序中，fuzzer必须在嵌套的if语句中导航，并找到单词“deadbeef”来找到bug。检查每个字符后，将测试fuzzer的代码覆盖能力。</p><p id="2d9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我运行程序时，阿瑟毫不费力就找到了漏洞。</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/b81667f62aea1633c518a649533e1ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4shLi60r_FdmtnlUZQDKMg.png"/></div></div></figure><p id="7163" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在打印的摘要中，我们甚至可以注意到用于导航分支的突变类型。崩溃文件上的hexdump显示了我们期望的输入:)</p><h1 id="8255" class="mg lc iq bd ld mh np mj lg mk nq mm lj mn nr mp lm mq ns ms lp mt nt mv ls mw bi translated">结论</h1><p id="e47c" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">Atheris支持模糊化Python代码和Python 2.7和Python 3.3+中的原生扩展。然而，为了获得更好的覆盖性能，建议使用Python 3.8+版本。</p><p id="3a01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着fuzzing成为主流测试技术，许多项目都是用Python编写的，Atheris无疑是对现有的基于覆盖率的fuzzers列表的一大补充。此外，谷歌已经宣布Atheris将很快成为OSS-Fuzz的一部分！</p><p id="96a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快乐起毛！</p><p id="3dc5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">干杯！</p></div></div>    
</body>
</html>