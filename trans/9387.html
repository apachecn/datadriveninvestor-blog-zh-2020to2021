<html>
<head>
<title>Zip AWS S3 Files using Elixir</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Elixir压缩AWS S3文件</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/zip-aws-s3-files-using-elixir-dde037ae38d0?source=collection_archive---------7-----------------------#2021-02-09">https://medium.datadriveninvestor.com/zip-aws-s3-files-using-elixir-dde037ae38d0?source=collection_archive---------7-----------------------#2021-02-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2a00" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何为AWS S3文件创建zip服务的一些提示。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e2689ce1cc2f5160eaf64ac46bef9585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IE2pj1wp0LhhM_PcISjwXA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Image by Romain Hiest - Pixabay.</figcaption></figure><p id="1497" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该服务必须从S3桶中下载一个由POST请求中的“aws key”表示的文件，压缩并上传，将压缩后的文件返回到桶中。</p><p id="7924" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了访问AWS S3，我们使用<a class="ae lr" href="https://hexdocs.pm/ex_aws/ExAws.html" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir">ex _ AWS</strong></a>e<a class="ae lr" href="https://hexdocs.pm/ex_aws_s3/ExAws.S3.html" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir">ex _ AWS _ S3</strong></a>。</p><p id="be9a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该服务提供一个端点来接收POST <code class="fe ls lt lu lv b">{ "params": { "aws_s3_key": "aws_key_from_your_file" } }</code>。</p><p id="7911" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将接收到的aws密钥插入到队列中，由<a class="ae lr" href="https://hexdocs.pm/broadway/Broadway.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">百老汇</strong> </a>进行处理。</p><blockquote class="lw lx ly"><p id="8617" class="kv kw lz kx b ky kz jr la lb lc ju ld ma lf lg lh mb lj lk ll mc ln lo lp lq ij bi translated">百老汇是一个并行、多阶段的工具，用于构建数据接收和数据处理管道。</p><p id="cb3f" class="kv kw lz kx b ky kz jr la lb lc ju ld ma lf lg lh mb lj lk ll mc ln lo lp lq ij bi translated">它允许开发人员高效地使用来自不同来源的数据，如亚马逊SQS、Apache Kafka、Google Cloud PubSub、RabbitMQ等。</p></blockquote><p id="5ca6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">百老汇需要一个消息队列，我使用了基于博客<a class="ae lr" href="https://akoutmos.com/post/broadway-rabbitmq-and-the-rise-of-elixir/" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">、RabbitMQ和长生不老药</strong> </a>的<a class="ae lr" href="https://hexdocs.pm/broadway/rabbitmq.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir"> RabbitMQ </strong> </a>。</p><h2 id="23e6" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">创建队列</h2><p id="a394" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">我需要3个新队列:</p><ul class=""><li id="f209" class="nb nc iq kx b ky kz lb lc le nd li ne lm nf lq ng nh ni nj bi translated"><em class="lz"> presigned_queue </em> —接收用户的请求参数；</li><li id="5a94" class="nb nc iq kx b ky nk lb nl le nm li nn lm no lq ng nh ni nj bi translated"><em class="lz"> downloaded_queue </em> —下载文件和zip</li><li id="33d3" class="nb nc iq kx b ky nk lb nl le nm li nn lm no lq ng nh ni nj bi translated"><em class="lz"> uploaded_queue </em> —上传zip到S3。</li></ul><p id="bb5c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如何创建您的队列？<a class="ae lr" href="https://hexdocs.pm/broadway/rabbitmq.html#content" rel="noopener ugc nofollow" target="_blank">看这里……</a>。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="359a" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.RMQPublisher do<br/>  <a class="ae lr" href="http://twitter.com/behaviour" rel="noopener ugc nofollow" target="_blank">@behaviour</a> GenRMQ.Publisher</span><span id="5e7a" class="md me iq lv b gy nx nu l nv nw">  @rmq_uri “amqp://rabbitmq:rabbitmq@localhost:5672”<br/>  @hn_exchange “something”<br/>  @presigned_queue “presigned_queue”<br/>  @downloaded_queue “downloaded_queue”<br/>  @uploaded_queue “uploaded_queue”<br/>  @publish_options [persistent: false]</span><span id="2348" class="md me iq lv b gy nx nu l nv nw">  def init do<br/>    create_rmq_resources()<br/>    [<br/>      uri: <a class="ae lr" href="http://twitter.com/rmq_uri" rel="noopener ugc nofollow" target="_blank">@rmq_uri</a>,<br/>      exchange: <a class="ae lr" href="http://twitter.com/hn_exchange" rel="noopener ugc nofollow" target="_blank">@hn_exchange</a><br/>    ]<br/>  end</span><span id="241e" class="md me iq lv b gy nx nu l nv nw">  def start_link do<br/>    GenRMQ.Publisher.start_link(__MODULE__, name: __MODULE__)<br/>  end</span><span id="2938" class="md me iq lv b gy nx nu l nv nw">  def publish_presigned_queue(data) do<br/>    GenRMQ.Publisher.publish(__MODULE__, data, @presigned_queue, @publish_options)<br/>  end</span><span id="801a" class="md me iq lv b gy nx nu l nv nw">  def publish_downloaded_queue(data) do<br/>    GenRMQ.Publisher.publish(__MODULE__, data, @downloaded_queue, @publish_options)<br/>  end</span><span id="7769" class="md me iq lv b gy nx nu l nv nw">  def publish_uploaded_queue(data) do<br/>    GenRMQ.Publisher.publish(__MODULE__, data, @uploaded_queue, @publish_options)<br/>  end</span><span id="eca2" class="md me iq lv b gy nx nu l nv nw">  def presigned_queue, do: <a class="ae lr" href="http://twitter.com/presigned_queue" rel="noopener ugc nofollow" target="_blank">@presigned_queue</a><br/>  def downloaded_queue, do: <a class="ae lr" href="http://twitter.com/downloaded_queue" rel="noopener ugc nofollow" target="_blank">@downloaded_queue</a><br/>  def uploaded_queue, do: <a class="ae lr" href="http://twitter.com/uploaded_queue" rel="noopener ugc nofollow" target="_blank">@uploaded_queue</a></span><span id="f625" class="md me iq lv b gy nx nu l nv nw">  defp create_rmq_resources do<br/>    {:ok, connection} = AMQP.Connection.open(<a class="ae lr" href="http://twitter.com/rmq_uri" rel="noopener ugc nofollow" target="_blank">@rmq_uri</a>)<br/>    {:ok, channel} = AMQP.Channel.open(connection)</span><span id="3d29" class="md me iq lv b gy nx nu l nv nw">    AMQP.Exchange.declare(channel, @hn_exchange, :topic, durable: true)</span><span id="e534" class="md me iq lv b gy nx nu l nv nw">    AMQP.Queue.declare(channel, @presigned_queue, durable: true)<br/>    AMQP.Queue.declare(channel, @downloaded_queue, durable: true)<br/>    AMQP.Queue.declare(channel, @uploaded_queue, durable: true)</span><span id="d52b" class="md me iq lv b gy nx nu l nv nw">    AMQP.Queue.bind(channel, @presigned_queue, @hn_exchange, routing_key: @presigned_queue)<br/>    AMQP.Queue.bind(channel, @downloaded_queue, @hn_exchange, routing_key: @downloaded_queue)<br/>    AMQP.Queue.bind(channel, @uploaded_queue, @hn_exchange, routing_key: @uploaded_queue)</span><span id="fd59" class="md me iq lv b gy nx nu l nv nw">    AMQP.Channel.close(channel)<br/>  end<br/>end</span></pre><h2 id="9f16" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">处理器已辞职</h2><p id="c15b" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">创建队列后，我定义了一个百老汇来使用<strong class="kx ir"> <em class="lz">预签名_队列</em> </strong>队列。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="5e72" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.ProcessorPresigned do<br/>  use Broadway</span><span id="565e" class="md me iq lv b gy nx nu l nv nw">  alias Broadway.Message</span><span id="0cd6" class="md me iq lv b gy nx nu l nv nw">  ... start_link ...</span><span id="9532" class="md me iq lv b gy nx nu l nv nw">  def handle_message(_, %Message{data: data} = message, _) do</span><span id="c541" class="md me iq lv b gy nx nu l nv nw">    # Get the key in the queue<br/>    aws_s3_key =<br/>      data<br/>      |&gt; Jason.decode!<br/>      |&gt; get_in([“aws_s3_key”])</span><span id="fae7" class="md me iq lv b gy nx nu l nv nw">    # Creates a presigned_url to download the file<br/>    url = <br/>      ExAws.Config.new(:s3)<br/>      |&gt; ExAws.S3.presigned_url(:get, “my_bucket”, aws_s3_key,[expires_in: 300])<br/>      |&gt; case do<br/>        {:ok, url} -&gt; url<br/>      end</span><span id="cc98" class="md me iq lv b gy nx nu l nv nw">    # Send the presigned key and url to the queue <em class="lz">downloaded_queue</em><br/>    %{url: url, key: aws_s3_key }<br/>    |&gt; Jason.encode!<br/>    |&gt; MyZip.RMQPublisher.publish_downloaded_queue</span><span id="2738" class="md me iq lv b gy nx nu l nv nw">    message<br/> end</span></pre><h2 id="258e" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">处理器下载</h2><p id="3367" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">我们现在需要一个百老汇来处理<strong class="kx ir"><em class="lz">downloaded _ queue</em></strong>，下载文件并生成一个zip文件。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="6300" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.ProcessorDownload do<br/>  use Broadway</span><span id="da05" class="md me iq lv b gy nx nu l nv nw">  alias Broadway.Message</span><span id="781b" class="md me iq lv b gy nx nu l nv nw">  ... start_link ...</span><span id="b966" class="md me iq lv b gy nx nu l nv nw">  def handle_message(_, %Message{data: data} = message, _) do<br/>    %{“key” =&gt; key, “url” =&gt; url} =<br/>      data |&gt; Jason.decode!</span><span id="770b" class="md me iq lv b gy nx nu l nv nw">    # Download file from AWS S3<br/>    file_downloaded = MyZip.HTTPDownloadStream.get(url)</span><span id="55d2" class="md me iq lv b gy nx nu l nv nw">    # Create a temporary zip file<br/>    {:ok, zip_path} = Briefly.create<br/> <br/>    # ZIP files<br/>    Zstream.zip(<br/>      [ Zstream.entry(key, file_downloaded) ]<br/>    )<br/>    |&gt; Stream.into(File.stream!(zip_path))<br/>    |&gt; Stream.run()</span><span id="f1ed" class="md me iq lv b gy nx nu l nv nw">    MyZip.RMQPublisher.publish_uploaded_queue(zip_path)</span><span id="ec47" class="md me iq lv b gy nx nu l nv nw">    message<br/>  end<br/>end</span></pre><h2 id="045c" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">下载文件</h2><p id="b2f3" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">为了下载S3文件，我们使用了函数<code class="fe ls lt lu lv b">HTTPDownloadStream.get/1</code>。该功能基于博客<a class="ae lr" href="https://www.poeticoding.com/elixir-streams-to-process-large-http-responses-on-the-fly/" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir">{ PoetiCoding }</strong></a>上显示的实现，使用<code class="fe ls lt lu lv b">Stream.Resource</code>并异步下载。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="d9fe" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.HTTPDownloadStream do<br/>  def get(url) do<br/>    Stream.resource(<br/>      fn -&gt; start_fun(url) end,<br/>      fn %HTTPoison.AsyncResponse{}=resp -&gt;<br/>        handle_async_resp(resp,emit_end)<br/>        {:end, resp}-&gt;<br/>          {:halt, resp}<br/>      end,</span><span id="4d43" class="md me iq lv b gy nx nu l nv nw">      fn %HTTPoison.AsyncResponse{id: id} -&gt;<br/>        :hackney.stop_async(id)<br/>      end<br/>    )<br/>  end</span><span id="5401" class="md me iq lv b gy nx nu l nv nw">  defp start_fun(url) do<br/>    HTTPoison.get!(url,%{}, [stream_to: self(), async: :once])<br/>  end</span><span id="04ee" class="md me iq lv b gy nx nu l nv nw">  defp handle_async_resp(%HTTPoison.AsyncResponse{id: id}=resp,emit_end) do<br/>    receive do<br/>      %HTTPoison.AsyncStatus{id: ^id, code: code}-&gt;<br/>        HTTPoison.stream_next(resp)<br/>        {[], resp}<br/>      %HTTPoison.AsyncHeaders{id: ^id, headers: headers}-&gt;<br/>        HTTPoison.stream_next(resp)<br/>        {[], resp}<br/>      %HTTPoison.AsyncChunk{id: ^id, chunk: chunk}-&gt;<br/>        HTTPoison.stream_next(resp)<br/>        {[chunk], resp}<br/>      %HTTPoison.AsyncEnd{id: ^id}-&gt;<br/>        if emit_end do<br/>          {[:end], {:end, resp}}<br/>        else<br/>          {:halt, resp}<br/>        end<br/>    after<br/>      5_000 -&gt; raise “receive timeout”<br/>    end<br/>  end<br/>end</span></pre><h2 id="5b43" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">处理器加载</h2><p id="febe" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">下载完成后，我们创建了一个临时文件来存储zip文件，简单来说使用<a class="ae lr" href="https://github.com/CargoSense/briefly" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir"/></a>。并且我们用<a class="ae lr" href="https://hexdocs.pm/zstream/Zstream.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir"> ZStream </strong> </a>压缩文件。压缩文件的路径被发送到<strong class="kx ir"> <em class="lz"> uploaded_queue </em> </strong>。</p><p id="0e1f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后百老汇处理了<strong class="kx ir"> <em class="lz">上传_队列</em> </strong>。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="fb5d" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.ProcessorUpload do<br/>  use Broadway</span><span id="6805" class="md me iq lv b gy nx nu l nv nw">  alias Broadway.Message</span><span id="08be" class="md me iq lv b gy nx nu l nv nw">  ... start_link ...</span><span id="790d" class="md me iq lv b gy nx nu l nv nw">  def handle_message(_, %Message{data: data} = message, _) do<br/>    data<br/>    |&gt; ExAws.S3.Upload.stream_file<br/>    |&gt; ExAws.S3.upload(“my-bucket-zip”, "zip-name.zip")<br/>    |&gt; ExAws.request!</span><span id="b273" class="md me iq lv b gy nx nu l nv nw">    message<br/>  end<br/>end</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h2 id="cc29" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">开始</h2><p id="4504" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">我们不能忘记初始化一切。</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="c757" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.Application do<br/>  <a class="ae lr" href="http://twitter.com/moduledoc" rel="noopener ugc nofollow" target="_blank">@moduledoc</a> false</span><span id="40a3" class="md me iq lv b gy nx nu l nv nw">  use Application</span><span id="c096" class="md me iq lv b gy nx nu l nv nw">  def start(_type, _args) do<br/>    children = [</span><span id="a258" class="md me iq lv b gy nx nu l nv nw">      ...other things...,</span><span id="d5b1" class="md me iq lv b gy nx nu l nv nw">      %{<br/>        id: MyZip.RMQPublisher,<br/>        start: {MyZip.RMQPublisher, :start_link, []}<br/>      },<br/>      MyZip.ProcessorPresigned,<br/>      MyZip.ProcessorDownload,<br/>      MyZip.ProcessorUpload<br/>    ]</span><span id="34f6" class="md me iq lv b gy nx nu l nv nw">    opts = [strategy: :one_for_one, name: MyZip.Supervisor]<br/>    Supervisor.start_link(children, opts)<br/>  end<br/>end</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h2 id="2a41" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">属国</h2><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="ba14" class="md me iq lv b gy nt nu l nv nw">defmodule MyZip.MixProject do<br/>  use Mix.Project</span><span id="765a" class="md me iq lv b gy nx nu l nv nw">  ....</span><span id="c60b" class="md me iq lv b gy nx nu l nv nw">  defp deps do<br/>    [<br/>      {:phoenix, “~&gt; 1.5.7”},</span><span id="03a1" class="md me iq lv b gy nx nu l nv nw">      ....others dependencies...,</span><span id="3df9" class="md me iq lv b gy nx nu l nv nw">      {:jason, “~&gt; 1.1.2”},<br/>      {:broadway, “~&gt; 0.4.0”},<br/>      {:broadway_rabbitmq, “~&gt; 0.4.0”},<br/>      {:gen_rmq, “~&gt; 2.3.0”},<br/>      {:ex_aws, “~&gt; 2.0”},<br/>      {:ex_aws_s3, “~&gt; 2.0”},<br/>      {:httpoison, “~&gt; 1.8”},<br/>      {:sweet_xml, “~&gt; 0.6.6”},<br/>      {:zstream, “~&gt; 0.5.2”},<br/>      {<br/>        :briefly,<br/>        git: “<a class="ae lr" href="https://github.com/CargoSense/briefly" rel="noopener ugc nofollow" target="_blank">https://github.com/CargoSense/briefly</a>”,<br/>        ref: “2526e9674a4e6996137e066a1295ea60962712b8”<br/>      }<br/>    ]<br/>  end<br/>end</span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h2 id="e71e" class="md me iq bd mf mg mh dn mi mj mk dp ml le mm mn mo li mp mq mr lm ms mt mu mv bi translated">怎么考？</h2><p id="2681" class="pw-post-body-paragraph kv kw iq kx b ky mw jr la lb mx ju ld le my lg lh li mz lk ll lm na lo lp lq ij bi translated">为了测试我创建了一个文件<strong class="kx ir"> <em class="lz"> ab。JSON </em> </strong> <em class="lz"> </em>项目<em class="lz">的根源。</em></p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="21cd" class="md me iq lv b gy nt nu l nv nw">{ <br/>  “params”: { <br/>    “type”: “asset”,<br/>    “aws_s3_key”: “77d346e5072f315869909ffdd692d91c.JPG”}<br/>}</span></pre><p id="0c2b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我执行了:</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="3fd3" class="md me iq lv b gy nt nu l nv nw">ab -c 1 -n 10 -p ab.json -T application/json — verbose <a class="ae lr" href="http://127.0.0.1:4000/api/zip" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:4000/api/zip</a></span></pre></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><p id="eb1f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">希望这对你有帮助。尽情享受吧！！</p></div></div>    
</body>
</html>