<html>
<head>
<title>Extracting EXIF data using LWC and VF page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用LWC和VF page提取EXIF数据</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/extracting-exif-data-using-lwc-and-vf-page-fb2a3fe8b3f?source=collection_archive---------7-----------------------#2021-02-08">https://medium.datadriveninvestor.com/extracting-exif-data-using-lwc-and-vf-page-fb2a3fe8b3f?source=collection_archive---------7-----------------------#2021-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/094731e40861abcef473592b50030418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WISLnmNu0SARJPbqqL6aNA.png"/></div></div></figure><div class=""/><p id="cb2f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">问题陈述:</strong>保险公司需要分析索赔人上传的照片证据，以确定它们是真实的还是经过篡改的。</p><p id="cb41" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，什么是EXIF数据？</p><p id="7ce6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">可交换图像文件格式</strong> (EXIF)是一种标准，定义了与数码相机拍摄的图像或其他媒体相关的特定信息。它能够存储重要数据，如相机曝光、图像拍摄的日期/时间、设备的品牌和型号、用于编辑的软件，甚至GPS定位。</p><p id="f715" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">利用这些信息，我们可以在一定程度上知道照片证据的合法性。</p><p id="220a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通常在salesforce中，“文件”用于存储图像或与记录关联的任何注释或附件。这些“文件”存储在一系列称为内容对象的对象中，如ContentDocument、ContentVersion等。嗯，这是改天讨论的话题。ContentVersion对象是存储实际数据的对象。数据存储在ContentVersion对象的名为VersionData的字段中。salesforce将数据编码为base64格式，然后存储。</p><p id="b9fc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一些库可以用来提取这些信息。我用过Exif-js和Exif-HEIC.js，它们是基于第一个库Exif-js的。我用了两个库，因为Exif-js库不支持HEIC格式的图像，这是现在最新的智能手机使用的格式。这些库被加载到VF页面中，因为LWC目前还不完全支持它们。</p><p id="e2ea" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> VF页面:</strong></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="a587" class="lf lg jb lb b gy lh li l lj lk">&lt;apex:page controller="ContentVersionUtil" standardStylesheets="false" showHeader="false"&gt;</span><span id="d3d4" class="lf lg jb lb b gy ll li l lj lk">&lt;apex:includeScript value="{!$Resource.exifExtractor}" /&gt;&lt;apex:includeScript value="{!$Resource.heicExifExtractor}" /&gt;&lt;script&gt;</span><span id="866e" class="lf lg jb lb b gy ll li l lj lk"> /*Get version data using rest query/<br/>function readContentDetails(conId) {<br/>         return new Promise(<br/>             function (resolve, reject) {<br/>                var xhr = new XMLHttpRequest();<br/>                xhr.responseType = "blob";<br/>                xhr.open('GET', '{!$Site.BaseUrl}' + '/services/data/v50.0/sobjects/ContentVersion/' + conId + '/VersionData');<br/>                xhr.setRequestHeader('Authorization', 'Bearer {!$Api.Session_ID}');<br/>                xhr.send();<br/>                xhr.onreadystatechange = function () {<br/>                    if (xhr.readyState == XMLHttpRequest.DONE) {<br/>                        if (xhr.status == 0) {<br/>                            reject('error');<br/>                            }<br/>                        else {<br/>                              resolve(xhr.response);<br/>                            }<br/>                     }<br/>                  }<br/>              }<br/>           );<br/>}</span><span id="2625" class="lf lg jb lb b gy ll li l lj lk">readContentDetails("{!$CurrentPage.parameters.conId}")<br/>   .then(function (blob) {<br/>            let obj = {};<br/>            const file = new File([blob], "{!cont.Title}", { type: 'image/jpg' });<br/>//If the image is not of type heic then use exif-js to extract data<br/>             if ("{!cont.FileExtension}" != 'heic') {<br/>                  EXIF.getData(file, function () {<br/>                  obj = EXIF.getAllTags(this);   <br/>                  obj.conId = "{!$CurrentPage.parameters.conId}";<br/>/*Once the data is retrieved send the data to the parent lwc using post messages*/<br/>              let lexOrigin = window.location.ancestorOrigins[0];<br/>               parent.postMessage(obj, lexOrigin);<br/>               });<br/>             } else {<br/>             file.arrayBuffer(file).then(function (arrayBuffer) {<br/>             obj = findEXIFinHEIC(arrayBuffer);<br/>             obj.conId = "{!$CurrentPage.parameters.conId}";<br/>/*Once the data is retrieved send the data to the parent lwc using post messages*/             <br/>             let lexOrigin = window.location.ancestorOrigins[0];<br/>             parent.postMessage(obj, lexOrigin);<br/>             });<br/>         }<br/>   })<br/>&lt;/script&gt;<br/>&lt;/apex:page&gt;</span><span id="f536" class="lf lg jb lb b gy ll li l lj lk">&lt;/apex:page&gt;</span><span id="32ba" class="lf lg jb lb b gy ll li l lj lk">Note: I'm using rest query to get VersionData because if it is queried from apex, and if the image size is of greater than 6 MB, then it would hit the heap size limit</span></pre><p id="be23" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">控制器:</strong></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="bc2f" class="lf lg jb lb b gy lh li l lj lk">public without sharing class ContentVersionUtil {<br/>     transient ContentVersion cont;<br/>     public ContentVersion getCont(){<br/>           if(cont == null){<br/>             List&lt;ContentVersion&gt; conVersion = [SELECT Id, FileExtension,description,Title,FileType,CreatedDate from ContentVersion WHERE  Id =:ApexPages.currentPage().getParameters().get('conId') ORDER BY CreatedDate DESC limit 1];<br/>           cont = conVersion[0];}<br/>           return cont;<br/>    }<br/>}</span></pre><p id="7b61" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> LWC </strong>:该组件接受内容版本id作为输入。</p><p id="7620" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> HTML </strong></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="6812" class="lf lg jb lb b gy lh li l lj lk">&lt;template&gt;<br/>&lt;template if:true={vfSrc}&gt;<br/> &lt;!-- Embed an iframe and invoke the visual force page from here --&gt;<br/>&lt;iframe src={vfSrc} style="height: 0px;width:0px"&gt;&lt;/iframe&gt;<br/>&lt;/template&gt;<br/>  &lt;lightning-spinner size="medium" alternative-text="Fetching Exif data" if:true={isFetchingExifData}&gt;&lt;/lightning-spinner&gt;<br/>  &lt;img src={src} if:true={src} style="width:20rem;height:40rem"/&gt;<br/>  &lt;h1 if:false={isFetchingExifData}&gt;EXIF DATA&lt;/h1&gt;</span><span id="e0a6" class="lf lg jb lb b gy ll li l lj lk">&lt;template for:each={exifList} for:item='exif'&gt;<br/>  &lt;p key={exif.Id}&gt;{exif}&lt;/p&gt;<br/>&lt;/template&gt;<br/>&lt;/template&gt;</span></pre><p id="7687" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> JS </strong></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="a239" class="lf lg jb lb b gy lh li l lj lk">import { LightningElement,track,api } from 'lwc';<br/>export default class ExifExtract extends LightningElement {<br/>@track<br/>isFetchingExifData = true;<br/>@track<br/>vfSrc;<br/>@track<br/>src;<br/>_conId;<br/>@track<br/>exifList = [];<br/>connectedCallback(){<br/>//Attach an event listener to listen to the post messages from the embedded iframe</span><span id="26f4" class="lf lg jb lb b gy ll li l lj lk">  window.addEventListener("message", (event) =&gt; {<br/>   if (!event.origin.includes('visualforce.com')) {<br/>       // Not the expected origin: Reject the message!<br/>    return;<br/>}<br/>this.exifObject = event.data;<br/>let list = [];<br/>for(const key in  this.exifObject){<br/>  if(typeof this.exifObject[key] != 'object' &amp;&amp; key !== 'undefined'){<br/>  let data =  key+' '+this.exifObject[key];<br/>  list.push(data);<br/>}<br/>}<br/>this.exifList = list;<br/>this.isFetchingExifData = false;</span><span id="ed93" class="lf lg jb lb b gy ll li l lj lk">// Handle the message<br/>console.log(event.data);</span><span id="71b0" class="lf lg jb lb b gy ll li l lj lk">}, false);<br/>}</span><span id="2198" class="lf lg jb lb b gy ll li l lj lk">//Content version Id input<br/>@api<br/>set conId(value){<br/>  if(value){<br/>     this._conId = value;<br/>     this.vfSrc = null;<br/>     this.vfSrc = '/apex/ExifPage?conId='+this._conId;<br/>     this.src= '/sfc/servlet.shepherd/version/download/'+this._conId;<br/>   }<br/>}</span><span id="41e4" class="lf lg jb lb b gy ll li l lj lk">get conId(){<br/>  return this._conId;<br/>}</span><span id="61a6" class="lf lg jb lb b gy ll li l lj lk">}</span></pre><p id="955d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:并非所有图像都必须包含EXIF数据，因为出于各种原因，如减少内存，或者如果图像被压缩，它可能会丢失，等等。</p><p id="1274" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终结果:</p><figure class="kw kx ky kz gt is gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/2f8721263934ae0d70de1c8d9afea8df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*LaxP8UYp7iz3RDpOxEeJvw.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">Voila!!</figcaption></figure><p id="ea93" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">资源:</strong></p><div class="ip iq gp gr ir lr"><a href="https://github.com/exif-js/exif-js" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jc gy z fp lw fr fs lx fu fw ja bi translated">exif-js</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">用于读取EXIF图像元数据的JavaScript库</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">github.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf ix lr"/></div></div></a></div><div class="ip iq gp gr ir lr"><a href="https://github.com/exif-heic-js/exif-heic-js" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jc gy z fp lw fr fs lx fu fw ja bi translated">exif-heic-js/exif-heic-js</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">用于从HEIC文件中读取EXIF图像元数据的JavaScript库</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">github.com</p></div></div><div class="ma l"><div class="mg l mc md me ma mf ix lr"/></div></div></a></div><div class="ip iq gp gr ir lr"><a href="https://photographylife.com/what-is-exif-data" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jc gy z fp lw fr fs lx fu fw ja bi translated">什么是EXIF数据，如何将它从照片中移除</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">在互联网上查看图片时，您可能已经注意到一些网站提供了与…相关的有价值的信息</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">photographylife.com</p></div></div><div class="ma l"><div class="mh l mc md me ma mf ix lr"/></div></div></a></div><p id="ace6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae mi" href="https://developer.salesforce.com/docs/atlas.en-us.api.meta/api/sforce_api_objects_contentversion.htm" rel="noopener ugc nofollow" target="_blank">https://developer . sales force . com/docs/atlas . en-us . API . meta/API/sforce _ API _ objects _ content version . htm</a></p></div></div>    
</body>
</html>