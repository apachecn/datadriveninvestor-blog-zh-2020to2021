<html>
<head>
<title>Malaria Parasite Species Classification using Fast.ai</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Fast.ai进行疟原虫种类分类</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/malaria-parasite-species-classification-using-fast-ai-4255b7ac1bff?source=collection_archive---------22-----------------------#2021-01-10">https://medium.datadriveninvestor.com/malaria-parasite-species-classification-using-fast-ai-4255b7ac1bff?source=collection_archive---------22-----------------------#2021-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a636" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将疟原虫图像分类为不同种类</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0c360626ba4605d7125df98e1e52aaa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EzXwyxhH2ehwuZG3"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@hikendal?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kendal</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="41c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是本系列的第2部分:“<strong class="ky ir">学习数据来源和准备模型部署的过程</strong>”。在系列的这一部分，我们将建立我们的深度学习模型。</p><p id="ca85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我们的数据托管在Kaggle上，我们可以很容易地使用它的笔记本来编写我们的代码。数据在这里找到:<a class="ae kv" href="https://www.kaggle.com/emmamichael101/malaria-species" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/emmamichael101/malaria-species</a></p><p id="1680" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从上面的链接创建一个新的笔记本，然后编码。</p><p id="8fcc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据我们的任务创建深度学习模型的过程将分为9个阶段:</p><ol class=""><li id="03e6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">导入必要的包</li><li id="8aec" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">声明数据集的路径</li><li id="b0d2" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">定义数据块</li><li id="c11f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将数据块对象转换为数据加载器</li><li id="1db1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">检查dataloader对象中的图像</li><li id="5940" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">火车模型</li><li id="a168" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将预测可视化，并与实际标签进行比较</li><li id="e062" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">检查最高损失</li><li id="acef" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">导出训练模型</li></ol><h1 id="07ca" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">导入必要的包</h1><p id="129e" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">Fastai已经安装在Kaggle内核上，所以您可以继续导入fastai:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="b1b4" class="ni mh iq ne b gy nj nk l nl nm">#fastai convention to import everything inside the vision #application for image classification</span><span id="4e98" class="ni mh iq ne b gy nn nk l nl nm">from fastai.vision.all import *</span></pre><h1 id="8675" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">声明数据集的路径</h1><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="f711" class="ni mh iq ne b gy nj nk l nl nm"><em class="no">#path to data to train and evaluate our deep learning model</em><br/>DATASET_PATH = Path('/kaggle/input/malaria-species/malaria_species_identification')</span></pre><h1 id="8e7a" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">定义数据块</h1><p id="5536" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们必须定义数据块来创建数据加载器。</p><p id="1a6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的数据块中，我们将指定:</p><ul class=""><li id="c72b" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr np ly lz ma bi translated"><strong class="ky ir">块</strong> —这指定了独立变量(一组图像)和目标变量(每个图像的类别[在我们的例子中:疟原虫的种类])</li><li id="7f2e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr np ly lz ma bi translated"><strong class="ky ir"> get_items </strong> —检索底层项目(在我们的例子中是图像)。get_image_files函数获取一个路径并返回该路径中所有图像的列表(默认情况下是递归的)。</li><li id="0f3f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr np ly lz ma bi translated"><strong class="ky ir">拆分器</strong> —从祖父文件夹名称(<code class="fe nq nr ns ne b">train_name</code>和<code class="fe nq nr ns ne b">valid_name</code>)中拆分<code class="fe nq nr ns ne b">items</code>。因此，我们的模型将使用train文件夹中的图像进行训练，并使用test文件夹中的图像进行测试。</li><li id="092f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr np ly lz ma bi translated"><strong class="ky ir"> get_y — </strong>目标变量被称为y。为了创建标签，我们使用了<code class="fe nq nr ns ne b"><strong class="ky ir">parent_label</strong></code>函数，该函数获取文件所在文件夹的名称作为其标签。</li><li id="71d8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr np ly lz ma bi translated"><strong class="ky ir"> item_tfms </strong> —这会将我们的图像调整到相同的大小。我们通过选择一个随机缩放的图像并在批处理之前将其调整到224来应用转换。</li></ul><p id="f453" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用RandomResizedCrop来训练神经网络，其中对象的位置和大小略有不同，以帮助它理解对象的基本概念，以及如何在图像中表示它。“min_scale”决定每次至少选择多少图像。</p><ul class=""><li id="01f8" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr np ly lz ma bi translated"><strong class="ky ir"> batch_tfms </strong> —一个或多个转换一旦形成就应用于批处理。这是应用数据增强。</li></ul><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="55ea" class="ni mh iq ne b gy nj nk l nl nm">species_datablock = DataBlock(<br/>    blocks=(ImageBlock, CategoryBlock), <br/>    get_items=get_image_files, <br/>    splitter=GrandparentSplitter(train_name=('train'),           valid_name='test'),<br/>    get_y=parent_label,<br/>    item_tfms=RandomResizedCrop(224, min_scale=0.3),<br/>    batch_tfms=aug_transforms(mult=2)<br/>)</span></pre><p id="933a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个命令给了我们一个数据块对象。这就像是创建数据加载器的模板。</p><div class="nt nu gp gr nv nw"><a href="https://www.datadriveninvestor.com/2020/11/27/deep-learning-amid-increased-physician-administrative-workload/" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">医生管理工作量增加时的深度学习|数据驱动的投资者</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">行政工作量是我们这个时代大多数医生所经历的众多负担之一。医生，尤其是…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok kp nw"/></div></div></a></div><h1 id="b423" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">将数据块对象转换为数据加载器</h1><p id="72f5" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这告诉fastai我们数据的实际来源——在本例中，是可以找到图像的<br/>路径:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="ebc7" class="ni mh iq ne b gy nj nk l nl nm">#convert <a class="ae kv" href="https://docs.fast.ai/data.block.html#DataBlock" rel="noopener ugc nofollow" target="_blank">DataBlock</a> to a <a class="ae kv" href="https://docs.fast.ai/data.core.html#DataLoaders" rel="noopener ugc nofollow" target="_blank">DataLoaders</a> object<br/>dls = species_datablock.dataloaders(DATASET_PATH)</span></pre><p id="133f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">数据加载器包括验证和培训数据加载器。DataLoader是一个类，它一次向GPU批量提供几个项目。</p><h1 id="b4ff" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">检查dataloader对象中的图像</h1><p id="6e06" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">然后，我们可以使用<code class="fe nq nr ns ne b">show_batch</code>方法检查dataloader对象中的图像:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="142d" class="ni mh iq ne b gy nj nk l nl nm">dls.show_batch()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/c3400ca6f3f64704ef4e940ddc1ffdb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*tNFVG9LlB8FbDAMh3zPhWg.png"/></div></figure><h1 id="dc0c" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">火车模型</h1><p id="a70b" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">为了训练我们的模型，我们需要建立一个学习器(cnn_learner)。我们将resnet34定义为我们的架构，将“错误率”定义为我们的指标。“learn.fine_tune”将适合我们的模型。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="4961" class="ni mh iq ne b gy nj nk l nl nm">learn = cnn_learner(dls, resnet34, metrics=error_rate)</span><span id="0549" class="ni mh iq ne b gy nn nk l nl nm">learn.fine_tune(16)</span></pre><h1 id="0963" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">将预测可视化并与实际标签进行比较</h1><p id="fce8" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们将预测值与实际值进行比较</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="cfe4" class="ni mh iq ne b gy nj nk l nl nm">interp = ClassificationInterpretation.from_learner(learn)<br/>interp.plot_confusion_matrix()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/bec299439866b3c4d7c2de3caf2ed974.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*Mxs-ddRUps0qgdyQJ4rWHg.png"/></div></figure><h1 id="89ba" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">检查最高损失</h1><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="82a6" class="ni mh iq ne b gy nj nk l nl nm">interp.plot_top_losses(4, nrows=4)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi on"><img src="../Images/363fb0cf046793688f9f3bc914de2cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*wUaqGaa5jnO2HD4dttw_mw.png"/></div></figure><h1 id="b4be" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">导出训练模型</h1><p id="378c" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们需要保存我们训练好的模型，以便能够部署它。我们有模型架构和保存模型的训练参数。这个方法甚至保存了如何创建数据加载器的定义。这是<br/>重要的，因为否则你将不得不重新定义如何转换你的数据，以便在生产中使用你的模型。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="732c" class="ni mh iq ne b gy nj nk l nl nm">#fastai will save a file called export.pkl:<br/>learn.export()</span></pre><p id="a37f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从Kaggle下载这个文件。</p><p id="f007" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该模型仍有改进的空间。</p><p id="e64e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看我们最后的笔记本这里:<a class="ae kv" href="https://www.kaggle.com/emmamichael101/malaria-parasite-species-classification/output" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/Emma Michael 101/疟疾-寄生虫-物种-分类/输出</a></p><p id="23a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的下一步将是部署我们训练有素的深度学习模型。我们将在本系列的第3部分中讨论这个问题。</p><p id="4539" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">在推特上关注我:</strong> <a class="ae kv" href="https://twitter.com/emmakodes" rel="noopener ugc nofollow" target="_blank"> @emmakodes </a></p><p id="f503" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">领英:</strong><a class="ae kv" href="https://www.linkedin.com/in/emmanuelonwuegbusi/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/emmanuelonwuegbusi/</a></p><h1 id="0b1d" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">结论</h1><p id="5a7a" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">第3部分:<a class="ae kv" href="https://emmamichaelo.medium.com/deploy-a-fast-ai-trained-model-using-binder-ce717a2ca66c" rel="noopener">使用Binder部署一个Fast.ai训练模型</a></p><p id="8f32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第1部分:<a class="ae kv" href="https://emmamichaelo.medium.com/learn-the-process-of-data-sourcing-and-preparation-to-model-deployment-4936c3b1f7b8" rel="noopener">了解模型部署的数据来源和准备流程</a></p><p id="f848" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">参考文献</strong></p><p id="1af3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[1]杰瑞米·霍华德和西尔万·古格，Fastai和Pytorch的程序员深度学习(奥莱利媒体公司，2020年)</p><p id="349f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">进入专家视角— </strong> <a class="ae kv" href="https://datadriveninvestor.com/ddi-intel" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">订阅DDI英特尔</strong> </a></p></div></div>    
</body>
</html>