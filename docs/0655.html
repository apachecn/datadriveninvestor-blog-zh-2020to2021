<html>
<head>
<title>How to Monitor and Autoscale Cloud Native Applications in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes中监控和自动扩展云原生应用</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/how-to-monitor-and-autoscale-cloud-native-applications-in-kubernetes-a276ed971500?source=collection_archive---------9-----------------------#2020-02-10">https://medium.datadriveninvestor.com/how-to-monitor-and-autoscale-cloud-native-applications-in-kubernetes-a276ed971500?source=collection_archive---------9-----------------------#2020-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="de09" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">前言</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/6753ab122df1b607c0004217c18fb46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*3VKbe_Hkwb44IP5S.png"/></div></figure><p id="52d9" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然越来越多的开发人员不断接受和认可云原生应用的设计概念，但需要注意的是<a class="ae lr" href="https://www.alibabacloud.com/product/kubernetes?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>已经成为整个云原生实施堆栈的中心。云服务功能通过云提供商、CRD控制器和运营商从标准的Kubernetes接口展现给服务层。开发者基于Kubernetes构建自己的云原生应用和平台。因此，Kubernetes现在是构建平台的平台。让我们了解一个云原生应用程序如何在Kubernetes中无缝集成监控和自动伸缩功能。</p><div class="ls lt gp gr lu lv"><a href="https://www.datadriveninvestor.com/2018/09/22/infographic-journey-to-the-clouds/" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">信息图:云之旅|数据驱动的投资者</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">聪明的企业领导者了解利用云的价值。随着数据存储需求的增长，他们已经…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj kr lv"/></div></div></a></div><p id="bb25" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本文是刘忠伟(莫元)在KubeCon的演讲<em class="mk">“Kubernetes中的云-原生应用监控和自动伸缩”</em>的各种摘录的汇编。刘是阿里云容器平台T5的技术专家。</p><h1 id="fea9" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">面向Kubernetes的阿里云容器服务:监控概述</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/5433029e686df2d28baf52f1ae489b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/0*RjS1nQNla_dy9stZ.png"/></div></figure><p id="dc45" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">面向Kubernetes的阿里云容器服务主要支持以下两种类型的集成。</p><h1 id="157d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">云服务集成</h1><p id="dd19" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">面向Kubernetes的阿里云容器服务集成了四种云监控服务，包括<a class="ae lr" href="https://www.alibabacloud.com/product/log-service?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank">简单日志服务</a>(SLS)<a class="ae lr" href="https://www.alibabacloud.com/product/arms?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank">应用实时监控服务</a>(ARMS)<a class="ae lr" href="https://www.alibabacloud.com/products/ahas?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank">应用高可用服务</a>(AHAS)<a class="ae lr" href="https://www.alibabacloud.com/product/cloud-monitor?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank">云监控</a>。</p><p id="ee34" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SLS主要负责收集和分析日志。在Kubernetes的阿里云容器服务中，SLS收集三种不同类型的日志:</p><ul class=""><li id="686b" class="mr ms iq kv b kw kx la lb le mt li mu lm mv lq mw mx my mz bi translated">核心组件的日志，例如APIServer</li><li id="5a3b" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">接入层日志，如服务网格/入口</li><li id="3626" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">应用程序的标准日志</li></ul><p id="0e0e" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">除了收集日志的标准链接，SLS还提供上层日志分析功能。默认情况下，它提供基于APIServer的审计分析功能、访问层的可观察性显示和应用层的日志分析。在面向Kubernetes的阿里云容器服务中，日志组件是默认安装的，开发者只需要在创建集群时检查即可。</p><p id="28dc" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">ARMS主要负责收集、分析和显示应用程序的性能指标。目前主要支持Java和PHP的集成，在JVM层收集指标，比如GC次数、应用的慢速SQL、调用栈等。它在性能调优中起着非常重要的作用。</p><p id="e3db" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">AHAS是一个架构感知的监控服务。一般来说，Kubernetes集群中的大部分负载类型都是微服务，微服务的调用拓扑也比较复杂。因此，当集群的网络链路出现问题时，最大的挑战是如何快速定位、发现和诊断问题。AHAS通过网络的流量和趋势显示集群拓扑，提供更高级别的问题诊断。</p><h1 id="f862" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">开源解决方案集成</h1><p id="f539" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">开源解决方案的兼容性和集成也是阿里云容器服务对Kubernetes的监控能力的一部分。主要包括以下两部分。</p><h2 id="0a56" class="nf jo iq bd jp ng nh dn jt ni nj dp jx le nk nl kb li nm nn kf lm no np kj nq bi translated">Kubernetes内置监控组件的增强和集成</h2><p id="e330" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">在Kubernetes社区中，<code class="fe nr ns nt nu b">heapster/metrics-server</code>是一个内置的监控解决方案，核心组件，如Dashboard和HPA，依赖于这些内置监控功能提供的指标。由于无法保证Kubernetes生态系统中组件的发布周期与Kubernetes的发布完全同步，一些具有监控能力的消费者在Kubernetes中出现了监控问题。因此，阿里云在metrics-server上进行了增强，以实现版本兼容。此外，对于节点诊断，阿里云容器服务增强了NPD覆盖，支持FD文件句柄监控、NTP时间同步验证和入站/出站网络能力验证。此外，它使eventer开源，以支持将Kubernetes事件数据离线传输到SLS、Kafka和DingTalk，从而实现ChatOps。</p><h2 id="b55d" class="nf jo iq bd jp ng nh dn jt ni nj dp jx le nk nl kb li nm nn kf lm no np kj nq bi translated">普罗米修斯生态系统的增强和整合</h2><p id="1209" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">为了支持Kubernetes生态系统中的标准第三方监测平台Prometheus，阿里云容器服务提供了集成图表，供开发者一键集成。此外，还有以下三个级别的增强功能:</p><ul class=""><li id="cb24" class="mr ms iq kv b kw kx la lb le mt li mu lm mv lq mw mx my mz bi translated">增强的存储和性能:支持产品级存储能力(TSDB和InfluxDB)，提供更持久高效的监控存储和查询。</li><li id="1c0a" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">增强的收集指标:修复Prometheus设计中的缺陷导致的一些不准确的监控问题，为出口商提供单GPU卡、多GPU卡和共享分片。</li><li id="3142" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">上层增强可观测性:支持基于场景的CRD监测度量集成(云原生监测能力，如Argo、Spark、TensorFlow)实现多租金可观测性。</li></ul><h1 id="a9b3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">阿里云容器服务Kubernetes中的自动缩放概述</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/05566f1ddec0cd9aa0f48f9a750438fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qa6GA6LALYIHVxFz.png"/></div></div></figure><p id="b2c1" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">面向Kubernetes的阿里云容器服务主要包括以下两类自动伸缩组件。</p><h1 id="0879" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">调度层自动缩放组件</h1><p id="9fbb" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">对于调度层自动缩放组件，所有自动缩放操作都是与pod相关的，不管具体的资源情况如何。</p><ul class=""><li id="1a49" class="mr ms iq kv b kw kx la lb le mt li mu lm mv lq mw mx my mz bi translated">水平窗格自动缩放(HPA): HPA是一个用于水平缩放窗格的组件。除了社区支持的资源指标和自定义指标，面向Kubernetes的阿里云容器服务还提供了外部指标适配器，以支持云服务指标作为确定自动扩展的标准。目前支持多个产品不同维度的度量指标，比如Ingress的QPS和RT，arm应用的GC时间和慢速SQL时间。</li><li id="1378" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">* *垂直窗格自动缩放(VPA): VPA帮助垂直缩放窗格。它主要用于扩展和升级有状态服务。</li><li id="125a" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">cronHPA:它是一个针对周期性负载的预定伸缩组件。它通过资源画像预测常规的负载周期，并通过定期扩展节省资源成本。</li><li id="2f01" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">Resizer:它是集群核心组件的缩放控制器。它有助于根据CPU核心和集群节点的数量实现线性和梯度扩展。目前，CoreDNS等核心组件的扩展是其主要目标场景。</li></ul><h1 id="869d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">资源层自动缩放组件</h1><p id="d369" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">资源层自动缩放组件支持关于pod和特定资源之间关系的操作。</p><ul class=""><li id="10a9" class="mr ms iq kv b kw kx la lb le mt li mu lm mv lq mw mx my mz bi translated">Cluster-auto scaler:Cluster-auto scaler是目前比较成熟的节点伸缩组件。当pod资源不足时，它有助于扩展节点和调度无法调度到新弹出节点的pod。</li><li id="87d2" class="mr ms iq kv b kw na la nb le nc li nd lm ne lq mw mx my mz bi translated">Virtual-Kubelet-Autoscaler:是面向Kubernetes的阿里云容器服务的开源组件。类似于Cluster-Autoscaler的原理，当一个pod由于资源问题无法调度时，它不会弹出一个节点，而是将pod绑定到一个虚拟节点，并通过ECI启动pod。</li></ul><h1 id="7ddb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">演示展示案例</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/3260549d01e3498e704e5cfd02f18856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*7y7kGSxpOFkBM-vV.png"/></div></figure><p id="c4fe" class="pw-post-body-paragraph kt ku iq kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上图显示了一个简单的演示，其中应用程序主题是APIservice。APIservice通过子APIservice调用数据库，接入层通过Ingress管理。使用PTS模拟上层产生的流量，通过SLS收集接入层的日志，通过ARMS收集应用性能指标。最后，通过alibaba-cloud-metrics-adapster暴露外部指标，触发HPA重新计算工作负载副本。当扩展的pod占用所有集群资源时，virtual-kubelet-autoscaler会触发生成ECI，以托管超出集群容量规划的负载。</p><h1 id="6324" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="9c7b" class="pw-post-body-paragraph kt ku iq kv b kw mm ky kz la mn lc ld le mo lg lh li mp lk ll lm mq lo lp lq ij bi translated">为Kubernetes 使用阿里云<a class="ae lr" href="https://www.alibabacloud.com/product/kubernetes?spm=a2c41.13977158.0.0" rel="noopener ugc nofollow" target="_blank">容器服务上的监控和自动缩放功能非常简单。开发者只需一键安装相应的组件图，即可获得完整的访问权限。凭借多维度监控和自动扩展功能，云原生应用以最低的成本获得了更高的稳定性和健壮性。</a></p><h1 id="5bad" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">原始来源:</h1><div class="ls lt gp gr lu lv"><a href="https://www.alibabacloud.com/blog/how-to-monitor-and-autoscale-cloud-native-applications-in-kubernetes_595788?spm=a2c41.13977158.0.0" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">如何在Kubernetes中监控和自动扩展云原生应用</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">阿里巴巴开发者2020年2月3日132同时越来越多的开发者不断接受和认可…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">www.alibabacloud.com</p></div></div><div class="me l"><div class="oa l mg mh mi me mj kr lv"/></div></div></a></div><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div></div>    
</body>
</html>