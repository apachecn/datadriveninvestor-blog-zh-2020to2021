<html>
<head>
<title>Building a distributed config server using Zookeeper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Zookeeper构建分布式配置服务器</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/building-a-distributed-config-server-using-zookeeper-6570363799e5?source=collection_archive---------2-----------------------#2020-12-30">https://medium.datadriveninvestor.com/building-a-distributed-config-server-using-zookeeper-6570363799e5?source=collection_archive---------2-----------------------#2020-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/e532203c968b38c45f42d4272b712122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*YdhwJI9umNJKFlojMpf0nA.jpeg"/></div></figure><p id="fbc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">什么是动物园管理员？</p><p id="7167" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Apache Zookeeper 是分布式数据存储(不是为大型数据存储而设计的)，主要用于协调目的。配置管理是一个广泛使用的目的。像Apache Hadoop、Apache Kafka、Apache Hive、Apache Nifi等分布式系统都在使用zookeeper。所有这些分布式系统都使用zookeeper作为所有节点之间的协调器，并存储所有共享的配置、状态和元数据。存储的数据应该很小，并且不应该超过1Mb。</p><p id="b3fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">动物园管理员的建筑:</strong></p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div class="gh gi kt"><img src="../Images/e74dc49e4cc8595a705da64c6531ba15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*VaqfQy-qLndwUqAqvNPOvg.png"/></div></figure><p id="952f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ZooKeeper有一个分层的名称空间，很像一个分布式文件系统(包含整个数据树的内存数据库)。命名空间中的每个节点都可以有与其关联的数据及其子节点。</p><p id="3819" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">Znode-</strong>Zookeeper树中的每个节点都被称为Znode，每个Znode都有一个关联的stat对象。Stat对象包含版本、时间戳等信息。每次如果客户端想要更新它，客户端应用程序需要发送版本号，如果版本与当前版本不匹配，那么更新将失败。</p><p id="d12f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">节点是程序员访问的主要实体。</p><p id="9255" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">访问控制列表(ACL) </strong> -每个节点都有一个访问控制列表(ACL)，限制谁可以做什么。</p><p id="57e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">守望者- 动物园管理员支持守望者。您可以使用任何读操作(如getData()、getChildren()和exists())注册一个<em class="ky">一次性</em>观察器。如果有任何变化，观察器将被触发。</p><p id="64c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">节点类型:</strong></p><p id="ca91" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">临时节点- </strong>只要创建Znode的会话处于活动状态，这些Znode就会存在。</p><p id="de0a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">序列节点- </strong>创建这类节点时，Zookeeper会在名称中添加一个唯一的序列号。</p><p id="943f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">分布式配置应用:</strong></p><p id="235a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们设计一个小的配置服务器应用程序。</p><p id="e743" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">配置服务器设计</strong></p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi kz"><img src="../Images/47ad82e276a003736d2e000a55293311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eF-ehwdEOeCZDg0yK8xWUQ.png"/></div></div></figure><p id="3aa8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤1- </strong>在这里下载<a class="ae ks" href="https://zookeeper.apache.org/releases.html" rel="noopener ugc nofollow" target="_blank">的Zookeeper。</a></p><p id="7da7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤2 - </strong>从本地终端启动zookeeper。我正在使用独立模式。群集中只有一个节点。默认端口将是2181。</p><p id="5bcc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在build.gradle中添加spring-cloud-starter-zookeeper-all，它将下载所有需要的依赖项。</p><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="9475" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤4</strong>——编写一个zookeeper服务类，它包含了获取Zookeeper连接、创建新的Znode、更新Znode数据和读取Znode数据的方法。</p><p id="8a28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在容器启动期间，该服务为不同的环境创建一个父节点。/config_server是一个根配置，然后它有像/dev、/qa、/prod这样的子节点。</p><p id="9802" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此服务正在注册一次性观察者。一旦Znode数据有任何更新，Watcher将被解雇。</p><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="74ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤5 - </strong>编写一个控制器类，外部服务将使用这些API来获取最新的配置信息。</p><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="e42f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Zookeeper连接和有效负载类</p><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="1097" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">启动这个应用程序后，你可以看到一个Zookeeper客户端连接已经注册了自定义观察。</p><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="2886" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">测试App: </strong></p><p id="514f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建第一个Znode。它的名称是“FirstClient”，环境是“DEV”。</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi lg"><img src="../Images/3f708b60dc14b74242634cffe9e446da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSRp28O6nXrBLr9hiqtT1A.png"/></div></div></figure><p id="edd4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取特定的Znode数据</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi lh"><img src="../Images/71fa6de62be1c8756291ca6fe5f068d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6t0zLFfE6SmoFJDJwLqYMw.png"/></div></div></figure><p id="ea6b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新特定的Znode数据。一旦检测到Znode数据发生变化，Watcher就会被触发。如果您想广播或通知客户有关更改，Watcher非常有用。</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ca"><img src="../Images/0d69d6675dee8051c1064b8496db3c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sWS7FvEc6eLCepSrF_p7fw.png"/></div></div></figure><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi li"><img src="../Images/e4923a18322190df9ddedb857b9a303a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8zWPVVc8Kz0uEnkTNRjz-g.png"/></div></div></figure><figure class="ku kv kw kx gt jr"><div class="bz fp l di"><div class="le lf l"/></div></figure><p id="c2ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">春云动物园管理员- </strong></p><p id="7353" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Spring cloud zookeeper提供了与zookeeper的集成。它还提供自动配置和注释来实现服务发现和应用程序配置。</p><p id="90fc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">服务发现- </strong> Spring cloud zookeeper使用zookeeper作为服务注册表，存储所有服务相关信息，并提供api用于服务发现。所有服务将在启动时注册。调用者应用程序可以使用发现客户端进行逻辑服务发现。</p><blockquote class="lj lk ll"><p id="c054" class="ju jv ky jw b jx jy jz ka kb kc kd ke lm kg kh ki ln kk kl km lo ko kp kq kr ij bi translated">build . grad le dependency-org . spring framework . cloud:spring-cloud-starter-zookeeper-discovery</p></blockquote><p id="7d60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用程序配置-  Spring cloud zookeeper也可以用作配置存储。它可以根据配置文件/环境存储应用程序配置。它只是spring config server的一个替代品。观察器不是spring cloud zookeeper配置的一部分。</p><blockquote class="lj lk ll"><p id="ac10" class="ju jv ky jw b jx jy jz ka kb kc kd ke lm kg kh ki ln kk kl km lo ko kp kq kr ij bi translated">build . grad le dependency-org . spring framework . cloud:spring-cloud-starter-zookeeper-config</p></blockquote><p id="a034" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">结论:</strong></p><p id="1783" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当不同应用程序之间需要协调时，使用Zookeeper作为配置服务器。假设一个大型分布式系统运行在不同的集群中，需要共享/公共元数据进行处理。元数据信息可以存储在中央Zookeeper服务器中，并可以通过api公开。所有应用程序将实时从api获取元信息。</p><p id="d253" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们实现了一个定制的解决方案，而不是使用spring zookeeper配置，因为它可以针对任何类型的配置/元数据进行定制。</p><p id="e5ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">感谢阅读。如果觉得有用，请鼓掌关注我更多有趣的文章。:)</p></div></div>    
</body>
</html>