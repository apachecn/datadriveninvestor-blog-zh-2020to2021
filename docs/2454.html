<html>
<head>
<title>Dockerizing and Hosting your Flask Web App(Rest API) on AWS EC2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS EC2上对接和托管您的Flask Web应用程序(Rest API)</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/dockerizing-and-hosting-your-flask-web-app-rest-api-on-aws-ec2-9f9c189bf563?source=collection_archive---------1-----------------------#2020-05-01">https://medium.datadriveninvestor.com/dockerizing-and-hosting-your-flask-web-app-rest-api-on-aws-ec2-9f9c189bf563?source=collection_archive---------1-----------------------#2020-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ad89625491b0f3f13b679d0462ab3764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WtnrAQ-DK8I-T4Km.jpeg"/></div></div></figure><figure class="jz ka kb kc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jy"><img src="../Images/e7fb35543e8122773adad2386520eb2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*C9W3_efGGWlAEbOF.png"/></div></div></figure><h1 id="8a35" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">议程:</h1><ol class=""><li id="d56d" class="lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ld ir">训练和测试DL模型。</strong></li><li id="a5e1" class="lb lc iq ld b le lt lg lu li lv lk lw lm lx lo lp lq lr ls bi translated"><strong class="ld ir">创建一个烧瓶应用</strong></li><li id="302f" class="lb lc iq ld b le lt lg lu li lv lk lw lm lx lo lp lq lr ls bi translated"><strong class="ld ir">停靠</strong></li><li id="87d7" class="lb lc iq ld b le lt lg lu li lv lk lw lm lx lo lp lq lr ls bi translated"><strong class="ld ir">AWS上的主机</strong></li></ol><h1 id="c5e6" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">要训练和测试DL模型:</h1><p id="95d7" class="pw-post-body-paragraph ly lz iq ld b le lf ma mb lg lh mc md li me mf mg lk mh mi mj lm mk ml mm lo ij bi translated">1.获取数据集。上传到硬盘。</p><p id="90ed" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">2.在collab上训练模型。检查精确度。检查不同笔记本的变量，例如val_acc和val_accuracy。</p><p id="2807" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">3.用测试目录中的图片测试模型，看看它是否给出了令人满意的结果。</p><p id="e91d" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">这里是我在github上的<a class="ae ms" href="https://github.com/Soumi7/TFNotebooks/blob/master/TransferLYoga.ipynb" rel="noopener ugc nofollow" target="_blank"> collab笔记本的链接。</a></p><p id="fb11" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">从Google Drive下载保存的模型<strong class="ld ir"> best1.h5 </strong>。</p><p id="e547" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">将它保存在您想要测试推理逻辑的同一文件夹中。下面是我的<strong class="ld ir"> tf_inference.py </strong>推理逻辑代码:</p><figure class="jz ka kb kc gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="1b6c" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">一旦成功运行，<strong class="ld ir">使用相同的逻辑创建一个Flask app </strong>。创建一个名为<strong class="ld ir"> app_y.py </strong>的文件，在<strong class="ld ir"> localhost:80 </strong>上运行app。</p><figure class="jz ka kb kc gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="3c94" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">我的github上有完整的代码。:)</p><p id="429c" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">添加一个helloworld路径来检查它的运行。添加分类器路径以运行模型。它将一个图像作为输入，并将类名作为输出返回，这里是yoga pose。</p><p id="dcc6" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">使用此命令在端口80上运行应用程序。</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="888a" class="na ke iq mw b gy nb nc l nd ne">sudo python3 app_y.py</span></pre><p id="3d28" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">使用CURL请求检查应用程序是否正在运行。</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="d24d" class="na ke iq mw b gy nb nc l nd ne">curl -X POST <a class="ae ms" href="https://localhost:80/classifier/run" rel="noopener ugc nofollow" target="_blank">https://localhost:80/classifier/run</a> -F “data=<a class="ae ms" href="http://twitter.com/tri2" rel="noopener ugc nofollow" target="_blank">@tri2</a>.jpg”</span></pre><p id="7b18" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">传递几个文件并检查。</p><p id="fda2" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">在主文件夹中创建一个docker文件。</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="312b" class="na ke iq mw b gy nb nc l nd ne">FROM python:3.6-slim<br/>COPY ./app_y.py /deploy/<br/>COPY ./requirements.txt /deploy/<br/>COPY ./best1.h5 /deploy/<br/>WORKDIR /deploy/<br/>RUN pip3 install --no-cache-dir -r requirements.txt<br/>EXPOSE 80<br/>ENTRYPOINT ["python", "app_y.py"]</span></pre><p id="c885" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">创建一个requirements.txt文件，添加包括系统版本在内的需求。像在collab笔记本内部一样检查它们:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="14e7" class="na ke iq mw b gy nb nc l nd ne">python3<br/>&gt;&gt;&gt;import tensorflow as tf<br/>&gt;&gt;&gt;print(tf.__version__)</span></pre><p id="1e28" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">下面是我的<strong class="ld ir"> requirements.txt </strong>代码:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="8ec7" class="na ke iq mw b gy nb nc l nd ne">jsonpickle<br/>tensorflow==2.2.0-rc3<br/>numpy<br/>flask<br/>Pillow</span></pre><h1 id="f3ee" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">要获得docker图像</h1><figure class="jz ka kb kc gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/9f20ddc6ce5e5dfa3af5d81d233b70cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/0*TVA83UhzTTjV3cAT.jpeg"/></div></figure><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="9388" class="na ke iq mw b gy nb nc l nd ne">sudo docker build -t app_y-yoga .</span></pre><p id="19a3" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">现在，映像已经构建好，可以运行了。我们可以使用以下命令来实现这一点:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="d071" class="na ke iq mw b gy nb nc l nd ne">sudo docker run -p 80:80 app_y-yoga .</span></pre><p id="a6e6" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">检查它是否运行并给出正确的输出:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="675c" class="na ke iq mw b gy nb nc l nd ne">curl -X POST <a class="ae ms" href="https://localhost:80/classifier/run" rel="noopener ugc nofollow" target="_blank">http://localhost:80/classifier/run</a> -F “data=<a class="ae ms" href="http://twitter.com/tri2" rel="noopener ugc nofollow" target="_blank">@tri2</a>.jpg”</span></pre><p id="3bab" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">现在，如果你构建了一个容器，但在运行时遇到了一些问题，比如成功托管但curl不工作，那么删除docker容器。万一被拒绝，试试这个。lsof命令给出了正在运行的进程的列表。</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="730e" class="na ke iq mw b gy nb nc l nd ne">sudo systemctl daemon-reload<br/>sudo systemctl restart docker<br/>sudo lsof -i -P -n | grep 80<br/>sudo kill &lt;PID of process running on port 80&gt;</span></pre><h1 id="90e5" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">在AWS上托管docker容器</h1><figure class="jz ka kb kc gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/b1ffa30d0fd3897264475d9f4bdaa684.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/0*fUrjzM_w08AMALMW.png"/></div></figure><p id="1c95" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">登录<strong class="ld ir"> AWS控制台</strong>，在搜索栏中搜索<strong class="ld ir"> EC2 </strong>，导航至<strong class="ld ir"> EC2仪表盘。</strong></p><p id="ad66" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">从选项中生成一个<strong class="ld ir">密钥对</strong>，并使用以下命令更改权限:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="2435" class="na ke iq mw b gy nb nc l nd ne">chmod 400 &lt;keyname&gt;.pem</span></pre><p id="d783" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">点击<strong class="ld ir"> EC2仪表盘</strong>上的<strong class="ld ir">启动实例</strong>:</p><p id="434d" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">从选项列表中选择<strong class="ld ir">亚马逊机器实例(AMI) </strong>。AMI确定虚拟机将运行的操作系统。</p><p id="6ae8" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">我们使用<strong class="ld ir"> t2.micro </strong>实例。</p><p id="60fd" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">导航到<strong class="ld ir">配置安全组</strong>选项卡，添加一个<strong class="ld ir">新规则</strong> http，它自动取80。</p><p id="610b" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">点击<strong class="ld ir">查看并启动</strong>。</p><p id="e1f8" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">启动图标将导致<strong class="ld ir">弹出</strong>，要求确认是否拥有密钥对。使用之前生成的密钥对的名称，并启动虚拟机。</p><p id="ec06" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">单击查看实例。点击您的实例，复制右边下面给出的<strong class="ld ir">公共dns </strong>名称。</p><p id="5a13" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">现在<strong class="ld ir"> ssh </strong>从<strong class="ld ir">本地系统</strong> <strong class="ld ir">终端</strong>进入<strong class="ld ir"> ec2机器</strong>，使用命令将字段<strong class="ld ir"> public-dns-name </strong>替换为您的<strong class="ld ir"> ec2实例名</strong>:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="8786" class="na ke iq mw b gy nb nc l nd ne">ssh -i SoumiBardhan.pem <a class="ae ms" href="mailto:ec2-user@ec2-198-51-100-1.compute-1.amazonaws.com" rel="noopener ugc nofollow" target="_blank">ec2-user@</a><strong class="mw ir">public-dns</strong>-name<br/>sudo amazon-linux-extras install docker<br/>sudo service docker start<br/>sudo usermod -a -G docker ec2-user</span></pre><p id="38da" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">如果你从一个文件夹中上传文件，也要声明私有密钥:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="4b5d" class="na ke iq mw b gy nb nc l nd ne">chmod 400 &lt;keyname&gt;.pem</span></pre><p id="c0d8" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">要将文件复制到ec2实例中，运行:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="12b4" class="na ke iq mw b gy nb nc l nd ne">scp -i SoumiBardhan.pem file-to-copy ec2-user@<strong class="mw ir">public-dns</strong>:/home/ec2-user1<br/>scp -i SoumiBardhan.pem app_y.py ec2-user@<strong class="mw ir">public-dns</strong>:/home/ec2-user1<br/>scp -i SoumiBardhan.pem requirements.txt ec2-user@<strong class="mw ir">public-dns</strong>:/home/ec2-user1<br/>scp -i SoumiBardhan.pem Dockerfile ec2-user@<strong class="mw ir">public-dns</strong>:/home/ec2-user1<br/>scp -i SoumiBardhan.pem best1.h5 ec2-user@<strong class="mw ir">public-dns</strong>:/home/ec2-user1</span></pre><p id="0bcb" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">现在，ssh进入Amazon VM，运行之前在系统上使用的相同docker命令:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="fa39" class="na ke iq mw b gy nb nc l nd ne">sudo docker build -t app_y-yoga .<br/>sudo docker run -p 80:80 app_y-yoga .</span></pre><p id="054c" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">现在检查curl请求:</p><pre class="jz ka kb kc gt mv mw mx my aw mz bi"><span id="d29f" class="na ke iq mw b gy nb nc l nd ne">curl -X POST <a class="ae ms" href="mailto:ec2-user@ec2-15-206-70-161.ap-socompute.amazonaws.com" rel="noopener ugc nofollow" target="_blank">ec2-user@</a><strong class="mw ir">public-dns</strong>/classifier/run -F "data=<a class="ae ms" href="http://twitter.com/tri2" rel="noopener ugc nofollow" target="_blank">@tri2</a>.jpg"</span></pre><p id="4e8d" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">所以API现在是活的。任何人都可以通过上面的curl请求访问它。</p><p id="f1bd" class="pw-post-body-paragraph ly lz iq ld b le mn ma mb lg mo mc md li mp mf mg lk mq mi mj lm mr ml mm lo ij bi translated">这里是github回购的<a class="ae ms" href="https://github.com/Soumi7/TransferL-Yoga-" rel="noopener ugc nofollow" target="_blank">链接。如果你觉得有用，请留下一颗星。谢谢！</a></p></div></div>    
</body>
</html>