<html>
<head>
<title>How TensorFlow on Flink Works: Flink Advanced Tutorials</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flink上的TensorFlow如何工作:Flink高级教程</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/how-tensorflow-on-flink-works-flink-advanced-tutorials-3bce16db047?source=collection_archive---------5-----------------------#2020-09-27">https://medium.datadriveninvestor.com/how-tensorflow-on-flink-works-flink-advanced-tutorials-3bce16db047?source=collection_archive---------5-----------------------#2020-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/280d9432f853bcb3e9d645bdbfd8203f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*akVAVaEV0TOflkHK.jpeg"/></div></figure><p id="acab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">由陈·(中卓)，阿里巴巴技术专家</em></p><p id="516d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae kt" href="https://www.alibabacloud.com/product/machine-learning" rel="noopener ugc nofollow" target="_blank">深度学习</a>在当代社会越来越重要。目前，深度学习被广泛应用于多个领域，如个性化推荐、产品搜索、人脸识别、机器翻译、自动驾驶等。它也正在迅速渗透到社会的各个方面。</p><h1 id="b909" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">背景</h1><p id="9616" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">随着深度学习应用的日益多样化，出现了许多优秀的计算框架。其中，TensorFlow、PyTorch和MXNeT被广泛使用，并引起了极大的关注。数据处理的计算框架通常用于将深度学习应用于实际场景。例如，在模型训练之前，必须处理训练数据以创建训练样本。在模型预测期间，必须监控数据处理指标。需要不同的计算引擎来实现数据处理和模型训练，这增加了用户面临的困难。</p><p id="93d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本文解释了如何使用单个引擎来实现整个机器学习过程。下图显示了一个典型的机器学习工作流，它由特征工程、模型训练和离线或在线模型预测组成。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lx"><img src="../Images/7f6ea0f0132152f62d7f25604b01751e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iYj92d0LTqL6hOyX.png"/></div></div></figure><p id="c83d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在机器学习过程的每个阶段都会生成日志。首先，我们需要使用一个数据处理引擎，比如<a class="ae kt" href="https://flink.apache.org/" rel="noopener ugc nofollow" target="_blank"> Flink </a>，在进行特征工程之前分析这些日志。然后，我们使用深度学习的计算引擎TensorFlow来完成模型训练和预测。经过模型训练后，我们使用TensorFlow Serving进行在线评分。</p><p id="b4f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个过程是可行的，但它会导致一些问题:</p><p id="d5aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">1)在单个机器学习项目中，我们必须使用Flink和TensorFlow两个计算引擎来实现特征工程、模型训练和模型预测。很难部署这两个引擎。<br/> 2) TensorFlow不便于在分布式环境中使用，因为它需要指定机器IP地址和端口号。然而，实际生产过程往往是在一个调度系统中实现的，例如YARN，它需要动态分配IP地址和端口号。<br/> 3) TensorFlow不支持分布式操作的自动故障转移。在Flink集群中运行TensorFlow来解决前面的问题。下图显示了在Flink上使用TensorFlow的系统示意图。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lx"><img src="../Images/4f5842257d20d32f1bf2c29f3337de49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LdLF40ezS9w8M1DP.png"/></div></div></figure><p id="afb7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">特征工程由Flink实施。模型训练和准实时模型预测由TensorFlow实现，tensor flow在Flink集群中运行。模型训练和预测由Flink单独实现，简化了部署，节省了资源。</p><h1 id="b519" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Flink计算简介</h1><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mg"><img src="../Images/1460285c031a98d0c1d7f6829609ecfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hV6ptEqy_dx6Wg9C.png"/></div></div></figure><p id="2a32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Flink是一个开源的大数据分布式计算引擎。Flink上的所有计算都被抽象成运算符，如上图所示。读取数据的节点称为源操作符，输出数据的节点称为汇操作符。各种Flink操作符实现了源操作符和接收操作符之间的进程。前面的计算拓扑包括三个源操作符和两个汇操作符。</p><h1 id="b5fb" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">机器学习的分布式拓扑</h1><p id="4f7c" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">下图显示了机器学习的分布式拓扑结构。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mh"><img src="../Images/20d965453146cf84c0fa4ad265ead7f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Zms9_orUY0E--E9-.png"/></div></div></figure><p id="f750" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">机器学习群集中的节点通常被分成不同的组，如上图所示。一组节点可能包含运行算法的工作器，或者包含更新参数设置的参数服务器(PSs)。</p><p id="ef72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们如何将Flink的算子结构与机器学习的节点和应用管理器结合起来？下一节详细解释Flink-AI-Extended的抽象。</p><div class="mi mj gp gr mk ml"><a href="https://www.datadriveninvestor.com/2020/08/27/what-is-a-data-catalog-and-how-does-it-enable-machine-learning-success/" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd ir gy z fp mq fr fs mr fu fw ip bi translated">什么是数据目录，它如何使机器学习取得成功？数据驱动的投资者</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">数据目录是机器学习和数据分析的燃料。没有它，你将不得不花费很多…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz js ml"/></div></div></a></div><h1 id="af03" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">flink-AI-扩展抽象</h1><p id="ddc2" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">机器学习集群被抽象到ML框架中，并且包括ML操作符。这两个模块结合了Flink和机器学习集群，为不同的计算引擎提供支持，如TensorFlow。下图显示了这一点。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi na"><img src="../Images/9db6e214eff88459ab5b64c5256c9ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TolzJD29QlwBBM5l.png"/></div></div></figure><p id="3ee0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Flink运行时环境被抽象为ML框架和ML操作符，它们将Flink连接到其他计算引擎。</p><h1 id="ebb2" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">ML框架</h1><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nb"><img src="../Images/a45adb8cb0e39348457f29f5c26ea2b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-tUWVTItFAHO_NaS.png"/></div></div></figure><p id="7107" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ML框架有两个角色:应用程序管理器和节点。</p><p id="2ea5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">1)应用程序管理器管理其所有节点的生命周期。<br/> 2)节点负责运行机器学习的算法程序。</p><p id="3633" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用程序管理器和节点被进一步抽象。应用程序管理器的状态机被扩展以支持不同类型的作业。</p><p id="843b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">深度学习引擎支持状态机定制。将一个节点抽象成一个runner接口，基于不同的深度学习引擎创建自定义算法程序。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nc"><img src="../Images/88d3b3306868a5892745db03a16f871d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*egM0URbSx5D5RiLJ.png"/></div></div></figure><h1 id="121f" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">ML运算符</h1><p id="3209" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">ML运算符提供了以下两个接口:</p><p id="3d5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">addAMRole接口用于将应用程序管理器添加到Flink作业中。如上图所示，应用程序管理器是机器学习集群的管理节点。<br/>2)addRole接口用于添加一组机器学习节点。</p><p id="3f7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用ML操作符的这两个接口来添加Flink操作符:一个应用程序管理器和三组节点，分别称为角色A、角色B和角色C。这三个节点组形成了一个机器学习集群。请参见上图中的代码。每个Flink操作符对应于机器学习作业的一个节点。</p><p id="bbe8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">机器学习节点运行在Flink操作符上，它们需要相互交换数据，如下图所示。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nb"><img src="../Images/9d5afee53ac6401226eca40a2e9a7e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6wGqv1RLigAaiW-n.png"/></div></div></figure><p id="0ce2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Flink操作符是Java进程，机器学习节点是Python进程。这两个进程通过共享内存相互交换数据。</p><h1 id="5bc7" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Flink上的张量流</h1><h2 id="d627" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">TensorFlow分布式执行</h2><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi np"><img src="../Images/826a518b7da2159fb02c190b27aaadbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ubLBr5AH_wXb155W.png"/></div></div></figure><p id="abe5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">TensorFlow分布式培训涉及两个角色:工人和PS。工人实现机器学习和PSs更新参数设置的计算。以下部分描述TensorFlow如何在Flink集群中运行。</p><h2 id="3883" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">TensorFlow批量训练模式</h2><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nq"><img src="../Images/a3aa53698b38e9d83a2f779c4ffd08cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*h7rm6bAj24fIllNt.png"/></div></div></figure><p id="83a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在批处理模式下，样本数据可以存储在Hadoop分布式文件系统(HDFS)中。Flink作业启动一个源操作符，然后启动TensorFlow的worker角色。如上图所示，如果worker角色有三个节点，则其源并行度设置为3。类似地，PS角色有两个节点，因此其源并行度设置为2。应用程序管理器不与其他角色交换数据，因此它是一个独立的节点，源并行度不变，为1。Flink作业启动三个worker节点和两个PS节点，它们通过TensorFlow gRPC而不是Flink的通信机制相互通信。</p><h2 id="16d8" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">张量流训练模式</h2><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nr"><img src="../Images/4bfeda1e95c10d0d77d3cf3121354672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qQhMCOs5_x_iU37i.png"/></div></div></figure><p id="2293" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如上图所示，两个源操作符连接到连接操作符。两条数据合并成一条，样本数据由自定义处理节点生成。在流模式中，工作者角色由UDTF或平面图实现。</p><p id="6205" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当存在三个TensorFlow工作节点时，平面图和UDTF的运算符并行度设置为3。PS角色不读取数据，因此PSs由Flink源操作符实现。</p><p id="bb72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下部分描述了如何使用训练好的模型实现实时预测。</p><h2 id="92e3" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">基于Python的预测</h2><p id="9e3b" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">下图显示了使用Python进行模型预测的过程。有些场景，比如推荐和搜索，可能会产生由TensorFlow以分布式模式训练的大型模型。这种类型的模型不能存储在一台机器上。实时预测的工作方式与实时训练相同，但包括额外的模型加载过程。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ns"><img src="../Images/1f779bdafda01d738894f3a3527bb377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TwPu2OksY_OWY-Lc.png"/></div></div></figure><p id="0bb1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在模型预测期间，所有参数都通过模型读取加载到PSs。上游数据的处理方式与模型训练过程中处理数据的方式相同。数据被传输到工作节点进行处理。预测分数被写入Flink操作符，然后发送给下游操作符。</p><h2 id="a522" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">基于Java的预测</h2><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nt"><img src="../Images/5790f8ad8d0a05ff287f70c7dc98df1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jY9IVIkBgjiLLdnB.png"/></div></div></figure><p id="0742" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如上图所示，当在单台计算机上进行预测时，PS节点不会启动，因为单个工作节点足以存储用于预测的模型，尤其是当TensorFlow导出已保存的模型时。保存的模型包括预测的完整计算逻辑、输入和输出，因此无需运行Python代码即可执行预测。</p><p id="0a4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还有另一种方法来实现模型预测。源运算符、联接运算符和UDTF用于以模型预测过程中可识别的格式处理数据。在Java进程中使用TensorFlow Java API将训练好的模型直接加载到内存中。在这种情况下，不需要PS角色，工作者角色由Java进程而不是Python进程承担。然后，模型预测可以直接在Java进程中实现，预测结果可以发送给下游的Flink操作符。</p><h1 id="6b0c" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">摘要</h1><p id="a1dd" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr ij bi translated">本文解释了Flink-AI-Extended的工作原理，以及如何在Flink上通过TensorFlow实现模型训练和预测。希望本文能帮助你有效使用Flink-AI-Extended，通过一个Flink作业实现模型训练和预测。</p><h1 id="8fed" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">原始来源:</h1><div class="mi mj gp gr mk ml"><a href="https://www.alibabacloud.com/blog/how-tensorflow-on-flink-works-flink-advanced-tutorials_596627" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd ir gy z fp mq fr fs mr fu fw ip bi translated">Flink上的TensorFlow如何工作:Flink高级教程</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">Apache Flink社区中国2020年9月16日69由陈(中卓)，阿里巴巴技术专家深度学习…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">www.alibabacloud.com</p></div></div><div class="mu l"><div class="nu l mw mx my mu mz js ml"/></div></div></a></div><h2 id="626e" class="nd kv iq bd kw ne nf dn la ng nh dp le kf ni nj li kj nk nl lm kn nm nn lq no bi translated">访问专家视图— <a class="ae kt" href="https://datadriveninvestor.com/ddi-intel" rel="noopener ugc nofollow" target="_blank">订阅DDI英特尔</a></h2></div></div>    
</body>
</html>