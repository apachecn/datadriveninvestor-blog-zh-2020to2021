<html>
<head>
<title>How to quickly embed python in your C++ Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在你的C++应用中快速嵌入python</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/how-to-quickly-embed-python-in-your-c-application-23c19694813?source=collection_archive---------0-----------------------#2020-08-19">https://medium.datadriveninvestor.com/how-to-quickly-embed-python-in-your-c-application-23c19694813?source=collection_archive---------0-----------------------#2020-08-19</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><figure class="gm go js jt ju jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj jr"><img src="../Images/6c16c7589a8ad469b6281c5c697ae507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4VsRrtV2UKGlhIo6.jpg"/></div></div></figure><p id="3994" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">将python嵌入到您的应用程序中允许您用Python而不是纯C或C++实现一些功能。这是有益的，原因有很多，比如允许用户通过运行定制脚本或简化您必须编写的代码来定制应用程序以满足他们的需求。对于那些懒得阅读整个API的人来说，本教程将是一个关于嵌入python的快速简单的速成课程。</p></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="beb8" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">编译器设置</strong></h1><p id="7771" class="pw-post-body-paragraph kc kd iu ke b kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz in bi translated">为了使用Python-C API，我们需要首先在代码中导入它。这可以通过在代码中添加# include“python . h”来实现。然而，要做到这一点，我们首先需要将python包含文件添加到我们的编译器搜索目录中。在Visual Studio 2019中，这是通过将包含目录从python安装添加到属性&gt; C/C++ &gt;常规&gt;附加包含目录来完成的。</p><figure class="ml mm mn mo gu jv gi gj paragraph-image"><div class="gi gj mk"><img src="../Images/c8e58b8aa20f6eaa288ae33fde55838f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*qrE0McZW3zXypLvosEa-UQ.png"/></div></figure><p id="6528" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">接下来，我们需要将python库添加到我们的链接器中。将python安装中的<em class="mp">库</em>目录添加到属性&gt;链接器&gt;常规&gt;附加库目录中。</p><figure class="ml mm mn mo gu jv gi gj paragraph-image"><div class="gi gj mk"><img src="../Images/e4db0646ae2f4b4ddefa608588e3d771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*-gtvGfY2K1TUKdHxkDJHfw.png"/></div></figure><p id="4c3d" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">最后，我们需要为链接器指定库名。在Visual Studio中，这是通过将python库的名称(取决于您的python版本，可在{python安装目录} \libs中找到)添加到属性&gt;链接器&gt;输入&gt;附加依赖项来完成的:</p><figure class="ml mm mn mo gu jv gi gj paragraph-image"><div class="gi gj mk"><img src="../Images/35f492116bef7a9ed3544e0df28c5b46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*UPMEmWbbIYkEJaoFZdToBA.png"/></div></figure><p id="caaf" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">做完这些，我们终于准备好开始编码了！</p></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="2494" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">初始化python实例</strong></h1><p id="5be0" class="pw-post-body-paragraph kc kd iu ke b kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz in bi translated">现在我们已经设置好了环境，我们需要初始化python解释器，然后才能在代码中使用它。这是通过添加以下内容实现的:</p><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="4b1a" class="mv li iu mr b gz mw mx l my mz">//Initialize the python instance</span><span id="ac08" class="mv li iu mr b gz na mx l my mz">Py_Initialize();</span></pre><p id="8254" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">这必须在代码中使用python之前完成。</p></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="4c2a" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">运行一个python字符串</strong></h1><h2 id="b0d4" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated">C++:</h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="b5fb" class="mv li iu mr b gz mw mx l my mz">//Run a simple string</span><span id="cf38" class="mv li iu mr b gz na mx l my mz">PyRun_SimpleString("from time import time,ctime\n"</span><span id="b14d" class="mv li iu mr b gz na mx l my mz">"print('Today is',ctime(time()))\n");</span></pre><h2 id="5935" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated">输出:</h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="2c9b" class="mv li iu mr b gz mw mx l my mz">Today is Wed Aug 19 11:09:38 2020</span></pre><p id="4c6f" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">PyRun _ SimpleString的功能从名字上看很直观。它允许你用python运行一段代码。如果要运行多行代码，请在字符串末尾使用换行符(" \n ")。</p><div class="nm nn gq gs no np"><a href="https://www.datadriveninvestor.com/2020/07/07/introduction-to-time-series-forecasting-of-stock-prices-with-python/" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fp"><div class="nr ab ns cl cj nt"><h2 class="bd iv gz z fq nu fs ft nv fv fx it bi translated">用Python |数据驱动投资者进行股票价格时间序列预测简介</h2><div class="nw l"><h3 class="bd b gz z fq nu fs ft nv fv fx dk translated">在这个简单的教程中，我们将看看如何将时间序列模型应用于股票价格。更具体地说，一个…</h3></div><div class="nx l"><p class="bd b dl z fq nu fs ft nv fv fx dk translated">www.datadriveninvestor.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ka np"/></div></div></a></div><h1 id="d84c" class="lh li iu bd lj lk oe lm ln lo of lq lr ls og lu lv lw oh ly lz ma oi mc md me bi translated">从文件运行函数</h1><h2 id="ad03" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated"><strong class="ak"> Python (script.py): </strong></h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="7c56" class="mv li iu mr b gz mw mx l my mz">def test(person):</span><span id="7ab9" class="mv li iu mr b gz na mx l my mz">    return "What's up " + person;</span></pre><h2 id="7479" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated"><strong class="ak"> C++: </strong></h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="314f" class="mv li iu mr b gz mw mx l my mz">//Run a python function</span><span id="bb3b" class="mv li iu mr b gz na mx l my mz">PyObject *pName, *pModule, *pFunc, *pArgs, *pValue;</span><span id="a84c" class="mv li iu mr b gz na mx l my mz">pName = PyUnicode_FromString((char*)"script");</span><span id="972c" class="mv li iu mr b gz na mx l my mz">pModule = PyImport_Import(pName);</span><span id="475f" class="mv li iu mr b gz na mx l my mz">pFunc = PyObject_GetAttrString(pModule, (char*)"test");</span><span id="85a2" class="mv li iu mr b gz na mx l my mz">pArgs = PyTuple_Pack(1, PyUnicode_FromString((char*)"Greg"));</span><span id="c6d3" class="mv li iu mr b gz na mx l my mz">pValue = PyObject_CallObject(pFunc, pArgs);</span><span id="c1be" class="mv li iu mr b gz na mx l my mz">auto result = _PyUnicode_AsString(pValue);</span><span id="e627" class="mv li iu mr b gz na mx l my mz">std::cout &lt;&lt; result &lt;&lt; std::endl;</span></pre><h2 id="2966" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated">输出:</h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="ed50" class="mv li iu mr b gz mw mx l my mz">What's up Greg</span></pre><p id="d028" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">从C++运行python函数基本上有三个步骤</p><ol class=""><li id="29ec" class="oj ok iu ke b kf kg kj kk kn ol kr om kv on kz oo op oq or bi translated">导入函数</li><li id="d648" class="oj ok iu ke b kf os kj ot kn ou kr ov kv ow kz oo op oq or bi translated">调用函数</li><li id="1e68" class="oj ok iu ke b kf os kj ot kn ou kr ov kv ow kz oo op oq or bi translated">获取函数的返回值</li></ol><p id="14d6" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">让我们一次分解一行代码。首先，我们创建变量访问并调用函数，注意所有类型都是PyObject指针。变量<em class="mp"> pName </em>对应于我们想要访问以获得函数的python文件的名称，注意这里没有。文件名的py扩展名。<em class="mp"> pModule </em>导入我们的python interpeter中指定为模块的文件。<em class="mp"> pFunc </em>对应于我们想要从python文件中调用的函数的名称。接下来，我们通过使用PyTuple_Pack在<em class="mp"> pArgs </em>中指定函数的参数。函数的第一个值对应于我们希望指定给函数的参数的数量，在本例中，我们的Python函数只有一个参数。PyTuple_Pack函数的以下参数是我们作为python对象请求的python函数的实际参数。您需要阅读API来弄清楚对于您想要在代码中使用的数据类型，对应的Python对象或函数是什么。在本例中，我们使用PyUnicode_FromString向python发送一个值为“Greg”的字符串参数。<em class="mp"> pValue </em>对应于函数执行完指定参数后的返回值。然而，<em class="mp"> pValue </em>的类型目前是一个pyObject。我们使用_PyUnicode_AsString将函数的返回值转换为const char*类型，您将再次需要在API参考中查找所需的Python函数/对象。</p></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="f783" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">运行一个完整的python文件</strong></h1><h2 id="78c9" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated"><strong class="ak"> Python (test.py): </strong></h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="7412" class="mv li iu mr b gz mw mx l my mz">print("Hello from file")</span></pre><h2 id="a5ca" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated"><strong class="ak"> C++: </strong></h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="9e24" class="mv li iu mr b gz mw mx l my mz">//Run a simple file</span><span id="2505" class="mv li iu mr b gz na mx l my mz">FILE* PScriptFile = fopen("test.py", "r");</span><span id="d03b" class="mv li iu mr b gz na mx l my mz">if(PScriptFile){</span><span id="5439" class="mv li iu mr b gz na mx l my mz">PyRun_SimpleFile(PScriptFile, "test.py");</span><span id="52fc" class="mv li iu mr b gz na mx l my mz">fclose(PScriptFile);</span><span id="7451" class="mv li iu mr b gz na mx l my mz">}</span></pre><h2 id="4aeb" class="mv li iu bd lj nb nc dn ln nd ne dp lr kn nf ng lv kr nh ni lz kv nj nk md nl bi translated"><strong class="ak">输出:</strong></h2><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="582b" class="mv li iu mr b gz mw mx l my mz">Hello from file</span></pre><p id="011d" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">运行整个python脚本的步骤很简单:</p><ol class=""><li id="c711" class="oj ok iu ke b kf kg kj kk kn ol kr om kv on kz oo op oq or bi translated">以只读方式加载python文件</li><li id="0505" class="oj ok iu ke b kf os kj ot kn ou kr ov kv ow kz oo op oq or bi translated">检查文件是否存在</li><li id="c384" class="oj ok iu ke b kf os kj ot kn ou kr ov kv ow kz oo op oq or bi translated">用PyRun _ SimpleFile运行文件</li><li id="792f" class="oj ok iu ke b kf os kj ot kn ou kr ov kv ow kz oo op oq or bi translated">关闭文件</li></ol></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="56b9" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">关闭python实例</h1><p id="d421" class="pw-post-body-paragraph kc kd iu ke b kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz in bi translated">既然我们已经完成了对python代码的访问，我们需要关闭我们之前创建的python实例。这是通过运行以下命令完成的:</p><pre class="ml mm mn mo gu mq mr ms mt aw mu bi"><span id="ab03" class="mv li iu mr b gz mw mx l my mz">//Close the python instance</span><span id="77ff" class="mv li iu mr b gz na mx l my mz">Py_Finalize();</span></pre></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="4599" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">完整的代码</h1><figure class="ml mm mn mo gu jv"><div class="bz fq l di"><div class="ox oy l"/></div></figure></div><div class="ab cl la lb hy lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="in io ip iq ir"><h1 id="3262" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="2948" class="pw-post-body-paragraph kc kd iu ke b kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv mj kx ky kz in bi translated">这就是在应用程序中嵌入python的基础！在后面的教程中，我将介绍如何在应用程序、对象和继承中进行python的“低级”嵌入，与Cython接口并使用Boost Python。如果你喜欢这个教程并想看更多，请鼓掌并在社交媒体上分享这篇文章！感谢您的阅读！</p><p id="9de0" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><em class="mp">谢谢您的阅读，请👏并分享出来帮助别人找到。在推特上关注我的新内容</em><a class="ae oz" href="https://twitter.com/gregcodesstuff" rel="noopener ugc nofollow" target="_blank"><em class="mp">@ gregcodesstuff</em></a></p><p id="d4d7" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">回头见。😃</p><p id="97f0" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><strong class="ke iv">访问专家视图— </strong> <a class="ae oz" href="https://datadriveninvestor.com/ddi-intel" rel="noopener ugc nofollow" target="_blank"> <strong class="ke iv">订阅DDI英特尔</strong> </a></p></div></div>    
</body>
</html>