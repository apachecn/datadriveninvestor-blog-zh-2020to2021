<html>
<head>
<title>Stop Loss, Trailing Stop, or Take Profit? 2 Million Backtests Shed Light</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">止损，跟踪止损，还是止盈？200万次回溯测试揭示了</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/stop-loss-trailing-stop-or-take-profit-2-million-backtests-shed-light-dde23bda40be?source=collection_archive---------0-----------------------#2020-12-19">https://medium.datadriveninvestor.com/stop-loss-trailing-stop-or-take-profit-2-million-backtests-shed-light-dde23bda40be?source=collection_archive---------0-----------------------#2020-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="1aa0" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">5分钟后进行大规模回测</h2><div class=""/><p id="e76b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在本文中，我们将使用<a class="ae ku" href="https://github.com/polakowo/vectorbt" rel="noopener ugc nofollow" target="_blank"> vectorbt </a>进行大规模回溯测试，以探索不同加密货币、时间段和停止值的最常见停止信号的性能。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi kv"><img src="../Images/4ebbe183a25b8aa802b34a9857836a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tq9vJO_G1UcEwqN4NAU89w.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Photo by <a class="ae ku" href="https://unsplash.com/@flyd?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">FLY:D</a> on <a class="ae ku" href="https://unsplash.com/@flyd?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><blockquote class="ll lm ln"><p id="1157" class="jw jx lo jy b jz ka kb kc kd ke kf kg lp ki kj kk lq km kn ko lr kq kr ks kt ij bi translated">与所有可能的策略相比，交易策略只是一粒沙子；只有大局才能揭示其质量。</p></blockquote><h1 id="5321" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">方法学</h1><p id="a8ae" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">我们的目标是利用大规模回溯测试来比较有和没有止损(SL)、跟踪止损(TS)和止盈(TP)信号的交易表现。为了使这种尝试具有代表性，我们将在三个不同的维度上运行大量的实验:仪器、时间和超参数:</p><ul class=""><li id="9799" class="mv mw iq jy b jz ka kd ke kh mx kl my kp mz kt na nb nc nd bi translated">首先，我们将按市值挑选10种加密货币(USDT等稳定货币除外)，并获取它们3年的每日定价数据。特别是，我们的目标是回测2018年至2021年的时间段，因为它包含价格大幅下跌(例如，2017年12月ATH和2020年3月冠状病毒的调整)和飙升(2020年12月ATH)的时期，这使事情保持平衡。</li><li id="fa06" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">对于每种工具，我们将这个时间段分成400个更小的(重叠的)时间窗口，每个窗口6个月长。我们将在每个窗口上运行我们的测试，以考虑不同的市场体制。</li><li id="cd13" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">对于每个工具和时间窗口，我们将在第一根棒线生成进场信号，并根据止损配置找到出场信号。我们将测试100个1%增量的止损值，并将每个止损值的表现与随机交易和在特定时间窗口内持有的表现进行比较。</li></ul><p id="979b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">总的来说，我们将进行2，000，000次回溯测试。</p><h1 id="da65" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">设置</h1><p id="dd9d" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">我们需要的只是Python ≥ 3.6的<a class="ae ku" href="https://jupyter.org/" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本/实验室</a>、<a class="ae ku" href="https://github.com/ranaroussi/yfinance" rel="noopener ugc nofollow" target="_blank"> yfinance </a>、<a class="ae ku" href="https://github.com/polakowo/vectorbt" rel="noopener ugc nofollow" target="_blank"> vectorbt </a>，以及他们需要的包。我们将使用yfinance下载定价数据，使用vectorbt在5分钟内运行200万次回溯测试，并对结果进行可视化分析。</p><blockquote class="ll lm ln"><p id="0840" class="jw jx lo jy b jz ka kb kc kd ke kf kg lp ki kj kk lq km kn ko lr kq kr ks kt ij bi translated">vectorbt是Python的下一代回溯测试库，它将各种回溯测试和数据科学技术应用于技术分析。它的工作方式是将交易数据——从时间序列到订单记录——表示为nd数组，并使用NumPy和<a class="ae ku" href="https://github.com/numba/numba" rel="noopener ugc nofollow" target="_blank"> Numba </a>处理它们。这反过来又支持一些用例，例如速度惊人的超参数优化，否则这主要是使用分布式和云计算来完成的。另一个优势是集成了<a class="ae ku" href="https://github.com/plotly/plotly.py" rel="noopener ugc nofollow" target="_blank"> Plotly </a>和<a class="ae ku" href="https://github.com/jupyter-widgets/ipywidgets" rel="noopener ugc nofollow" target="_blank"> ipywidgets </a>以在Jupyter笔记本中显示交互式图表和仪表盘。</p></blockquote><h1 id="068a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">定义参数</h1><p id="19ef" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">第一步是定义分析管道的参数。如上所述，我们将回溯测试3年的定价数据、400个时间窗口、10种加密货币和100个止损值。我们还会将费用和滑点都设置为0.25%，初始资本设置为100美元(金额本身并不重要，但所有资产必须相同才能进行比较)。随意更改任何感兴趣的参数。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="7810" class="nq lt iq nm b gy nr ns l nt nu">Start date                       2018-01-01 00:00:00<br/>End date                         2021-01-01 00:00:00<br/>Time period (days)                              1096<br/>Assets                                            10<br/>Window length                      180 days, 0:00:00<br/>Windows                                          400<br/>Exit types                                         5<br/>Stop values                                      100<br/>Tests per asset                               200000<br/>Tests per window                                5000<br/>Tests per exit type                           400000<br/>Tests per stop type and value                   4000<br/>Tests total                                  2000000<br/>dtype: object</span></pre><p id="09a1" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们的配置产生的样本量具有足够的统计能力来分析四个变量:资产(每个资产20万次测试)、时间(每个时间窗口5k次测试)、退出类型(每个退出类型40万次测试)和停止值(每个停止类型和值4k次测试)。类似于Tableau处理维度和度量的方式，我们将能够根据这些变量中的每一个对我们的性能进行分组，但是我们将主要关注5种退出类型:SL退出、ts退出、TP退出、随机退出和持有退出(放在最后一个柱上)。</p><h1 id="d1f6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">下载数据</h1><p id="c434" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">使用yfinance可以直接获得每种加密货币的每日定价数据:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="870d" class="nq lt iq nm b gy nr ns l nt nu">dict_keys(['BTC-USD', 'ETH-USD', 'XRP-USD', 'BCH-USD', 'LTC-USD', 'BNB-USD', 'EOS-USD', 'XLM-USD', 'XMR-USD', 'ADA-USD'])<br/>(1083, 5)</span></pre><p id="4568" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">字典<code class="fe nv nw nx nm b">ohlcv_by_symbol</code>现在包含加密货币名称的OHLCV数据。每个数据帧有1083行(天)和5列(O、H、L、C和V)。您可以按如下方式绘制数据帧:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/9ef0c8d28c5da7c1c44096c73582631a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*PkGmalNUp2zl9Se2HE6fLw.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">OHLCV of BTC-USD pair</figcaption></figure><p id="116f" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">由于资产是我们想要分析的维度之一，vectorbt希望我们将它们作为列打包到单个数据帧中，并相应地标记它们。要做到这一点，我们只需交换资产和特性，就可以得到一个由特性名(比如“Open”)作为关键字的数据帧(现在资产是列)字典。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="73dd" class="nq lt iq nm b gy nr ns l nt nu">dict_keys(['Open', 'Low', 'High', 'Close', 'Volume'])<br/>(1083, 10)</span></pre><h1 id="7f5a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">生成时间窗口</h1><p id="12b3" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">接下来，我们将在整个时间段内移动一个6个月的滑动窗口，并在该窗口内对每个价格数据帧拍摄400个“快照”。每个快照将对应于应该独立回测的数据子集。与资产和其他变量一样，快照也需要水平堆叠成列。结果，我们将得到180行(以天为单位的窗口长度)和4000列(10个资产x 400个窗口)；也就是说，一个列将对应于一个特定时间窗口内的一项资产的价格。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="3650" class="nq lt iq nm b gy nr ns l nt nu">(180, 4000)</span></pre><p id="0200" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">vectorbt的一个很好的特性是，它利用<a class="ae ku" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/advanced.html" rel="noopener ugc nofollow" target="_blank">层次索引</a>来存储关于每个回溯测试的有价值的信息。它还确保了这种列层次结构在整个回溯测试管道(从信号生成到性能建模)中得以保留，并且可以轻松扩展。目前，我们的列具有以下层次结构:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="86ee" class="nq lt iq nm b gy nr ns l nt nu">MultiIndex([<br/>    ('BTC-USD', '2017-12-31', '2018-06-28'),<br/>    ('BTC-USD', '2018-01-02', '2018-06-30'),<br/>    ('BTC-USD', '2018-01-05', '2018-07-03'),<br/>    ...<br/>    ('ADA-USD', '2020-06-16', '2020-12-12'),<br/>    ('ADA-USD', '2020-06-19', '2020-12-15'),<br/>    ('ADA-USD', '2020-06-21', '2020-12-17')<br/>], names=[<br/>    'symbol', <br/>    'range_start', <br/>    'range_end'<br/>], length=4000)</span></pre><p id="0830" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这个多索引捕获三个参数:符号、时间窗口的开始日期和结束日期。稍后，我们将使用退出类型和止损值扩展这个多指数，这样200万个回溯测试中的每一个都有自己的价格系列。</p><h1 id="0be8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">产生进入信号</h1><p id="2a6a" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">与大多数其他回溯测试库相比，信号不是以有符号整数数组的形式存储的，而是被分成两个布尔数组:entries和exits，这使得操作更加容易。</p><p id="ecc8" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在每个时间窗口的开始，让我们产生一个进场信号，指示一个买入订单。数据框将具有与价格框相同的形状、索引和列，以便vectorbt可以将它们的元素链接在一起。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="c2f8" class="nq lt iq nm b gy nr ns l nt nu">(180, 4000)</span></pre><h1 id="f55b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">生成退出信号</h1><p id="51ca" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">对于我们生成的每一个进场信号，我们将根据我们的5种出场类型找到一个出场信号:SL，TS，TP，random和holding。我们还将把它们的数据帧连接成一个有180行和2，000，000列的单个(巨大的)数据帧，每个数据帧代表一个单独的回溯测试。因为退出信号是布尔型的，所以它们的内存占用是可以容忍的。</p><p id="3780" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">让我们首先根据停止条件生成退出信号。我们想测试100个不同的止损值，增量为1%，从1%开始，到100%结束(即找到一个价格超过进场价格100%的时间戳)。通常，当OHLC数据与这些条件核对时，头寸在触及特定止损点时(或之后不久)被平仓，但是我们将简化事情，使用“收盘”价格来退出任何头寸。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="66f0" class="nq lt iq nm b gy nr ns l nt nu">(180, 400000) (180, 400000) (180, 400000)</span></pre><p id="567c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这也扩展了我们的列层次结构，增加了一个新的列级别来指示止损值，我们只需在所有数据帧中保持一致即可:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="6e31" class="nq lt iq nm b gy nr ns l nt nu">MultiIndex([<br/>    (0.01, 'BTC-USD', '2017-12-31', '2018-06-28'),<br/>    (0.01, 'BTC-USD', '2018-01-02', '2018-06-30'),<br/>    (0.01, 'BTC-USD', '2018-01-05', '2018-07-03'),<br/>    ...<br/>    ( 1.0, 'ADA-USD', '2020-06-16', '2020-12-12'),<br/>    ( 1.0, 'ADA-USD', '2020-06-19', '2020-12-15'),<br/>    ( 1.0, 'ADA-USD', '2020-06-21', '2020-12-17')<br/>], names=[<br/>    'stop_value', <br/>    'symbol', <br/>    'range_start', <br/>    'range_end'<br/>], length=400000)</span></pre><p id="92f2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">vectorbt的一个主要特点是它非常关注数据科学，因此它允许我们将流行的分析工具应用到回溯测试管道的几乎任何部分。例如，让我们探讨退出信号的数量如何取决于止损类型和值:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="a321" class="nq lt iq nm b gy nr ns l nt nu">SL    0.434195<br/>TS    0.590803<br/>TP    0.514545<br/>Name: avg_num_signals, dtype: float64</span></pre><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/1f79be6268e2ad44c3e8b5ec3cadd035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*KREKKqYKbQMNlTwG7-1Crw.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Average number of signals by exit type and stop value</figcaption></figure><p id="058f" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们看到TS是目前为止出现最多的退出信号。SL和TP曲线在达到50%的止损值时结合在一起，然后偏向TP。虽然看起来似乎是多头在主导，特别是对于更大的价格波动，但请记住，公布50%的利润比公布50%的损失要容易得多，因为后者需要100%的利润才能恢复；因此，向下的负峰值似乎主导了中小范围的价格变动(并有可能动摇弱势群体)。这些都是众所周知的加密货币动态。</p><p id="7f32" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">为了简化后面的分析，我们应该确保每一列至少有一个出场信号来平仓，这意味着如果一列现在没有出场信号，它应该在最后一个时间戳得到一个。这是通过使用OR规则将止损止损点和最后一根止损点结合起来，并选择最先出现的止损点来实现的:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="0ff7" class="nq lt iq nm b gy nr ns l nt nu">SL    1.0<br/>TS    1.0<br/>TP    1.0<br/>Name: avg_num_signals, dtype: float64</span></pre></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="39cc" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">接下来，我们将生成两种剩余退出类型的信号:随机和持有——它们将作为比较SL、TS和TP的基准。</p><p id="e0be" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">“持有”退出信号是放在每个时间序列最后一根棒线上的信号。在大多数情况下，我们不应该费心去设置它们，因为我们可以简单地评估未平仓头寸。我们这样做的原因是一致性——我们希望确保每一列都有(恰好)一个信号。另一个要考虑的是形状和列:它们应该与停止信号相匹配，这样我们可以在以后连接所有的数据帧。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="1043" class="nq lt iq nm b gy nr ns l nt nu">(180, 400000)</span></pre><p id="6dd2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">要生成随机退出信号，只需洗牌的任何信号阵列。唯一的要求是每一列应该正好包含一个信号。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="dbd3" class="nq lt iq nm b gy nr ns l nt nu">(180, 400000)</span></pre></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="23a5" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">最后一步是沿着列轴连接所有数据帧:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="6e99" class="nq lt iq nm b gy nr ns l nt nu">(180, 2000000)</span></pre><p id="b1bc" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><code class="fe nv nw nx nm b">exits</code>数组现在包含2，000，000列——每个回溯测试一列。列层次结构也是完整的——每个回溯测试有一个超参数元组。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="33da" class="nq lt iq nm b gy nr ns l nt nu">MultiIndex([<br/>    (     'SL', 0.01, 'BTC-USD', '2017-12-31', '2018-06-28'),<br/>    (     'SL', 0.01, 'BTC-USD', '2018-01-02', '2018-06-30'),<br/>    (     'SL', 0.01, 'BTC-USD', '2018-01-05', '2018-07-03'),<br/>    ...<br/>    ('Holding',  1.0, 'ADA-USD', '2020-06-16', '2020-12-12'),<br/>    ('Holding',  1.0, 'ADA-USD', '2020-06-19', '2020-12-15'),<br/>    ('Holding',  1.0, 'ADA-USD', '2020-06-21', '2020-12-17')<br/>], names=[<br/>    'exit_type', <br/>    'stop_value', <br/>    'symbol', <br/>    'range_start', <br/>    'range_end'<br/>], length=2000000)</span></pre><p id="7600" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这使我们能够按一个或多个级别对信号进行分组，并方便地一次性进行分析。例如，让我们通过出场信号到进场信号的平均距离(以天为单位)来比较不同的出场类型和止损值:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="265b" class="nq lt iq nm b gy nr ns l nt nu">exit_type<br/>Holding    179.000000<br/>Random      89.929929<br/>SL         123.815830<br/>TP         114.185100<br/>TS         103.323425<br/>dtype: float64</span></pre><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/76b80529bb5f8fd152f2e453077f6680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*oJQUjsZXRtwDrR5zdGUsHw.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Average distance of exit signal to entry signal by exit type and stop value</figcaption></figure><p id="172a" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这个散点图让我们更详细地了解出口信号的分布。正如所料，普通持有的退出信号在进场后有179天的精确距离(最大可能)，而随机退出信号在时间窗口内均匀分布，不依赖于任何止损值。但我们更感兴趣的是止损曲线，它是平的，因此暗示了我们时间框架内价格运动的高波动性——曲线越低，止损的可能性就越大。举个例子，20%的TS平均只需30天就能达到，而SL需要72天，TP需要81天。但是提前退出有什么好处吗？</p><h1 id="c535" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">运行模拟</h1><p id="0d25" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">下面是实际的回溯测试部分:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="a004" class="nq lt iq nm b gy nr ns l nt nu">3995570</span></pre><p id="1719" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">相当简单，对吧？</p><p id="d3d7" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在我的MacBook Air上，模拟花了4分钟完成，总共生成了3，995，570个订单，可以进行分析(应该是400万，但一些价格数据点似乎丢失了)。但是，请注意，由与我们的退出信号(如投资组合价值或回报)形状相同的投资组合对象生成的任何数组都需要8 * 180 * 2000000字节或几乎3GB的RAM，并且它会被自动缓存以供其他投资组合组件重用。因此，一旦投资组合绩效的计算结束，我们将禁用缓存来释放内存:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="3109" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们可以分析从交易到夏普比率的任何东西，但是考虑到数据量，我们将坚持一个快速计算的指标——总回报。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="6f27" class="nq lt iq nm b gy nr ns l nt nu">(2000000,)</span></pre><p id="3aa9" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果您的计算机需要大量时间进行模拟，您有几种选择:</p><ul class=""><li id="d9cf" class="mv mw iq jy b jz ka kd ke kh mx kl my kp mz kt na nb nc nd bi translated">使用<a class="ae ku" href="https://colab.research.google.com" rel="noopener ugc nofollow" target="_blank"> Google Colab </a></li><li id="22c2" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">减少止损值的数量(例如，从1%减少到2%)</li><li id="e5ed" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">投射到<code class="fe nv nw nx nm b">np.float32</code>甚至更低(如果支持的话)</li><li id="c9be" class="mv mw iq jy b jz ne kd nf kh ng kl nh kp ni kt na nb nc nd bi translated">将出口信号阵列分割成块，并对每个块进行模拟。只要确保每个块的形状与价格和条目的形状一致即可(如果是模拟的，记得删除之前的投资组合):</li></ul><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="97b9" class="nq lt iq nm b gy nr ns l nt nu">100%|██████████| 5/5 [01:19&lt;00:00, 16.98s/it]<br/>(2000000,)</span></pre><p id="ebfe" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">那好多了。</p><h1 id="741e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">分析性能</h1><p id="6d7a" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">第一步是始终观察基线的分布:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="8f94" class="nq lt iq nm b gy nr ns l nt nu">count    400000.000000<br/>mean          0.069392<br/>std           0.814803<br/>min          -0.915331<br/>50%          -0.148971<br/>max           6.526005<br/>Name: Holding, dtype: float64</span></pre><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/a53f678d7fd9cc80b7b173fdca0af9f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*nUrVXYoRWrvQ-mta18hT0g.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Distribution of holding returns</figcaption></figure><p id="3226" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">持有业绩在时间窗口上的分布是高度左偏的。一方面，这表明在我们的时间框架内，长期横盘和熊市。另一方面，任何资产的价格都可以攀升至无穷大，但受到0的限制——这使得左边的分布更密集，右边的分布更稀疏。每秒钟的回报是超过7%的损失，但由于牛市，该策略仍能实现7%的平均利润。</p><p id="603c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">让我们将其他策略纳入分析:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="fa0e" class="nq lt iq nm b gy nr ns l nt nu">               Mean    Median       Std<br/>exit_type                              <br/>SL         0.035266 -0.168662  0.750711<br/>TS         0.038908 -0.112648  0.685156<br/>TP         0.038539  0.070077  0.477094<br/>Random     0.016484 -0.083610  0.570806<br/>Holding    0.069122 -0.148971  0.814248</span></pre><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/6e9bd989c10aa9635805ca4567916264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*YZQKOccF1KRfSQlrH8rncQ.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Distribution of returns by exit type</figcaption></figure><p id="2f1c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">没有一种策略超过基线的平均回报。TP策略是最一致的策略——尽管它引入了一个限制巨额利润的上限(见遗漏异常值),它的交易回报波动较小，而且大部分是正的。SL和TS在顶部没有界限的原因是一些止损点没有被触及，所以它们的柱回落到简单持有。随机策略也很有趣:虽然它在平均回报方面较差，但在中值回报和回报波动性方面仅次于TP。</p><p id="133e" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">为了证实上图，我们来计算一下每个策略的胜率:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="4a28" class="nq lt iq nm b gy nr ns l nt nu">exit_type<br/>SL         0.309275<br/>TS         0.354683<br/>TP         0.569420<br/>Random     0.395713<br/>Holding    0.394750<br/>Name: win_rate, dtype: float64</span></pre><p id="b945" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">几乎57%的TP交易是盈利的——与其他策略形成鲜明对比。但是，如果你的盈利交易经常比亏损交易少得多，那么高的盈利率并不一定保证长期的交易成功。因此，让我们按止损类型和值合计，并计算<a class="ae ku" href="https://www.icmarkets.com/blog/reward-to-risk-win-ratio-and-expectancy/" rel="noopener ugc nofollow" target="_blank">预期</a>:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><pre class="kw kx ky kz gt nl nm nn no aw np bi"><span id="7bc2" class="nq lt iq nm b gy nr ns l nt nu">exit_type<br/>SL         3.657913<br/>TS         4.073352<br/>TP         4.156836<br/>Random     1.715895<br/>Holding    7.100061<br/>dtype: float64</span></pre><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/87a7f1ef4cfc4f8b33ae15f49e1e343a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*IkWYRUY1uB5O3qPk4jm0ig.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Expectancy by exit type and stop value</figcaption></figure><p id="541f" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">从长远来看，每种策略都能够逐渐增加我们的账户，持有策略在这里是明显的赢家——在每持有6个月之后，我们可以预计每100美元投资中平均会增加7美元到我们的账户。唯一优于基线的配置是ts，其stop值在20%到40%之间。表现最差的配置是SL和TS，止损值分别在40%和55%左右；一旦大多数修正找到底部，两者似乎都会被触发，这比随机退出更糟糕。另一方面，TP策略在30%的止损值后击败了随机退出策略。一般来说，等待对加密货币来说似乎是有回报的。</p><p id="852d" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">最后，让我们看看我们的策略在不同的市场条件下表现如何。我们将考虑一种简化形式的制度分类，将持有回报分为20个仓位，并计算每个仓位边界内每个策略的预期(为了图表可读性，我们忽略了最新的仓位)。请注意，由于持有回报的高度偏斜分布，我们需要考虑观察的密度，并使仓位大小相等。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/02cab0b1f0876978a391328e6151fce5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*oaZrubhuR7e9lN5gE_RTaw.png"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Expectancy against binned holding returns by exit type</figcaption></figure><p id="d372" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">上面的图表证实了止损单行为背后的一般直觉:SL和TS限制了交易者在下跌趋势中的损失，TP对有兴趣从价格快速上涨中获利的短线交易者有利，持有在顶部增长市场中表现最好。令人惊讶的是，虽然随机出场在横盘和牛市中表现不佳，但在熊市中，它们与止损出场相匹配，而且表现更好。</p><h1 id="0318" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">额外奖励:Jupyter仪表盘</h1><p id="3095" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">仪表板是一种非常强大的数据交互方式。</p><p id="be9b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">首先，让我们定义仪表板的组件。我们有两种类型的组件:控件(如资产下拉列表)和图表。控件定义参数并触发图形更新。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="dd5b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">第二步是定义更新函数，一旦任何控件发生更改，就会触发该函数。我们还手动调用这个函数，用默认参数初始化图形。</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="4fec" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在最后一步中，我们将定义仪表板的布局并最终运行它:</p><figure class="kw kx ky kz gt la"><div class="bz fp l di"><div class="nj nk l"/></div></figure><figure class="kw kx ky kz gt la gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/86ac3593e3572b9b6425dc415aef577c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/1*NnUPXcQq5ukidd8ojNTfqw.gif"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Illustration of the dashboard with every asset selected</figcaption></figure><h1 id="1f8a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="aa4e" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">大规模回测的使用并不局限于超参数优化，但如果利用得当，它为我们提供了探索与交易相关的复杂现象的工具。特别是利用多维数组、动态编译和与pandas的集成，如vectorbt所做的那样，通过将流行的数据科学工具应用于回溯测试管道的每个组件，我们可以快速获得新的见解。</p><p id="de48" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在这个特殊的例子中，我们进行了200万次回溯测试，以观察不同的止损值如何影响止损信号的表现，以及不同的止损信号与随机持有和交易相比有何不同。一方面，这些发现证实了我们已经知道的在各种市场条件下停止信号的行为。另一方面，它们揭示了在过去几年的加密货币交易中可能运行良好的最佳配置。</p><p id="ea20" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">但是总有比我们上面画的两张图表更多的东西。如果您想对自己的数据进行分析或尝试不同的超参数，请随意运行<a class="ae ku" href="https://nbviewer.jupyter.org/github/polakowo/vectorbt/blob/master/examples/StopSignals.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>。</p><h1 id="76bd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">更多文章</h1><p id="0ceb" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">查看<a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/superfast-supertrend-6269a3af0c2a"> SuperFast SuperTrend </a>，在这里您将学习如何使用TA-Lib、Numba和vectorbt (PRO)在Python中设计和实现最快的SuperTrend指示器。</p><h1 id="7026" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">支持</h1><p id="9ce6" class="pw-post-body-paragraph jw jx iq jy b jz mq kb kc kd mr kf kg kh ms kj kk kl mt kn ko kp mu kr ks kt ij bi translated">请在<a class="ae ku" href="https://github.com/sponsors/polakowo" rel="noopener ugc nofollow" target="_blank"> Github赞助商</a>上支持我，为新的离线交易分析生态系统做出贡献。作为回报，你将可以提前获得<a class="ae ku" href="https://vectorbt.pro/" rel="noopener ugc nofollow" target="_blank">vector Bt pro</a>——vector Bt的积极开发的商业继任者，旨在为量化分析师提供专业的分析工具——和新的独家学习内容❤️</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="0dfb" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在<a class="ae ku" href="https://app.ddichat.com/category/data-science-ai-ml-dl" rel="noopener ugc nofollow" target="_blank"><strong class="jy ja">Data Science/AI/ML/DL</strong></a>中安排DDIChat会话:</p><div class="og oh gp gr oi oj"><a href="https://app.ddichat.com/category/data-science-ai-ml-dl" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ja gy z fp oo fr fs op fu fw iz bi translated">专家-数据科学/ AI / ML / DL - DDIChat</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">DDIChat允许个人和企业直接与主题专家交流。它使咨询变得快速…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">app.ddichat.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox lf oj"/></div></div></a></div><p id="ea17" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在这里申请成为DDIChat专家<a class="ae ku" href="https://app.ddichat.com/expertsignup" rel="noopener ugc nofollow" target="_blank"/>。<br/>与DDI合作:<a class="ae ku" href="https://datadriveninvestor.com/collaborate" rel="noopener ugc nofollow" target="_blank">https://datadriveninvestor.com/collaborate</a><br/>点击此处订阅DDIntel <a class="ae ku" href="https://ddintel.datadriveninvestor.com/" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>