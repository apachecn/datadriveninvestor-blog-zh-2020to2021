<html>
<head>
<title>Fetch data from the database/API in React with useEffect and useState</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用useEffect和useState从数据库/API中提取数据</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/fetch-data-from-the-database-api-in-react-with-useeffect-and-usestate-af11468cdb14?source=collection_archive---------1-----------------------#2020-08-23">https://medium.datadriveninvestor.com/fetch-data-from-the-database-api-in-react-with-useeffect-and-usestate-af11468cdb14?source=collection_archive---------1-----------------------#2020-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1aeb048de88b072f53adc1b3464873be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZnZE8df9sb72Rp-E3HeGPw.png"/></div></div></figure><h1 id="c04a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">对应于<code class="fe kw kx ky kz b">componentdidmount</code></h1><p id="9c92" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">很多时候，当组件安装在React中时，我们希望获取大量数据。如果你熟悉React中的类组件，你知道我们可以使用<code class="fe kw kx ky kz b">componentdidmount</code>。对于功能组件，对应的是<code class="fe kw kx ky kz b">useEffect</code>。我们可以使用<code class="fe kw kx ky kz b">useState</code>来处理从数据库或API获取的数据。</p><h1 id="7656" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">例子</h1><p id="5cc9" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">例如，我想在主页上显示大量从数据库中获取的附近餐馆的数据。</p><p id="385a" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">如果我们像这样正常地做:</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="ef32" class="ml jz iq kz b gy mm mn l mo mp">const homepage = () =&gt; {<br/>  let restaurants = fetchData()</span><span id="ac2f" class="ml jz iq kz b gy mq mn l mo mp">return(<br/>        renderRestaurants(restaurants)<br/>    )<br/>}</span></pre><p id="0d10" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">当我们的组件想要使用<code class="fe kw kx ky kz b">restaurants</code>值时，因为获取过程可能需要很长时间，所以我们不会看到我们期望的餐馆数据显示。</p><p id="93cc" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">但是我们不能在一个功能组件中使用<code class="fe kw kx ky kz b">async/await</code>。我们通常会得到这样的错误，因为React没有将<code class="fe kw kx ky kz b">Promise</code>作为一个组件(因为在您放置了<code class="fe kw kx ky kz b">async</code>之后，React会将其视为<code class="fe kw kx ky kz b">Promise</code>):</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="b678" class="ml jz iq kz b gy mm mn l mo mp">Objects are not valid as a React child (found: [object Promise]).</span></pre><p id="fadf" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">那我们能做什么？</p><h1 id="6f14" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">解决办法</h1><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="52fd" class="ml jz iq kz b gy mm mn l mo mp"><br/>useEffect(() =&gt; {<br/>   fetchData()<br/>      })</span></pre><p id="0138" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">可以看到，<code class="fe kw kx ky kz b">useEffect</code>将一个函数作为第一个参数。它会在每次渲染后自动触发。它将在其他事情之前被触发，所以我们可以确保当我们想要显示数据时，数据就在那里。</p><h2 id="5aa8" class="ml jz iq bd ka mr ms dn ke mt mu dp ki ll mv mw km lp mx my kq lt mz na ku nb bi translated">我们如何处理获取的数据？</h2><p id="9451" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">答:我们可以用<code class="fe kw kx ky kz b">useState</code>来处理:</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="dcd7" class="ml jz iq kz b gy mm mn l mo mp">const [restaurants, setRestaurants] = useState([])</span><span id="13b2" class="ml jz iq kz b gy mq mn l mo mp">useEffect(() =&gt; {<br/>   let data = fetchData();<br/>   setRestaurants(data)<br/>      })</span></pre><p id="946b" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">在这个例子中，我们为组件设置了一个<code class="fe kw kx ky kz b">restaurants</code>状态，并将默认值设置为一个数组。<code class="fe kw kx ky kz b">setRestaurants</code>是改变<code class="fe kw kx ky kz b">restaurants</code>值的方法。</p><p id="c0a2" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">因此，在<code class="fe kw kx ky kz b">useEffect</code>中，我们调用<code class="fe kw kx ky kz b">fetchData()</code>从db或API中获取数据，然后我们应该会得到附近的一系列餐馆数据。然后我们可以将该数据传递给<code class="fe kw kx ky kz b">setRestaurants</code>，这样<code class="fe kw kx ky kz b">restaurants</code>将被更新以供我们将来在文档中使用。</p><h2 id="0421" class="ml jz iq bd ka mr ms dn ke mt mu dp ki ll mv mw km lp mx my kq lt mz na ku nb bi translated">异步部分呢？</h2><p id="91d3" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">明确地说，如果你试图这样做:</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="b39b" class="ml jz iq kz b gy mm mn l mo mp">useEffect( async() =&gt; {<br/>   let data = await fetchData();<br/>   setRestaurants(data)<br/>      })</span></pre><p id="8649" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">你也会得到一个错误。您可以像这样调用异步函数:</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="bcf7" class="ml jz iq kz b gy mm mn l mo mp">useEffect(() =&gt; {<br/>    getRestaurants = async() =&gt; {<br/>       await fetchData()  <br/>       setRestaurants(data)    <br/>     }<br/>    getRestaurants();  <br/>      })</span></pre><p id="f5e1" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">解决方案是我们将异步部分包装在另一个函数中，然后在以后调用它。</p><h2 id="0b52" class="ml jz iq bd ka mr ms dn ke mt mu dp ki ll mv mw km lp mx my kq lt mz na ku nb bi translated">如果我们希望它只在一个值被改变时被触发呢？</h2><p id="17ea" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">答:如果我们将第二个参数传递给<code class="fe kw kx ky kz b">useEffect</code>，代码看起来会像这样:</p><pre class="md me mf mg gt mh kz mi mj aw mk bi"><span id="6aa7" class="ml jz iq kz b gy mm mn l mo mp">useEffect(() =&gt; {<br/>    getRestaurants = async() =&gt; {<br/>       await fetchData()  <br/>       setRestaurants(data)    <br/>     }<br/>    getRestaurants();  <br/>     }, [restaurants]<br/>     )</span></pre><p id="4745" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">第二个论点是什么意思？基本上，它告诉组件比较先前的<code class="fe kw kx ky kz b">restaurants</code>和当前的<code class="fe kw kx ky kz b">restaurants</code>值，如果没有差异，那么效果将被跳过。</p><p id="24cb" class="pw-post-body-paragraph la lb iq lc b ld ly lf lg lh lz lj lk ll ma ln lo lp mb lr ls lt mc lv lw lx ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>