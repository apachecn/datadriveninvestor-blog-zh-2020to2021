<html>
<head>
<title>SQL for Stock Market Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于股票市场分析的SQL</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/sql-for-stock-market-analysis-f2145031e125?source=collection_archive---------2-----------------------#2020-03-05">https://medium.datadriveninvestor.com/sql-for-stock-market-analysis-f2145031e125?source=collection_archive---------2-----------------------#2020-03-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="5a69" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">SQL变得简单</h2><div class=""/><div class=""><h2 id="eb69" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">用窗口函数比较收盘价</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/14f51dfad3e8e8cf509abfefdca487fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cYDRU154f-xjnxEt"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Don’t feel lost; use your friend SQL to get insights from your stock data! <a class="ae lh" href="https://unsplash.com/photos/uCMKx2H1Y38" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="45a0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在你做股票分析的工具带里，SQL知识就像一把瑞士刀。您可以使用最容易学习的语言之一，以多种方式对数据进行切片、聚合、分离、过滤和比较。</p><p id="a168" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">今天，我将向您展示如何使用最酷的Windows功能之一，以及如何使用它来提高您的股票分析。我将使用<a class="ae lh" href="https://www.microsoft.com/en-in/sql-server/sql-server-2019" rel="noopener ugc nofollow" target="_blank"> SQL Server </a>，所以请注意，如果您使用<a class="ae lh" href="https://www.sqlitetutorial.net/" rel="noopener ugc nofollow" target="_blank"> SQLite </a>、<a class="ae lh" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>或其他变体，语法可能会发生变化，但是如果快速搜索，您可以很容易地找到等价的语法。</p><p id="913d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将使用的数据是美国银行股票的调整后收盘价，从2019年4月3日到2019年3月3日测量，因此它涵盖了这一特定股价的一年。让我们看看第一排:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi me"><img src="../Images/98a60d3cfb76aae6155dfd657cd97f05.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*CuyaxVyu9S8ApzZ0DzhJJQ.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Bank of America stock price (adjusted close), first 10 rows.</figcaption></figure><p id="02b6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">像往常一样，本教程的数据集和脚本可以在<a class="ae lh" href="https://github.com/lucasmoratof/stock_projects" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><h2 id="1cbd" class="mf mg it bd mh mi mj dn mk ml mm dp mn lr mo mp mq lv mr ms mt lz mu mv mw iz bi translated">什么是窗口函数？</h2><p id="ec45" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">当我们需要基于一行或多行计算聚合值时，会使用窗口函数。它们非常方便，因为它们用于将一行中的值与其他行中的值进行比较。对于本教程，我们将使用一个最常用的窗口函数:</p><ul class=""><li id="9458" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated"><a class="ae lh" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/lag-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd"> LAG </strong> </a>:用于访问当前行之前的行。</li></ul><p id="7dcd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">LAG可用于进行强有力的比较，其结果也可用于进一步的计算，就像我们今天要做的那样。</p><h2 id="bae1" class="mf mg it bd mh mi mj dn mk ml mm dp mn lr mo mp mq lv mr ms mt lz mu mv mw iz bi translated">将收盘价与前一天进行比较</h2><p id="3cb1" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">股票市场最基本的一个问题就是:<strong class="lk jd">这只股票过去表现如何？</strong>我们通常喜欢在几天、几个月或几年之间比较这些信息，因此我们可以利用这些信息来了解股票行为，并尝试预测未来。为了回答这个问题，我们将每天比较股票，在我们比较了</p><ul class=""><li id="babd" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated">创建一个临时表，以便我们可以使用适当的字段进行计算；</li><li id="2695" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">在临时表中，使用LAG函数创建一个包含前一天收盘价的新列；</li><li id="c4d3" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">在主查询中，比较价格与前一天的差异百分比。这个公式是:</li></ul><blockquote class="nq"><p id="86f3" class="nr ns it bd nt nu nv nw nx ny nz md dk translated">(实际价格-先前价格)/先前价格* 100</p></blockquote><p id="3854" class="pw-post-body-paragraph li lj it lk b ll oa kd ln lo ob kg lq lr oc lt lu lv od lx ly lz oe mb mc md im bi translated">在查询中，我们使用的是<strong class="lk jd">格式</strong>函数，它用100代替乘法运算，并在我们传递参数‘P’时自动添加“%”符号。</p><div class="of og gp gr oh oi"><a href="https://www.datadriveninvestor.com/2019/01/23/which-is-more-promising-data-science-or-software-engineering/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd jd gy z fp on fr fs oo fu fw jc bi translated">数据科学和软件工程哪个更有前途？数据驱动的投资者</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">大约一个月前，当我坐在咖啡馆里为一个客户开发网站时，我发现了这个女人…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow lb oi"/></div></div></a></div><p id="1788" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在看一下查询及其结果。如果您不熟悉SQL，我为您留下了一些注释，以便让您更容易理解:</p><p id="8aa8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">查询以创建每日收盘股票价格之间的比较。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/3dc3007b50d701ec19ab922c4377421b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*lvC7Pl5enxtVYNfD44vxAA.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Query Result. The last column shows how much a price has changed compared with the previous day.</figcaption></figure><p id="380a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">很酷，不是吗？如果你熟悉股票市场，观察一段时间内的涨跌是很有趣的。关于查询，我们需要弄清楚关于滞后函数的几个关键点:</p><ul class=""><li id="7a55" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated">正如在任何窗口函数中一样，<strong class="lk jd">我们总是需要OVER子句</strong>。在我们的例子中，我们基本上是说按日期对数据进行排序，然后在排序后，将每一行与前一行进行比较。</li></ul><p id="83db" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在LAG中，我们需要两个参数，一个是我们要比较的列，它在实际的列之前很多行。因为我们需要前一天，所以我们使用数字“1”。</p><h2 id="78b8" class="mf mg it bd mh mi mj dn mk ml mm dp mn lr mo mp mq lv mr ms mt lz mu mv mw iz bi translated">跨月价格比较</h2><p id="1bd7" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">现在你对滞后现象更熟悉了，让我们用最后一个例子来说明如何比较全年的月平均价格。这个想法与最初的想法相似，但是我们还需要几个步骤来完成这个结果，所以请仔细阅读查询和注释:</p><p id="ff17" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">将月平均价格与月间百分比变化进行比较。</p><p id="e518" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">以月、年等为单位汇总数据时，很少需要注意什么。：</p><ul class=""><li id="7430" class="nc nd it lk b ll lm lo lp lr ne lv nf lz ng md nh ni nj nk bi translated">聚合需要出现在主查询之前，这就是为什么我们在FROM语句中使用子查询；</li><li id="e3ea" class="nc nd it lk b ll nl lo nm lr nn lv no lz np md nh ni nj nk bi translated">由于我们要汇总不同年份的月份，因此在LAG函数和主查询的末尾使用额外的ORDER BY语句非常重要。否则，它将按月进行比较和排序，但会混淆年份。</li></ul><p id="1515" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们来看看结果:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/30337e302006e4f5dc4cf99ea9548168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*KVa6yyTHl3qrZP97R75H5w.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Average price by month, with percentage change between months.</figcaption></figure><h2 id="6702" class="mf mg it bd mh mi mj dn mk ml mm dp mn lr mo mp mq lv mr ms mt lz mu mv mw iz bi translated">下一步是什么？</h2><p id="2dc1" class="pw-post-body-paragraph li lj it lk b ll mx kd ln lo my kg lq lr mz lt lu lv na lx ly lz nb mb mc md im bi translated">有了这些结果，你可以做很多事情！你可以分析股票的波动性，并试图找到原因，比如，为什么价格从2019年8月到12月开始强劲上涨？或者甚至将当前的事件，如冠状病毒，与2020年3月近15%的显著下降联系起来。</p><p id="2383" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您还可以使用这些数据绘制漂亮的图表，这将有助于您直观地了解价格变化。我有这个<a class="ae lh" href="https://medium.com/datadriveninvestor/introduction-to-stock-analysis-in-python-574246e689e3" rel="noopener">教程</a>教你如何做到这一点。总之，我的目标是向您展示一些用于股票分析的SQL技巧，并让您了解该领域中使用的数据的可能性。我希望你能像我喜欢写它一样喜欢阅读！</p></div><div class="ab cl oz pa hx pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="im in io ip iq"><p id="1160" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">你可以在<a class="ae lh" href="https://twitter.com/lmmfrederico" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae lh" href="https://www.linkedin.com/in/hey-i-am-lucas/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>、<a class="ae lh" href="https://gist.github.com/lucasmoratof" rel="noopener ugc nofollow" target="_blank"> GitHub </a>和<a class="ae lh" href="https://public.tableau.com/profile/lucas.morato#!/?newProfile=&amp;activeTab=0" rel="noopener ugc nofollow" target="_blank"> Tableau Public </a>上找到我</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pg ph l"/></div></figure></div></div>    
</body>
</html>