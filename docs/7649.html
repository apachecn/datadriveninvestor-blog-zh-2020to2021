<html>
<head>
<title>Train a CNN using Skorch for MNIST digit recognition</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MNIST数字识别Skorch训练CNN</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/train-a-cnn-using-skorch-for-mnist-digit-recognition-53d7d2f971c7?source=collection_archive---------5-----------------------#2020-12-17">https://medium.datadriveninvestor.com/train-a-cnn-using-skorch-for-mnist-digit-recognition-53d7d2f971c7?source=collection_archive---------5-----------------------#2020-12-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="520e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">结合了scikit-learn的灵活性和PyTorch的强大功能的库</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5914a8efa479e6500132adf942eda766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WpnjVPb3etddKwn_YX7Qyg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Image made by Author</figcaption></figure><p id="c255" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这篇文章的目标是使用一个工具以简单的方式训练和评估Pytorch的模型。这个工具是<strong class="la iu"> Skorch，</strong>那个<strong class="la iu"> </strong>是一个scikit-learn兼容的神经网络库，包装了Pytorch。所以使得Pytorch配合sklearn使用成为可能。此外，它利用了Scikit-learn的功能，如fit、predict和GridSearch [1]。这个工具应用在<strong class="la iu"> MNIST </strong>上，这是一个由手写数字图像组成的数据集:6万个用于训练，1万个用于测试。在卷积神经网络中，我们将手写数字(0-9)的图像作为输入，并将图像分类为适当的数字。</p><h1 id="a485" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">什么是斯科奇？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/0b9c9ecb2eb922623a21e3935b72f277.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*ar7YH6pw7abB7uwiODDv_A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Credit: <a class="ae mn" href="https://github.com/skorch-dev/skorch" rel="noopener ugc nofollow" target="_blank">Skorch</a></figcaption></figure><p id="3163" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Skorch是一个非常新的开源库，于2017年首次推出。简单来说，它结合了<strong class="la iu"> S </strong> ci <strong class="la iu"> K </strong> it-Learn和python<strong class="la iu">ORCH</strong>。因此，它允许用SKlearn轻松交换神经网络并提取Pytorch模块。这种开源的主要优势是减少了样板代码。如果您过去使用过Pytorch，那么编写用于培训的可能会有问题，因为总是要编写相同的代码，并且很容易因为代码行过多而出错[2]。</p><p id="d60c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">用Pytorch训练:</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="e513" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">与Skorch一起训练</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="0efb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">比较这两个例子，您可以观察到Skorch允许使用更少的代码行。为了理解这个开源库的作品，我将遍历经典的MNIST分类问题。</p><h1 id="53e3" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤1:导入库和数据集</h1><p id="9a6c" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">让我们安装Skorch，我们将在本教程中使用的库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="1e34" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦安装了库，我们就可以导入库了。</p><p id="d49b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">斯科奇。NeuralNetClassifier </strong>是一个用于分类任务的神经网络类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><h1 id="495a" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤2:训练前准备数据集</h1><p id="19e6" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">我们正在使用<strong class="la iu"> torch.device. </strong>创建一个对象，张量将被分配到这个设备对象中，它的设备类型是cpu或cuda。要使用gpu，需要指定“cuda”。</p><p id="36b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们希望skorch为我们做一个验证分割，我们需要从训练数据集中检索<code class="fe mv mw mx my b">y_train</code>值，并在稍后将这些值传递给<code class="fe mv mw mx my b">net.fit</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><h1 id="6c76" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">步骤3:创建模型</h1><p id="f1bc" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">我们的卷积神经网络具有两个卷积层，每个卷积层具有5×5核，以及两个完全连接的层。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><h1 id="e545" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">第四步:训练模型</h1><p id="d437" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">现在我们将初始化<strong class="la iu"> NeuralNetClassifier </strong>类，其中我们指定:</p><ul class=""><li id="e411" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">Pytorch模块:在我们的例子中，我们的CNN模型。</li><li id="ca31" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu">判据</strong>(默认=nn。NLLLoss):我们需要指定我们使用的是CrossEntropyLoss。</li><li id="248b" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu">优化器</strong>(默认=optim。SGD):我们选择优化器Adam。</li><li id="6aeb" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu"> batch_size </strong>(默认=128):我们使用64作为batch_size。</li><li id="e7e3" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu"> lr </strong>(默认值=0.01):传递给优化器的学习率为1e-3。</li><li id="f0fd" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu"> max_epochs </strong>(默认值=10)</li><li id="c03d" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu"> iterator_train </strong>和<strong class="la iu"> iterator_valid: </strong>默认PyTorch <code class="fe mv mw mx my b"><a class="ae mn" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">DataLoader</strong></a></code>用于训练和验证数据。</li><li id="f71a" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu"> train_split </strong>(默认值=0.2):默认情况下，20%的训练数据被保留用于验证。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="6713" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，默认情况下，训练数据将被skorch内部分成<strong class="la iu"> </strong> 80%的训练和20%的验证。</p><div class="nn no gp gr np nq"><a href="https://www.datadriveninvestor.com/2020/12/07/name-matching-techniques-with-python/" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab fo"><div class="ns ab nt cl cj nu"><h2 class="bd iu gy z fp nv fr fs nw fu fw is bi translated">使用Python |数据驱动投资者的名称匹配技术</h2><div class="nx l"><h3 class="bd b gy z fp nv fr fs nw fu fw dk translated">我们确实面临很多情况，我们必须匹配一个有很多变体的单词。这可能是因为错别字…</h3></div><div class="ny l"><p class="bd b dl z fp nv fr fs nw fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ks nq"/></div></div></a></div><p id="f737" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">初始化后，我们将使用拟合方法训练CNN模型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/ed9a00b7069be976518bc99cb2c7225a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*u5bNi4IliAJI__k5TRw2Bw.png"/></div></figure><p id="14e9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">结果显示了训练损失、验证损失、验证准确度和每个历元的持续时间。该模型似乎工作得很好，因为在两个损失之间有微小的差异。通过模型“net”的属性<strong class="la iu"> history </strong>获得的下图也很明显。基本上，它是一个包含关于模型训练的信息的字典列表:对于每个时期，都有一个元素，同样包含每批的字典列表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/ae04816eee45f97336fa9493e411fbb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ng8PBpciA4UEModM3WWylA.png"/></div></div></figure><h1 id="d121" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">第五步:预测</h1><p id="51a2" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">我们将对测试数据进行预测，并使用sklearn库中的函数predict和accuracy_score来评估预测的准确性。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/3bd4dc04d8b2c37495efe51d95650c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*KOZFqVH_Pqtm_B1oc5E-0A.png"/></div></figure><p id="934a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于一个简单的网络来说，99%的准确率已经很不错了。另一种评估模型性能的方法是<strong class="la iu">混淆矩阵</strong>，它将实际类别与预测类别进行比较。在对角线中，有预测标签等于真实标签的点的数量，而在非对角线中有错误分类的元素。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/2b73496640ac7ab7cb58e01b24643874.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/format:webp/1*gi2Ylr0FQx1ZRJnKoiSeVQ.png"/></div></figure><p id="56b9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">即使整体准确率达到99%，仍然有很多分类错误的数据。特别是，4级被错误地分类为9级达9次。出于这个原因，我们将尝试K-Fold交叉验证，以确保避免过度拟合和不松散的推广。</p><h1 id="4eaf" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">第六步:通过K倍交叉验证评估分数</h1><p id="7878" class="pw-post-body-paragraph ky kz it la b lb mq ju ld le mr jx lg lh ms lj lk ll mt ln lo lp mu lr ls lt im bi translated">在评估之前，我们需要使用类<strong class="la iu"> SliceDataset </strong>使训练集可切片，该类<strong class="la iu"> </strong>包装torch数据集以使其与sklearn一起工作。我们将使用sklearn库的函数<code class="fe mv mw mx my b"><strong class="la iu">cross_val_score</strong></code> ( <em class="oj"> estimator </em>，<em class="oj"> X </em>，<em class="oj"> y=None </em>，<em class="oj"> cv=None </em>)来评估使用K=5倍进行K倍交叉验证所获得的验证精度。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/c6588d1531de5c59430e36bc2bfda3e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*2dLPIuvhq0pGQBf5vWpq8g.png"/></div></figure><p id="0934" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">结果与前两个折叠相关，但是您也应该看到像这样的其他三个表。</p><p id="9776" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是每个折叠的平均精度和所有折叠的平均精度:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mo mp l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/71b75234c22a14bfd407211c4ceea5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lM7URAmQudAslZmVydOm5Q.png"/></div></div></figure><p id="4fdc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">即使计算量很大，也需要K重交叉验证来评估模型而不会过度拟合。精度仍然很高，因此这意味着该模型在任何重采样过程中都工作良好。</p></div><div class="ab cl om on hx oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="im in io ip iq"><p id="6f19" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">恭喜你！您使用Skorch库构建了您的分类器。我希望你能更好地理解它是如何工作的。Skorch是一个非常有用的工具，它以简单易行的方式训练和评估Pytorch模型。代码在<a class="ae mn" href="https://github.com/eugeniaring/Pytorch-tutorial/blob/main/mnist-skorch.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>里。</p><p id="1da3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">参考文献:</strong></p><p id="c181" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">[1]<a class="ae mn" href="https://skorch.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">https://skorch.readthedocs.io/en/stable/index.html</a></p><p id="cb39" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae mn" href="https://www.youtube.com/watch?v=Qbu_DCBjVEk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=Qbu_DCBjVEk</a></p><p id="79b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">访问专家视图— </strong> <a class="ae mn" href="https://datadriveninvestor.com/ddi-intel" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">订阅DDI英特尔</strong> </a></p></div></div>    
</body>
</html>