<html>
<head>
<title>Using Scikit-learn on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云平台上使用Scikit-learn</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/using-scikit-learn-on-google-cloud-platform-82ab2e06eeb9?source=collection_archive---------1-----------------------#2020-01-14">https://medium.datadriveninvestor.com/using-scikit-learn-on-google-cloud-platform-82ab2e06eeb9?source=collection_archive---------1-----------------------#2020-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ef8dd04bc016c54f5b8465e6dc1ec81c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VeNo6EPAJZ3u6pDZ"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mitchell Luo</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="def3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了大数据，如果不花费大量时间，很难在本地计算机上训练机器学习模型。正因为如此，我使用了谷歌云平台(GCP)。GCP的人工智能平台管理云中的计算资源，以训练TensorFlow、scikit-learn和XGBoost模型。您创建一个培训应用程序(本地或云上)并提交一个培训作业。AI平台训练服务将其输出写入您的云存储桶，并创建日志。本博客将解释如何在GCP的人工智能平台上使用scikit-learn。</p><h1 id="7687" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">开始之前..</h1><ol class=""><li id="0ba3" class="lz ma iq kf b kg mb kk mc ko md ks me kw mf la mg mh mi mj bi translated">如果你还没有谷歌云项目,那就创建一个<a class="ae kc" href="https://console.cloud.google.com/projectselector2/home/dashboard?_ga=2.45381604.-1992316389.1574440320" rel="noopener ugc nofollow" target="_blank">。您可以使用现有的。</a></li><li id="7b50" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">激活<a class="ae kc" href="https://console.cloud.google.com/flows/enableapi?apiid=ml.googleapis.com,compute_component&amp;_ga=2.45381604.-1992316389.1574440320" rel="noopener ugc nofollow" target="_blank"> AI平台API </a>。</li><li id="56fd" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">如果你还没有一个<a class="ae kc" href="https://console.cloud.google.com/storage/create-bucket" rel="noopener ugc nofollow" target="_blank">云存储桶</a>，那就设置好吧。确保铲斗与您将训练的模型位于同一个项目中。</li></ol></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="9098" class="lb lc iq bd ld le mw lg lh li mx lk ll lm my lo lp lq mz ls lt lu na lw lx ly bi translated">如何在AI平台上训练你的模型</h1><ol class=""><li id="0dd6" class="lz ma iq kf b kg mb kk mc ko md ks me kw mf la mg mh mi mj bi translated">创建您的Python模型文件-用于从云存储桶下载数据并在训练模型后将模型导出并保存到云存储的代码</li><li id="2d18" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">准备培训申请包</li><li id="9394" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la mg mh mi mj bi translated">提交培训作业</li></ol><h2 id="6a46" class="nb lc iq bd ld nc nd dn lh ne nf dp ll ko ng nh lp ks ni nj lt kw nk nl lx nm bi translated">创建Python模型文件</h2><p id="5a99" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">你可以在本地或者通过AI平台笔记本在云上完成这项工作。以下步骤针对AI平台笔记本。</p><p id="176f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="ae kc" href="https://console.cloud.google.com/ai-platform/notebooks/instances" rel="noopener ugc nofollow" target="_blank"> AI平台笔记本</a>下，点击新建实例，然后Python，为scikit-learn训练创建一个笔记本(可以为R、TensorFlow、XGBoost创建一个)。</p><p id="d387" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建并启动实例后，您可以单击OPEN JUPYTERLAB并创建一个Jupyter笔记本。ipynb文件来编写您的Python模型文件。在接下来的部分中，我将分享我在项目中使用的代码。我用&lt; &gt;表示必须根据你的项目和桶进行修改的区域。</p><p id="d97c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置环境变量:</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="cd1c" class="nb lc iq nv b gy nz oa l ob oc">%env PROJECT_ID &lt;project_id&gt;<br/>%env BUCKET_ID &lt;bucket_name&gt;<br/>%env JOB_DIR gs://&lt;bucket_id&gt;/scikit_learn_job_dir<br/>%env REGION us-east4</span><span id="5dcf" class="nb lc iq nv b gy od oa l ob oc">%env TRAINER_PACKAGE_PATH ./hp_tuning<br/>%env MAIN_TRAINER_MODULE hp_tuning.train<br/>%env RUNTIME_VERSION 1.9<br/>%env PYTHON_VERSION 3.5<br/>%env HPTUNING_CONFIG hptuning_config.yaml</span><span id="aa28" class="nb lc iq nv b gy od oa l ob oc">mkdir hp_tuning</span></pre><p id="9de0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导入包</p><ul class=""><li id="dadf" class="lz ma iq kf b kg kh kk kl ko oe ks of kw og la oh mh mi mj bi translated">我在这个项目中使用了RandomForestRegressor。你可以导入其他库(SVM，KNN，逻辑回归，XGBoost等。)取决于您使用的型号。</li></ul><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="0510" class="nb lc iq nv b gy nz oa l ob oc">%%writefile ./hp_tuning/train.py<br/>#!/usr/bin/env python</span><span id="8466" class="nb lc iq nv b gy od oa l ob oc">import argparse<br/>import datetime<br/>import os<br/>import sys<br/>import pandas as pd<br/>import subprocess</span><span id="9ab3" class="nb lc iq nv b gy od oa l ob oc">from google.cloud import storage<br/>import hypertune</span><span id="5900" class="nb lc iq nv b gy od oa l ob oc">from sklearn.externals import joblib<br/>from sklearn.preprocessing import LabelEncoder<br/>from sklearn.ensemble import RandomForestRegressor<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.metrics import r2_score</span></pre><p id="05da" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">建立要优化的超参数(如果您不打算优化您的模型，可以省略这一部分。</p><ul class=""><li id="5b0a" class="lz ma iq kf b kg kh kk kl ko oe ks of kw og la oh mh mi mj bi translated">您可以使用或多或少的超参数进行优化。</li></ul><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="c803" class="nb lc iq nv b gy nz oa l ob oc">%%writefile -a ./hp_tuning/train.py</span><span id="a418" class="nb lc iq nv b gy od oa l ob oc">parser = argparse.ArgumentParser()<br/>parser.add_argument(<br/>        '--job-dir',<br/>        help='GCS location to write checkpoints and export models',<br/>        required=True<br/>)<br/>parser.add_argument(<br/>        '--maxDepth',<br/>        help='Depth of trees',<br/>        type=int,<br/>        default=None<br/>)<br/>parser.add_argument(<br/>        '--nEstimators',<br/>        help='Number of trees',<br/>        type=int,<br/>        default=10<br/>)<br/>parser.add_argument(<br/>        '--minSamplesSplit',<br/>        help='Number of samples to split',<br/>        type=int,<br/>        default=2<br/>)<br/>parser.add_argument(<br/>        '--minSamplesLeaf',<br/>        help='Number of samples at leaf node',<br/>        type=int,<br/>        default=1<br/>)<br/>parser.add_argument(<br/>        '--maxFeatures',<br/>        help='Number of features',<br/>        type=str,<br/>        default='auto'<br/>)<br/>    <br/>args = parser.parse_args()</span></pre><p id="789e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导入数据并为培训做准备</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="ae60" class="nb lc iq nv b gy nz oa l ob oc">%%writefile -a ./hp_tuning/train.py</span><span id="7a8f" class="nb lc iq nv b gy od oa l ob oc">data_filename = '&lt;filename&gt;'<br/>data_dir = 'gs://&lt;bucket_name&gt;'</span><span id="d99f" class="nb lc iq nv b gy od oa l ob oc">subprocess.check_call(['gsutil', 'cp', os.path.join(data_dir, data_filename), data_filename], stderr=sys.stdout)</span><span id="8043" class="nb lc iq nv b gy od oa l ob oc">cols = list(pd.read_csv(data_filename, nrows=1))<br/>training_data = pd.read_csv(data_filename, usecols =[i for i in cols if i != '&lt;target_column&gt;'])</span><span id="05de" class="nb lc iq nv b gy od oa l ob oc"># Remove the column we are trying to predict from our features list<br/># Convert the DataFrame to a lists of lists<br/>X = training_data.drop('&lt;target_column&gt;', axis=1)</span><span id="001e" class="nb lc iq nv b gy od oa l ob oc"># Encode categorical variables<br/>for col in X.columns:<br/>    if X[col].dtype == 'O':<br/>        le = LabelEncoder()<br/>        le.fit(list(X[col].astype(str).values))<br/>        X[col] = le.transform(list(X[col].astype(str).values))<br/>        <br/>X = X.values.tolist()</span><span id="5b12" class="nb lc iq nv b gy od oa l ob oc"># Create our training labels list, convert the DataFrame to a lists of lists<br/>y = training_data['&lt;target_column&gt;'].values.tolist()</span><span id="7d9a" class="nb lc iq nv b gy od oa l ob oc">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)</span></pre><p id="d1e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建模型</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="064d" class="nb lc iq nv b gy nz oa l ob oc">%%writefile -a ./hp_tuning/train.py</span><span id="d0d8" class="nb lc iq nv b gy od oa l ob oc"># Create the regressor.<br/># Here is where we set the variables used during HP Tuning from<br/># the parameters passed into the python script<br/>rf_regressor = RandomForestRegressor(max_depth=args.maxDepth, n_estimators=args.nEstimators, min_samples_split=args.minSamplesSplit, min_samples_leaf=args.minSamplesLeaf, max_features=args.maxFeatures, random_state=220)</span><span id="6197" class="nb lc iq nv b gy od oa l ob oc"># Transform the features and fit them to the regressor<br/>rf_regressor.fit(X_train, y_train)</span></pre><p id="70b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">评估模型</p><ul class=""><li id="cd7a" class="lz ma iq kf b kg kh kk kl ko oe ks of kw og la oh mh mi mj bi translated">我使用r2分数来评估我的回归模型。您可以用r2_score替换您想要使用的任何其他<a class="ae kc" href="https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics" rel="noopener ugc nofollow" target="_blank">评估指标</a>。</li><li id="61ae" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la oh mh mi mj bi translated">如果不打算调优超参数，可以省略最后两部分</li></ul><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="0e9d" class="nb lc iq nv b gy nz oa l ob oc">%%writefile -a ./hp_tuning/train.py</span><span id="3c69" class="nb lc iq nv b gy od oa l ob oc"># Calculate the mean accuracy on the given test data and labels.<br/>score = rf_regressor.score(X_test, y_test)</span><span id="3653" class="nb lc iq nv b gy od oa l ob oc"># Create metric for hyperparameter tuning<br/>y_pred = rf_regressor.predict(X_test)<br/>r2 = r2_score(y_test, y_pred)</span><span id="9eb5" class="nb lc iq nv b gy od oa l ob oc">hpt = hypertune.HyperTune()<br/>hpt.report_hyperparameter_tuning_metric(<br/>        hyperparameter_metric_tag='r2',<br/>        metric_value=r2,<br/>        global_step=0)</span></pre><p id="f8ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将模型导出到Google Cloud</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="f7b2" class="nb lc iq nv b gy nz oa l ob oc">%%writefile -a ./hp_tuning/train.py</span><span id="0382" class="nb lc iq nv b gy od oa l ob oc"># Export the model to a file<br/>model_filename = 'rf_model.joblib'<br/>joblib.dump(rf_regressor, model_filename)</span><span id="ae24" class="nb lc iq nv b gy od oa l ob oc">job_dir =  args.job_dir.replace('gs://', '')<br/># Get the Bucket Id<br/>bucket_id = job_dir.split('/')[0]<br/># Get the path<br/>bucket_path = job_dir.lstrip('{}/'.format(bucket_id))</span><span id="a494" class="nb lc iq nv b gy od oa l ob oc"># Upload the model to GCS<br/>bucket = storage.Client().bucket(bucket_id)<br/>blob = bucket.blob('{}/{}'.format(<br/>    bucket_path,<br/>    model_filename))<br/>blob.upload_from_filename(model_filename)</span></pre><h2 id="288e" class="nb lc iq bd ld nc nd dn lh ne nf dp ll ko ng nh lp ks ni nj lt kw nk nl lx nm bi translated">创建培训应用程序包</h2><p id="a4ee" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">初始化文件</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="c7cd" class="nb lc iq nv b gy nz oa l ob oc">%%writefile ./hp_tuning/__init__.py<br/>#!/usr/bin/env python</span></pre><p id="37d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">超参数包</p><p id="70c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">*您可以调整同时运行的试验次数(maxParallelTrials)和运行的最大试验次数(maxTrials)。</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="608d" class="nb lc iq nv b gy nz oa l ob oc">%%writefile ./hptuning_config.yaml<br/>#!/usr/bin/env python</span><span id="654d" class="nb lc iq nv b gy od oa l ob oc"># hyperparam.yaml<br/>trainingInput:<br/>  hyperparameters:<br/>    goal: MAXIMIZE<br/>    hyperparameterMetricTag: 'r2'<br/>    maxTrials: 30<br/>    maxParallelTrials: 5<br/>    enableTrialEarlyStopping: True<br/>    params:<br/>      - parameterName: maxDepth<br/>        type: DISCRETE<br/>        discreteValues: [5.0, 8.0, 15.0, 25.0, 30.0]<br/>      - parameterName: nEstimators<br/>        type: DISCRETE<br/>        discreteValues: [120.0, 300.0, 500.0, 800.0, 1200.0]<br/>      - parameterName: minSamplesSplit<br/>        type: DISCRETE<br/>        discreteValues: [2.0, 5.0, 10.0, 15.0, 100.0]<br/>      - parameterName: minSamplesLeaf<br/>        type: DISCRETE<br/>        discreteValues: [2.0, 5.0, 10.0]<br/>      - parameterName: maxFeatures<br/>        type: CATEGORICAL<br/>        categoricalValues: ['log2', 'sqrt']</span></pre><p id="a4ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置培训</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="d33e" class="nb lc iq nv b gy nz oa l ob oc">%%writefile ./setup.py<br/>#!/usr/bin/env python</span><span id="9d93" class="nb lc iq nv b gy od oa l ob oc">from setuptools import find_packages<br/>from setuptools import setup</span><span id="8491" class="nb lc iq nv b gy od oa l ob oc">REQUIRED_PACKAGES = ['cloudml-hypertune']</span><span id="f17d" class="nb lc iq nv b gy od oa l ob oc">setup(<br/>    name='hp_tuning',<br/>    version='0.1',<br/>    install_requires=REQUIRED_PACKAGES,<br/>    packages=find_packages(),<br/>    include_package_data=True,<br/>    description='sklearn HP tuning training application'<br/>)</span></pre><h2 id="89c3" class="nb lc iq bd ld nc nd dn lh ne nf dp ll ko ng nh lp ks ni nj lt kw nk nl lx nm bi translated">提交培训工作</h2><p id="931f" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">在与上面相同的笔记本中运行以下代码。</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="8588" class="nb lc iq nv b gy nz oa l ob oc">! gcloud ai-platform jobs submit training hp_tuning_$(date +"%Y%m%d_%H%M%S") \<br/>  --job-dir $JOB_DIR \<br/>  --package-path $TRAINER_PACKAGE_PATH \<br/>  --module-name $MAIN_TRAINER_MODULE \<br/>  --region $REGION \<br/>  --runtime-version=$RUNTIME_VERSION \<br/>  --python-version=$PYTHON_VERSION \<br/>  --scale-tier BASIC \<br/>  --config $HPTUNING_CONFIG</span></pre><p id="ad08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该会看到以下输出。</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="0e00" class="nb lc iq nv b gy nz oa l ob oc">Job [hp_tuning_[DATE]_[TIME]] submitted successfully.<br/>Your job is still active. You may view the status of your job with the command<br/><br/>  $ gcloud ai-platform jobs describe hp_tuning_[DATE]_[TIME]<br/><br/>or continue streaming the logs with the command<br/><br/>  $ gcloud ai-platform jobs stream-logs hp_tuning_[DATE]_[TIME]<br/>jobId: hp_tuning_[DATE]_[TIME]<br/>state: QUEUED</span></pre></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="20aa" class="lb lc iq bd ld le mw lg lh li mx lk ll lm my lo lp lq mz ls lt lu na lw lx ly bi translated">检查培训工作的进度</h1><p id="ae63" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">提交培训工作后，您可以进入您的AI平台中的<a class="ae kc" href="https://console.cloud.google.com/mlengine/jobs?_ga=2.116317126.-1992316389.1574440320" rel="noopener ugc nofollow" target="_blank">工作</a>部分。它将向您显示所有已提交的作业。</p><ul class=""><li id="6787" class="lz ma iq kf b kg kh kk kl ko oe ks of kw og la oh mh mi mj bi translated">加载符号表示作业当前正在执行</li><li id="7b8c" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la oh mh mi mj bi translated">红色感叹号表示作业因错误而停止</li><li id="2050" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la oh mh mi mj bi translated">灰色停止标志表示作业已被取消。</li><li id="e963" class="lz ma iq kf b kg mk kk ml ko mm ks mn kw mo la oh mh mi mj bi translated">绿色复选标记表示作业已经完成。</li></ul><p id="529d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以单击作业ID来查看作业的详细信息、正在执行的进度或结果(最终结果或停止的原因)。</p><div class="oi oj gp gr ok ol"><a href="https://cloud.google.com/ml-engine/docs/scikit/training-scikit-learn" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd ir gy z fp oq fr fs or fu fw ip bi translated">使用scikit进行培训-在人工智能平台上学习|人工智能平台|谷歌云</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">AI平台训练服务管理云中的计算资源来训练你的模型。本页描述了…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">cloud.google.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz jw ol"/></div></div></a></div></div></div>    
</body>
</html>