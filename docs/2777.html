<html>
<head>
<title>Optimise Profit With the Expected Value Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用预期价值框架优化利润</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/optimise-profit-with-the-expected-value-framework-7378ead9089e?source=collection_archive---------2-----------------------#2020-05-15">https://medium.datadriveninvestor.com/optimise-profit-with-the-expected-value-framework-7378ead9089e?source=collection_archive---------2-----------------------#2020-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="49d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者不坚持默认阈值@ Max F1有多重要</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/826bbedb893f097a2425bd94839cefea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y8segp53m5Pn4b2mvexw8Q.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Photo by <a class="ae le" href="https://unsplash.com/@suricattaontheway" rel="noopener ugc nofollow" target="_blank">David Sury</a> on <a class="ae le" href="https://unsplash.com/@dmey503?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><blockquote class="lf lg lh"><p id="6ed4" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated">在这篇文章中，我采用了一个随机森林模型，并运行了一个多客户利润优化模型，该模型揭示了一个潜在的额外预期利润，即每个客户有近1.7%的额外利润。</p></blockquote><p id="2c3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我介绍了关键概念，如<strong class="js iu">截止值和F1分数</strong>以及<strong class="js iu">精确回忆权衡</strong>，并展示了<strong class="js iu">不坚持许多机器学习建模平台默认选择的阈值@ Max F1 </strong>的重要性。</p><h1 id="835a" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">概观</h1><p id="d94a" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">在当今时代，利用数据了解客户行为驱动因素的企业拥有真正的竞争优势。通过有效地分析客户层面的数据，组织可以显著提高其在市场中的表现，并将精力集中在那些更有可能参与的客户身上。</p><p id="d085" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">梳理这种洞察力的一种经过试验和测试的方法是<a class="ae le" href="https://en.wikipedia.org/wiki/Predictive_modelling" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">倾向建模</strong> </a>，它结合了<strong class="js iu">客户的人口统计数据</strong>(年龄、种族、宗教、性别、家庭规模、种族、收入、教育水平)<strong class="js iu">心理图</strong>(社会阶层、生活方式和性格特征)<strong class="js iu">参与度</strong>(打开的电子邮件、点击的电子邮件、移动应用上的搜索、网页停留时间等)。)、<strong class="js iu">用户体验</strong>(客户服务电话和电子邮件等待时间、退款次数、平均运送时间)<strong class="js iu">用户行为</strong>(不同时间尺度上的购买价值、最近一次购买后的天数、报价和转换之间的时间等)。)来估计某个客户档案执行某类行为(例如购买产品)的可能性。</p><div class="mp mq gp gr mr ms"><a href="https://www.datadriveninvestor.com/2020/02/19/five-data-science-and-machine-learning-trends-that-will-define-job-prospects-in-2020/" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab fo"><div class="mu ab mv cl cj mw"><h2 class="bd iu gy z fp mx fr fs my fu fw is bi translated">将定义2020年就业前景的五大数据科学和机器学习趋势|数据驱动…</h2><div class="mz l"><h3 class="bd b gy z fp mx fr fs my fu fw dk translated">数据科学和ML是2019年最受关注的趋势之一，毫无疑问，它们将继续发展…</h3></div><div class="na l"><p class="bd b dl z fp mx fr fs my fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng ky ms"/></div></div></a></div><p id="f7ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦你了解了某个客户<em class="li">与你的品牌</em>、<em class="li">互动、购买产品</em>或<em class="li">注册服务</em>的可能性，你就可以利用这些信息创造情景，无论是最小化<strong class="js iu">营销支出</strong>，最大化<strong class="js iu">收购目标</strong>，还是优化<strong class="js iu">电子邮件发送频率</strong>或<strong class="js iu">折扣深度</strong>。</p><h1 id="77d3" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">优化预期利润</h1><p id="b391" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">在我开始之前，有几个<strong class="js iu">内务任务</strong>需要“设置工作场景”,还有几个<strong class="js iu">重要概念</strong>需要介绍:</p><ul class=""><li id="cb4d" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated"><strong class="js iu">阈值和F1分数</strong></li><li id="1d8b" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">精确和召回</strong>以及它们的<strong class="js iu">权衡</strong></li></ul><h1 id="1a67" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">一些家务</h1><p id="3a55" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">首先，这是我分析所需的库</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="5f71" class="oa ln it nw b gy ob oc l od oe">library(tidyverse)<br/>library(h2o)<br/>library(skimr)<br/>library(knitr)</span></pre><p id="3363" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我加载在<a class="ae le" href="https://diegousai.io/2020/01/propensity-modelling-data-preparation/" rel="noopener ugc nofollow" target="_blank">探索性分析</a>结束时保存的清理后的数据</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="4872" class="oa ln it nw b gy ob oc l od oe"># Loading clensed data<br/>data_final &lt;- <br/>readRDS(file = "https://raw.githubusercontent.com/DiegoUsaiUK/Propensity_Modelling/master/01_data/data_final.rds")</span></pre><p id="bc0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由此，我用<code class="fe of og oh nw b">rsample</code>创建了一个随机的训练和验证集，并将它们保存为<code class="fe of og oh nw b">train_tbl</code>和<code class="fe of og oh nw b">test_tbl</code>。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="47ba" class="oa ln it nw b gy ob oc l od oe">set.seed(seed = 1975) </span><span id="6616" class="oa ln it nw b gy oi oc l od oe">train_test_split &lt;-<br/>  rsample::initial_split(<br/>    data = data_final,     <br/>    prop = 0.80   <br/>  ) </span><span id="76da" class="oa ln it nw b gy oi oc l od oe">train_tbl &lt;- train_test_split %&gt;% rsample::training() <br/>test_tbl  &lt;- train_test_split %&gt;% rsample::testing()</span></pre><p id="c782" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我还需要启动一个<strong class="js iu"> h2o集群</strong>，关闭进度条并加载最终的随机森林模型</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="4e7d" class="oa ln it nw b gy ob oc l od oe"># initialize h2o session and switch off progress bar<br/>h2o.no_progress() <br/>h2o.init(max_mem_size = "16G")</span><span id="2b28" class="oa ln it nw b gy oi oc l od oe"><br/>## H2O is not running yet, starting it now...<br/>## <br/>## Note:  In case of errors look at the following log files:<br/>##     C:\Users\LENOVO\AppData\Local   \Temp\RtmpkRk5j9/h2o_LENOVO_started_from_r.out<br/>##     C:\Users\LENOVO\AppData\Local\Temp\RtmpkRk5j9/h2o_LENOVO_started_from_r.err<br/>## <br/>## <br/>## Starting H2O JVM and connecting:  Connection successful!<br/>## <br/>## R is connected to the H2O cluster: <br/>##     H2O cluster uptime:         3 seconds 172 milliseconds <br/>##     H2O cluster timezone:       Europe/Berlin <br/>##     H2O data parsing timezone:  UTC <br/>##     H2O cluster version:        3.28.0.4 <br/>##     H2O cluster version age:    2 months and 4 days  <br/>##     H2O cluster name:           H2O_started_from_R_LENOVO_frm928 <br/>##     H2O cluster total nodes:    1 <br/>##     H2O cluster total memory:   14.21 GB <br/>##     H2O cluster total cores:    4 <br/>##     H2O cluster allowed cores:  4 <br/>##     H2O cluster healthy:        TRUE <br/>##     H2O Connection ip:          localhost <br/>##     H2O Connection port:        54321 <br/>##     H2O Connection proxy:       NA <br/>##     H2O Internal Security:      FALSE <br/>##     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 <br/>##     R Version:                  R version 3.6.3 (2020-02-29)</span><span id="5cf5" class="oa ln it nw b gy oi oc l od oe">drf_final &lt;- <br/>   h2o.loadModel(path = "https://raw.githubusercontent.com<br/>                        /DiegoUsaiUK/Propensity_Modelling/<br/>                         master/03_models/drf_grid_final_model_1")</span></pre><p id="7cd3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要了解我是如何得到这个特别的模型的，你可以参考我网页上的这篇文章</p><h1 id="e862" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">阈值和F1分数</h1><p id="438f" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">该模型试图回答的问题是"<em class="li">该客户是否在直接营销活动后注册了定期存款？</em>”而截止值(也称为阈值)是将模型预测分为<code class="fe of og oh nw b">Yes</code>和<code class="fe of og oh nw b">No</code>的值。</p><p id="573c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了说明这一点，我首先通过将<code class="fe of og oh nw b">test_tbl</code>数据集传递给<code class="fe of og oh nw b">h2o.performance</code>函数来计算一些预测。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="06ce" class="oa ln it nw b gy ob oc l od oe">perf_drf_final &lt;- <br/>     h2o.performance(drf_final, newdata = test_tbl %&gt;% as.h2o()) </span><span id="36ac" class="oa ln it nw b gy oi oc l od oe"><br/>perf_drf_final@metrics$max_criteria_and_metric_scores</span><span id="b2dc" class="oa ln it nw b gy oi oc l od oe">## Maximum Metrics: Maximum metrics at their respective thresholds<br/>##                         metric threshold       value idx<br/>## 1                       max f1  0.189521    0.508408 216<br/>## 2                       max f2  0.108236    0.560213 263<br/>## 3                 max f0point5  0.342855    0.507884 143<br/>## 4                 max accuracy  0.483760    0.903848  87<br/>## 5                max precision  0.770798    0.854167  22<br/>## 6                   max recall  0.006315    1.000000 399<br/>## 7              max specificity  0.930294    0.999864   0<br/>## 8             max absolute_mcc  0.189521    0.444547 216<br/>## 9   max min_per_class_accuracy  0.071639    0.721231 300<br/>## 10 max mean_per_class_accuracy  0.108236    0.755047 263<br/>## 11                     max tns  0.930294 7342.000000   0<br/>## 12                     max fns  0.930294  894.000000   0<br/>## 13                     max fps  0.006315 7343.000000 399<br/>## 14                     max tps  0.006315  894.000000 399<br/>## 15                     max tnr  0.930294    0.999864   0<br/>## 16                     max fnr  0.930294    1.000000   0<br/>## 17                     max fpr  0.006315    1.000000 399<br/>## 18                     max tpr  0.006315    1.000000 399</span></pre><p id="94d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与许多其他机器学习建模平台一样，<strong class="js iu"> h2o </strong>使用与最大<a class="ae le" href="https://en.wikipedia.org/wiki/F1_score" rel="noopener ugc nofollow" target="_blank"> F1分数</a>相关联的阈值，它只不过是精确度和召回率之间的加权平均值。在这种情况下，最大F1的阈值为<strong class="js iu"> 0.190 </strong>。</p><p id="2bc4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我使用<code class="fe of og oh nw b">h2o.predict</code>函数通过测试集进行预测。预测输出有三列:实际模型预测(<code class="fe of og oh nw b">predict</code>)和与该预测相关的概率(<code class="fe of og oh nw b">p0</code>和<code class="fe of og oh nw b">p1</code>，分别对应于<code class="fe of og oh nw b">No</code>和<code class="fe of og oh nw b">Yes</code>)。如您所见，与当前截止相关的<code class="fe of og oh nw b">p1</code>概率大约为<strong class="js iu"> 0.0646 </strong>。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="72d6" class="oa ln it nw b gy ob oc l od oe">drf_predict &lt;- <br/>     h2o.predict(drf_final, newdata = test_tbl %&gt;% as.h2o())<!-- --> </span><span id="acfc" class="oa ln it nw b gy oi oc l od oe"><br/># I converte to a tibble for ease of use<br/>as_tibble(drf_predict) %&gt;%<br/>  arrange(p0) %&gt;% <br/>  slice(3088:3093) %&gt;%<br/>  kable()</span><span id="f4c8" class="oa ln it nw b gy oi oc l od oe">predict      p0            p1 <br/>   1     0.9352865     0.0647135 <br/>   1     0.9352865     0.0647135 <br/>   1     0.9352865     0.0647135 <br/>   0     0.9354453     0.0645547 <br/>   0     0.9354453     0.0645547 <br/>   0     0.9354453     0.0645547</span></pre><p id="bca8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，<em class="li"> F1分数</em>只是识别截止值的一种方式。根据我们的目标，我们也可以决定使用一个阈值，例如，最大化精度或召回率。在商业设置中，预先选择的阈值@ Max F1不一定是最佳选择:输入<strong class="js iu">精度并调用</strong>！</p><h1 id="a4e6" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">精确度和召回率</h1><p id="befb" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated"><strong class="js iu"> Precision </strong>显示模型对误报的敏感程度(即预测客户正在<em class="li">订购</em>，而他/她实际上没有订购】,而<strong class="js iu"> Recall </strong>查看模型对误报的敏感程度(即预测客户没有订购<em class="li">而他/她实际上将要订购</em>)。</p><p id="77fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些指标<strong class="js iu">与商业环境</strong>非常相关，因为组织对准确预测哪些客户真正有可能<code class="fe of og oh nw b">subscribe</code> <strong class="js iu">(高精度)</strong>特别感兴趣，以便他们可以针对这些客户制定广告策略和其他激励措施。同时，他们希望尽量减少对被错误归类为<code class="fe of og oh nw b">subscribing</code> <strong class="js iu">(高召回)</strong>的客户的努力，这些客户反而不太可能注册。</p><p id="dfa5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，从下面的图表中可以看出，当精度变高时，召回率变低，反之亦然。这通常被称为<strong class="js iu">精确-召回权衡</strong>。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="e54d" class="oa ln it nw b gy ob oc l od oe">perf_drf_final %&gt;%<br/>    h2o.metric() %&gt;%<br/>    as_tibble() %&gt;%</span><span id="3d5b" class="oa ln it nw b gy oi oc l od oe">    ggplot(aes(x = threshold)) +<br/>    geom_line(aes(y = precision), colour = "darkblue", size = 1) +<br/>    geom_line(aes(y = recall), colour = "red", size = 1) +<br/>    geom_vline(xintercept = <br/>         h2o.find_threshold_by_max_metric(perf_drf_final, "f1")) +<br/>    theme_minimal() +<br/>    labs(<br/>         title    = 'Precision and Recall with Cut-off @ Max F1',<br/>         subtitle = 'Distributed Random Forest Model',<br/>         x        = 'With threshold @ Max F1, probability above<br/>                      0.0646 predicts subscribed = "Yes"',<br/>         y        = 'Precision and Recall Values'<br/>         ) +<br/>    theme(plot.title    = element_text(hjust = 0.4),<br/>          plot.subtitle = element_text(hjust = 0.4)) +<br/>  <br/>  # p &lt; 0.0646<br/>   annotate("text", <br/>            x      = 0.065, <br/>            y      = 0.50, <br/>            size   = 3, <br/>            colour = "darkgreen", <br/>            label  = 'p1 &lt; 0.0646 "No"\nNot Subscribed') +<br/>    <br/>  # p = 0.0646<br/>   geom_vline(xintercept = 0.190, <br/>              size       = 0.8, <br/>              colour     = "orange") +<br/>   annotate("text", <br/>            x      = 0.19, <br/>            y      = 0.80, <br/>            size   = 3, <br/>            colour = "darkblue",<br/>            label  = 'p1 = 0.0646 \nCurrent Cut-off \n@ Max F1') +<br/>    <br/>  # p&gt; 0.0646<br/>   annotate("text", <br/>            x      = 0.5, <br/>            y      = 0.50, <br/>            size   = 3, <br/>            colour = "purple",<br/>            label  = 'p1 &gt; 0.0646 "Yes"\n Subscribed')</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oj"><img src="../Images/a3c9f81008766b2951f564881b86d555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Rkkw6C30MeqEgbmW.png"/></div></div></figure><p id="61a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了充分理解这种动态及其含义，让我们先来看看<strong class="js iu">截止零点</strong>和<strong class="js iu">截止一点</strong>，然后看看当您开始在两个位置之间移动阈值时会发生什么:</p><ul class=""><li id="9b0a" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">在<strong class="js iu">阈值为零</strong> ( <em class="li">最低精度，最高召回</em>)时，模型将每个客户分类为<code class="fe of og oh nw b">subscribed = Yes</code>。在这种情况下，你会<strong class="js iu">通过直接营销活动联系每一个客户</strong>，但也会浪费宝贵的资源，包括那些不太可能订阅的客户。很明显，这不是一个最佳策略，因为你会招致更高的总体采购成本</li><li id="e85b" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">相反，在<strong class="js iu">阈值一</strong> ( <em class="li">最高精度，最低召回</em>)模型告诉你没有人可能订阅，所以你应该<strong class="js iu">不联系任何人</strong>。这将为你节省大量的营销成本，但如果你通过直接营销将定期存款通知了那些已经订阅的客户，你将错过他们带来的额外收入。同样，这不是一个最优策略</li></ul><p id="19b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当移动到一个更高的阈值时，该模型对它归类为<code class="fe of og oh nw b">subscribed = Yes</code>的人变得更加“挑剔”。因此，你在联系谁的问题上变得更加保守(<strong class="js iu">精确度更高</strong>)并降低了你的采购成本，但同时你也增加了你接触不到潜在订户的机会(<strong class="js iu">召回率更低</strong>)，错过了潜在的收入。</p><p id="fbed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的关键问题是<strong class="js iu">你停在哪里？是否存在“最佳点”,如果有，你如何找到它？嗯，那完全取决于你想达到的目标。在下一部分，我将运行一个小优化，目标是<strong class="js iu">最大化利润</strong>。</strong></p><h1 id="b6b4" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">寻找最佳阈值</h1><p id="c79b" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">对于这个小优化，我正在实施一个<strong class="js iu">简单的利润最大化</strong>基于与获取新客户相关的一般成本和从所述获取中获得的利益。这可以发展到包括更复杂的场景，但这超出了本练习的范围。</p><p id="9ed1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了理解使用哪个临界值是最佳的，我们需要模拟与每个临界点相关的成本效益。这是一个源自<strong class="js iu">期望值框架</strong>的概念，参见<a class="ae le" href="https://www.goodreads.com/book/show/17912916-data-science-for-business" rel="noopener ugc nofollow" target="_blank"> <em class="li">商业数据科学</em> </a></p><p id="46fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此，我需要两件东西:</p><ul class=""><li id="aa0e" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated"><strong class="js iu">每个阈值的预期比率</strong> —这些可以从混淆矩阵中检索</li><li id="66db" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">每位客户的成本/收益</strong> —我需要根据假设进行模拟</li></ul><h1 id="23de" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">预期利率</h1><p id="8206" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">使用<code class="fe of og oh nw b">h2o.metric</code>可以方便地检索所有分界点的预期利率。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="b40d" class="oa ln it nw b gy ob oc l od oe"># Get expected rates by cutoff<br/>expected_rates &lt;- <br/>    h2o.metric(perf_drf_final) %&gt;%<br/>    as.tibble() %&gt;%<br/>    select(threshold, tpr, fpr, fnr, tnr)</span><span id="53ab" class="oa ln it nw b gy oi oc l od oe">expected_rates</span><span id="708d" class="oa ln it nw b gy oi oc l od oe">## # A tibble: 400 x 5<br/>##    threshold     tpr      fpr   fnr   tnr<br/>##        &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;<br/>##  1     0.930 0       0.000136 1     1.00 <br/>##  2     0.919 0.00112 0.000136 0.999 1.00 <br/>##  3     0.893 0.00112 0.000272 0.999 1.00 <br/>##  4     0.882 0.00224 0.000545 0.998 0.999<br/>##  5     0.879 0.00336 0.000545 0.997 0.999<br/>##  6     0.876 0.00671 0.000545 0.993 0.999<br/>##  7     0.873 0.00783 0.000545 0.992 0.999<br/>##  8     0.867 0.0123  0.000545 0.988 0.999<br/>##  9     0.857 0.0145  0.000545 0.985 0.999<br/>## 10     0.849 0.0157  0.000545 0.984 0.999<br/>## # ... with 390 more rows</span></pre><h1 id="e45f" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">成本/收益信息</h1><p id="cf1a" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">成本效益矩阵是对四个潜在结果的成本和效益的商业评估。为了创建这样一个矩阵，我必须对一个组织在开展<strong class="js iu">以广告为导向的采购活动</strong>时应该考虑的<strong class="js iu">费用和优势</strong>做出一些假设。</p><p id="9ce9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们假设每名客户出售定期存款的<strong class="js iu">成本为<strong class="js iu"> 30英镑。这包括执行直接营销活动(培训呼叫中心代表，为主动呼叫留出时间，等等。)和激励措施，如为另一种金融产品提供折扣，或加入提供福利和津贴的会员计划。一个银行组织在两种情况下会产生这种成本:当他们正确预测到一个客户会订阅时(<strong class="js iu">真阳性</strong>，TP)，以及当他们错误预测到一个客户会订阅时(<strong class="js iu">假阳性</strong>，FP)。</strong></strong></p><p id="993c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还假设向现有客户出售定期存款的<strong class="js iu">收入是每个客户</strong>80<strong class="js iu">。当模型预测客户会订阅并且他们确实订阅时，组织将保证这一收入流(<strong class="js iu">真正</strong>，TP)。</strong></p><p id="e6cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，还有<strong class="js iu">真否定</strong> (TN)场景，我们正确预测客户不会订阅。在这种情况下，我们不会花任何钱，但也不会获得任何收入。</p><p id="0a45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以下是场景的快速回顾:</p><ul class=""><li id="1726" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated"><strong class="js iu">真正</strong> (TP) — predict会订阅，他们确实这么做了:COST:-30；第80版</li><li id="f79e" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">误报</strong> (FP) — predict会订阅，而实际不会:COST:-30；版本0</li><li id="62f4" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">真阴性</strong> (TN) — predict不会订阅，他们实际上也没有:COST:0；版本0</li><li id="04f5" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">假阴性</strong> (FN) — predict不会订阅，但他们确实订阅了:COST:0；版本0</li></ul><p id="cdf2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我创建了一个函数，使用<em class="li">阳性案例</em> (p1)的概率以及与<em class="li">真阳性</em> (cb_tp)和<em class="li">假阳性</em> (cb_fp)相关的成本/收益来计算预期利润。这里不需要包括<em class="li">真阴性</em>或<em class="li">假阴性</em>，因为它们都是零。</p><p id="9fe1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我还包括之前创建的<strong class="js iu"> expected_rates </strong>数据帧，其中包含每个阈值的预期速率(400个阈值，范围从0到1)。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="5b5c" class="oa ln it nw b gy ob oc l od oe"># Function to calculate expected profit<br/>expected_profit_func &lt;- function(p1, cb_tp, cb_fp) {<br/>  <br/>    tibble(<br/>        p1    = p1,<br/>        cb_tp = cb_tp,<br/>        cb_fp = cb_fp<br/>        ) %&gt;%<br/>    <br/>        # add expected rates<br/>        mutate(expected_rates = list(expected_rates)) %&gt;%<br/>               unnest() %&gt;%<br/>    <br/>        # calculate the expected profit<br/>        mutate(<br/>            expected_profit =   p1    * (tpr * cb_tp) + <br/>                             (1 - p1) * (fpr * cb_fp)<br/>        ) %&gt;%<br/>        select(threshold, expected_profit)<br/>}</span></pre><h1 id="a76e" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">多客户优化</h1><p id="9590" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">现在为了理解多客户动态是如何工作的，我创建了一个<strong class="js iu">假设的10个客户群</strong>来测试我的功能。这是一个<strong class="js iu">简化的</strong>视图，因为我将<strong class="js iu">相同的成本和收入结构应用于所有客户</strong>，但是成本/收益框架可以针对单个客户进行定制，以反映他们单独的产品和服务水平设置，并且可以轻松调整流程，以针对不同的KPI进行优化(如<em class="li">净利润</em>、<em class="li"> CLV </em>、<em class="li">订阅数量</em>等)。)</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="ba27" class="oa ln it nw b gy ob oc l od oe"># Ten Hypothetical Customers <br/>ten_cust &lt;- tribble(<br/>    ~"cust",   ~"p1",  ~"cb_tp",  ~"cb_fp",<br/>    'ID1001',   0.1,    80 - 30,     -30,<br/>    'ID1002',   0.2,    80 - 30,     -30,<br/>    'ID1003',   0.3,    80 - 30,     -30,<br/>    'ID1004',   0.4,    80 - 30,     -30,<br/>    'ID1005',   0.5,    80 - 30,     -30,<br/>    'ID1006',   0.6,    80 - 30,     -30,<br/>    'ID1007',   0.7,    80 - 30,     -30,<br/>    'ID1008',   0.8,    80 - 30,     -30,<br/>    'ID1009',   0.9,    80 - 30,     -30,<br/>    'ID1010',   1.0,    80 - 30,     -30<br/>)</span></pre><p id="b8ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用<code class="fe of og oh nw b">purrr</code>将<code class="fe of og oh nw b">expected_profit_func()</code>映射到每个客户，通过阈值返回每个客户的预期利润的数据框架。这个操作创建了一个嵌套tibble，我必须通过<code class="fe of og oh nw b">unnest()</code>将数据帧扩展到一个级别。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="cf82" class="oa ln it nw b gy ob oc l od oe"># calculate expected profit for each at each threshold<br/>expected_profit_ten_cust &lt;- <br/>  ten_cust %&gt;%<br/>      # pmap to map expected_profit_func() to each item<br/>    mutate(expected_profit = pmap(.l = list(p1, cb_tp, cb_fp), <br/>                                  .f = expected_profit_func)) %&gt;%<br/>    unnest() %&gt;%<br/>    select(cust, p1, threshold, expected_profit)</span></pre><p id="2758" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我可以想象每个客户的预期利润曲线。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="9b57" class="oa ln it nw b gy ob oc l od oe"># Visualising Expected Profit <br/>expected_profit_ten_cust %&gt;%<br/>    ggplot(aes(threshold, <br/>               expected_profit, <br/>               colour = factor(cust)), <br/>               group  = cust) +<br/>    geom_line(size = 1) +<br/>    theme_minimal()  +<br/>    tidyquant::scale_color_tq() +<br/>    labs(title  = "Expected Profit Curves",<br/>         colour = "Customer No." ) +<br/>    theme(plot.title = element_text(hjust = 0.5))</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oj"><img src="../Images/43a76f0b2150bfb29688af89f64d14fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MFB1LLJQasouYen3.png"/></div></div></figure><p id="b2ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我可以合计预期利润，可视化最终曲线，并突出显示最佳阈值。</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="bd88" class="oa ln it nw b gy ob oc l od oe"># Aggregate expected profit by threshold <br/>total_expected_profit_ten_cust &lt;- <br/>  expected_profit_ten_cust %&gt;%<br/>    group_by(threshold) %&gt;%<br/>    summarise(expected_profit_total = sum(expected_profit)) </span><span id="65b3" class="oa ln it nw b gy oi oc l od oe"># Get maximum optimal threshold <br/>max_expected_profit &lt;- <br/>  total_expected_profit_ten_cust %&gt;%<br/>    filter(expected_profit_total == max(expected_profit_total))</span><span id="24fa" class="oa ln it nw b gy oi oc l od oe"># Visualize the total expected profit curve<br/>total_expected_profit_ten_cust %&gt;%<br/>    ggplot(aes(threshold, <br/>               expected_profit_total)) +<br/>    geom_line(size = 1) +<br/>    geom_vline(xintercept = max_expected_profit$threshold) +<br/>    theme_minimal() +<br/>    labs(title = "Expected Profit Curve - Total Expected Profit",<br/>         caption  = paste0('threshold @ max = ', <br/>                          max_expected_profit$threshold %&gt;% <br/>                            round(3))) +<br/>    theme(plot.title = element_text(hjust = 0.5))</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oj"><img src="../Images/5eb211f45be31183703b721a2e4cfe89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vb4QpN2jZcy_0v78.png"/></div></div></figure><p id="ebeb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这有一些重要的商业含义。基于我们假设的10个客户群，选择优化的阈值<code class="fe of og oh nw b">0.092</code>将产生近<strong class="js iu"> 164 </strong>的总利润，相比之下，与自动选择的截止点<code class="fe of og oh nw b">0.190</code>相关联的近<strong class="js iu"> 147 </strong>。</p><p id="0753" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将导致每位客户的预期利润增加<strong class="js iu">近1.7</strong>。假设我们有大约<strong class="js iu"> 500，000 </strong>的客户群，转换到优化型号可以产生额外的<strong class="js iu">850，000</strong>的预期利润！</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="9aec" class="oa ln it nw b gy ob oc l od oe">total_expected_profit_ten_cust %&gt;% <br/>  slice(184, 121) %&gt;%<br/>  round(3) %&gt;%<br/>  mutate(diff = expected_profit_total -  <br/>             lag(expected_profit_total))</span><span id="b7c3" class="oa ln it nw b gy oi oc l od oe">## # A tibble: 2 x 3<br/>##   threshold    expected_profit_total    diff<br/>##       &lt;dbl&gt;                    &lt;dbl&gt;   &lt;dbl&gt;<br/>## 1     0.19                      147.     NA  <br/>## 2     0.092                     164.    16.9</span></pre><p id="3228" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">显而易见，根据企业的规模，潜在利润增长的幅度可能是显著的。</p><h1 id="fc03" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">结束语</h1><p id="e05c" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">在这篇文章中，我采用了<strong class="js iu">一个随机森林模型</strong>，它结合了探索性分析的结果和模型选择的洞察力，并实现了一个<strong class="js iu">多客户利润优化</strong>，揭示了每个客户将近1.7<strong class="js iu">的潜在额外预期利润(或者<strong class="js iu"> 85万</strong>，如果你有50万客户群的话)。</strong></p><p id="a4e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我介绍了一些关键概念，如<strong class="js iu">阈值和F1分数</strong>以及<strong class="js iu">精确回忆权衡</strong>，并解释了为什么决定哪个截止值为是非常重要。</p><blockquote class="ok"><p id="31ff" class="ol om it bd on oo op oq or os ot kn dk translated">在探索、清理和格式化数据、拟合和比较多个模型并选择最佳模型之后，坚持使用默认阈值@ Max F1将会是<strong class="ak">达不到最终的“那又怎样？”这使得所有的努力都变成了预期的</strong>。</p></blockquote><p id="aa83" class="pw-post-body-paragraph jq jr it js b jt ou jv jw jx ov jz ka kb ow kd ke kf ox kh ki kj oy kl km kn im bi translated">最后一件事:完成后不要忘记关闭h2o实例！</p><pre class="kp kq kr ks gt nv nw nx ny aw nz bi"><span id="9b6f" class="oa ln it nw b gy ob oc l od oe">h2o.shutdown(prompt = FALSE)</span></pre><h1 id="7a78" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">读者注意</h1><p id="b18d" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">我在本文中使用的<em class="li">随机森林模型</em>结合了探索性分析的结果和模型评估和选择的洞察力。</p><p id="0a1a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你有兴趣看看我是如何得出我用来准备分析数据的结果的，你可以参考我网页上的这篇文章<a class="ae le" href="https://diegousai.io/2020/01/propensity-modelling-data-preparation/" rel="noopener ugc nofollow" target="_blank"> <em class="li">(数据准备和探索性数据分析</em> </a> <em class="li"> ) </em>。</p><p id="66f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了更好地理解导致选择最终模型的决策过程，您可以参考我网页上的这篇文章<a class="ae le" href="https://diegousai.io/2020/02/propensity-modelling-estimate-compare-models/" rel="noopener ugc nofollow" target="_blank"> <em class="li">(使用模型不可知的方法估计几个模型并比较它们的性能</em> </a> <em class="li"> ) </em>。</p><h1 id="1aee" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">代码库</h1><p id="a4c9" class="pw-post-body-paragraph jq jr it js b jt mk jv jw jx ml jz ka kb mm kd ke kf mn kh ki kj mo kl km kn im bi translated">完整的R代码和所有相关文件可以在我的GitHub profile @ <a class="ae le" href="https://github.com/DiegoUsaiUK/Propensity_Modelling" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">倾向建模</strong> </a>中找到</p><h1 id="7e93" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">参考</h1><ul class=""><li id="b8e6" class="nh ni it js b jt mk jx ml kb oz kf pa kj pb kn nm nn no np bi translated">原始论文使用的数据集见:<a class="ae le" href="http://repositorium.sdum.uminho.pt/bitstream/1822/30994/1/dss-v3.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">一种数据驱动的方法来预测银行电话营销的成功。决策支持系统</strong> </a>，S. Moro，P. Cortez和P. Rita。</li><li id="0c30" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated">有关销售预测和产品延期交货优化的高级教程，请参见Matt Dancho的<a class="ae le" href="https://www.business-science.io/business/2017/10/16/sales_backorder_prediction.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">预测销售分析:使用机器学习来预测和优化产品延期交货</strong> </a></li><li id="7e56" class="nh ni it js b jt nq jx nr kb ns kf nt kj nu kn nm nn no np bi translated"><strong class="js iu">期望值框架</strong>见:<a class="ae le" href="https://www.goodreads.com/book/show/17912916-data-science-for-business" rel="noopener ugc nofollow" target="_blank"> <em class="li">商业数据科学</em> </a></li></ul></div><div class="ab cl pc pd hx pe" role="separator"><span class="pf bw bk pg ph pi"/><span class="pf bw bk pg ph pi"/><span class="pf bw bk pg ph"/></div><div class="im in io ip iq"><p id="a1b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="li">原载于2020年3月20日</em><a class="ae le" href="https://diegousai.io/2020/03/propensity-modelling-profit-optimisation/" rel="noopener ugc nofollow" target="_blank"><em class="li">https://diegousai . io</em></a><em class="li">。</em></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pj pk l"/></div></figure></div></div>    
</body>
</html>