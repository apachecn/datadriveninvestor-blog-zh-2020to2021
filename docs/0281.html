<html>
<head>
<title>Memoirs of an API Hacker: Intercepting Encrypted Mobile Traffic to Hack a Bank’s API Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">API黑客回忆录:拦截加密的移动流量以入侵银行的API服务器</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/memoirs-of-an-api-hacker-intercepting-encrypted-mobile-traffic-to-hack-a-banks-api-server-4f74e421197d?source=collection_archive---------1-----------------------#2020-01-22">https://medium.datadriveninvestor.com/memoirs-of-an-api-hacker-intercepting-encrypted-mobile-traffic-to-hack-a-banks-api-server-4f74e421197d?source=collection_archive---------1-----------------------#2020-01-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4454" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“羞愧的魔鬼站在那里，感觉到善良是多么可怕，看到美德在她身上是多么可爱；并渴望着他的损失”——约翰·弥尔顿</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/31de78c09fe907b38fb7b4895caf0b27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bp7RZgjeu3uz8ZZQbt2IBQ.jpeg"/></div></div></figure><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="8962" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在一家大型银行最近的渗透测试中，我能够通过移动应用程序与之通信的银行API服务器向任何账户转账，并更改任何客户的ATM借记卡PIN，而无需进行身份验证。虽然我能够使用<a class="ae ld" href="https://github.com/MobSF/Mobile-Security-Framework-MobSF" rel="noopener ugc nofollow" target="_blank"> MobSF </a>成功地对Android应用程序进行逆向工程，但在发现移动应用程序在与银行通信时使用的大量POST和GET请求时，我并不那么成功。HTTP POST是一种HTTP请求，它指示接收web服务器接受并存储HTTP请求正文中的内容，通常是文件上传或用户对web表单字段的输入。</p><p id="b79e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">于是，我开始寻找一种更具创造性的方法，通过拦截运行在我iPhone上的银行应用程序和银行API服务器之间的流量，手动找到正确的API调用。一旦我在我的手机和银行的API服务器之间传递的众多字符串在<a class="ae ld" href="http://www.mitmproxy.org/" rel="noopener ugc nofollow" target="_blank"> mitmproxy </a>中被拦截，我就能够将POST请求连同预期的HTTP头字段一起加载到<a class="ae ld" href="http://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>中，这是一个能够向API服务器发送请求的API客户端，允许用户检查响应以进行进一步的分析或调试。</p><p id="bcd4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文中显示的Wireshark在成功设置我的iMac以捕获我的iPhone流量后，提供了捕获网络流量的证据。Mitmproxy被用作SSL中间人(PITM)工具来解密SSL流量。虽然Wireshark不能用于检查离开手机的SSL/TLS加密流量，但在渗透测试中使用它来确认移动应用程序没有通过HTTP发送任何未加密的敏感数据是很重要的。因此，我将本文分成了两种方法，一种是使用Wireshark检查未加密的流量，另一种是使用mitmproxy在获得URIs后对API服务器进行攻击。</p><p id="0d08" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文解释了如何使用Mac拦截流出iPhone的流量。在我的设置中，我使用的是运行MacOS Catalina 10.15.2的iPhone 11 Max Pro和iMac Pro 2017。</p><p id="adbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">第一步:发现你手机的唯一标识符。</em> </strong>在做任何事情之前，你首先要确定你的Mac上安装了XCode。为此，只需在Mac app store中搜索XCode即可。安装好XCode后，使用lightning线缆将你的iPhone连接到Mac，然后寻找你手机的标识符，如我在下面<strong class="js iu">图1中的截图所示。</strong></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi le"><img src="../Images/dcbb96a26357384a3f478c15af053184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sII65VaMD9I9uw2y"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk">Figure 1</figcaption></figure><p id="afb1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不要担心必须手动写下整个标识符，因为该字段允许在下一步复制/粘贴时高亮显示。</p><p id="52b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">第二步:在Mac上为你的iPhone创建网络接口。</em> </strong> <em class="ko"> </em>接下来，您需要创建一个接口，我们将使用Wireshark监听该接口。这是一个网络接口，iPhone的所有网络流量都将通过它传输，供您使用Wireshark、tcpdump或您选择的任何其他网络嗅探器进行监听。通过启动应用程序抽屉中的终端并运行<em class="ko"> ifconfig </em> ( <strong class="js iu">图2 </strong>)，列出系统上当前启用的网络接口。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lj"><img src="../Images/3354159c48f8775449e41fcba01b6a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oP4Iz96tDT8wxGJD"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk">Figure 2</figcaption></figure><p id="7b8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">第三步:启动界面。</em> </strong>使用rvictl，启动网络接口，让你可以嗅探离开iPhone的网络流量(<strong class="js iu">图3 </strong>)。这将创建一个名为<em class="ko"> rvi0 </em>的新接口名称。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lk"><img src="../Images/8a539a19f1e325b7b8f42de2933596b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PH5LlDzcp0LQyc2C"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk">Figure 3</figcaption></figure><p id="2077" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">第四步:抓取iPhone网络流量。</em> </strong>通过使用Wireshark，您可以确认您的Mac正在查看来自您的iPhone的所有流入/流出流量。</p><p id="a135" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，您需要启动Wireshark来捕获和检查离开iPhone的未加密流量，确保选择您用rvictl创建的新接口来监听(<strong class="js iu">图4) </strong>)。在下面的截图中，你可以看到我的iPhone和API服务器之间的流量，这表明你的新rvi0接口正在工作。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ll"><img src="../Images/9d26cb92c082f363ae58069daf91cb92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oDEYziuq9Vyid-jJ7kFZng.png"/></div></div></figure><p id="3eea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">第五步:安装并运行mitmproxy。</em> </strong> <em class="ko"> </em>接下来，您需要下载并安装mitmproxy，这是一个免费的开源工具，用于拦截、检查和/或重放SSL/TLS加密流量。要在Mac上安装mitmproxy，使用名为<em class="ko"> Homebrew </em>的命令行实用程序相当简单。安装完成后，使用brew安装mitmproxy。</p><pre class="kq kr ks kt gt lm ln lo lp aw lq bi"><span id="e673" class="lr ls it ln b gy lt lu l lv lw">$ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span></pre><p id="887d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">$ brew安装mitmproxy</p><p id="5318" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在iPhone上启动网络浏览器，访问域名<a class="ae ld" href="http://mitm.it" rel="noopener ugc nofollow" target="_blank"> http://mitm.it </a>，点击iOS图标，将证书安装到您的设备上。</p><p id="1e84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只需使用-P标志或-T-host启动mitmproxy。</p><p id="032f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">$ mitmproxy -T —主机</p><p id="5a40" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第六步:在你的iPhone上设置代理。接下来，找出你运行mitmproxy的Mac的IP地址。您的iPhone和主机应该在同一个无线网络上。将iPhone上的代理设置为运行mitmproxy的IP地址和端口号。</p><p id="384b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为此:</p><p id="3ac4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">设置&gt;Wi-Fi&gt;【I】信息(用于您的无线网络)&gt;配置代理&gt;设置为手动</em></p><p id="9353" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在下面的截图中，你会看到我现在可以在加密的SSL/TLS流量中看到URIs(<strong class="js iu">图5 </strong>)。单击其中一个API POST请求后，我就可以记录下在下一步中在Postman中正确格式化我的POST请求所需的内容。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lx"><img src="../Images/fedb6cbb52ecbb3a59f2af3988d9f60b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t7M4c_YBVRv7qmLfeYOBgw.png"/></div></div></figure><p id="4160" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你完了。此时，您应该能够拦截和解密您的移动设备和API服务器之间的所有SSL/TLS流量，只要您从中捕获流量的应用程序没有任何安全功能来使应用程序崩溃(如果设置了代理或使用证书锁定)。证书锁定应该在任何敏感的应用程序中使用，它有效地将特定主机与预期的X.509证书/公钥进行映射，以防止<em class="ko">person</em>in-the-middle攻击，就像我们在这里尝试做的那样。</p><p id="7e3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这一努力最终使我能够在没有身份验证的情况下为任何银行客户进行转账和更改ATM借记卡PIN码(图6)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ly"><img src="../Images/a728aac12fc9a6eb6549b4805c022ed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqgjVOs3Y21oaLsWYjaJhQ.png"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/2870b28d676790dc9d3c44261fb9ae41.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/0*02tX678hm6F__vzZ"/></div></figure><p id="7c74" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">喜欢和分享。您支持我在网络安全领域继续进行内容开发和影响者工作的最佳方式是喜欢并分享我的文章。请现在就做！</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ma"><img src="../Images/a380184757451061b1b50f60458fb2cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DhvGYONO9qiFGCuM"/></div></div></figure><p id="81c2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">订阅并关注。<a class="ae ld" href="http://youtube.com/c/alissaknight?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank">订阅我的YouTube频道</a>以获得每周上传的我的VLOG、直播流和Vodcast/Podcast剧集的通知，并在<a class="ae ld" href="http://www.twitter.com/@alissaknight" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我。要查看我最新的内容日历，请访问我们公司的网站<a class="ae ld" href="http://www.knightinkmedia.com/" rel="noopener ugc nofollow" target="_blank"> Knight Ink </a>。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="mb lc l"/></div></figure></div></div>    
</body>
</html>