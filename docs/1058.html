<html>
<head>
<title>How to Make Objects Immutable in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Python中使对象不可变</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/immutability-in-python-d57a3b23f336?source=collection_archive---------0-----------------------#2020-02-29">https://medium.datadriveninvestor.com/immutability-in-python-d57a3b23f336?source=collection_archive---------0-----------------------#2020-02-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8a50f8bf01eb5b25c1a9f22536e86510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*77upBwfCGTjuSXiV3ZJuTA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Sands of change? Or immutability?</figcaption></figure><p id="be99" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="ld">变化之沙</em> <strong class="kh iu"> </strong>就在我们身边。。。或者他们是？让我们研究一下Python中的<strong class="kh iu">不变性</strong>。</p><div class="le lf gp gr lg lh"><a href="https://www.datadriveninvestor.com/2019/02/21/best-coding-languages-to-learn-in-2019/" rel="noopener  ugc nofollow" target="_blank"><div class="li ab fo"><div class="lj ab lk cl cj ll"><h2 class="bd iu gy z fp lm fr fs ln fu fw is bi translated">2019年最值得学习的编码语言|数据驱动的投资者</h2><div class="lo l"><h3 class="bd b gy z fp lm fr fs ln fu fw dk translated">在我读大学的那几年，我跳过了很多次夜游去学习Java，希望有一天它能帮助我在…</h3></div><div class="lp l"><p class="bd b dl z fp lm fr fs ln fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="lq l"><div class="lr l ls lt lu lq lv jz lh"/></div></div></a></div><p id="0d93" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">你听说过Python中的一些对象类是<strong class="kh iu">不可变的</strong>，比如<code class="fe lw lx ly lz b">string</code>、<code class="fe lw lx ly lz b">tuple</code>和<code class="fe lw lx ly lz b">int</code>。但是，如果您希望自己的类是不可变的呢？你找对地方了！</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="5479" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">假设我有一个程序，在数据库中记录汽车。一旦汽车生产出来，我不希望汽车的属性有任何改变。一辆<em class="ld">斯巴鲁Crosstrek </em>不可能一夜之间变成<em class="ld">特斯拉Model X </em>，现在可以了吧(可惜)？让我们看看如何实现这一点。</p><h1 id="a1fc" class="mh mi it bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">方法1:__槽_ _</h1><figure class="ng nh ni nj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/4f2d1a89cdf01709674ed45357979f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lK2e9FVV12i1C2_lJChz9Q.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Not that kind of slots!</figcaption></figure><p id="f532" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可能听说过Python对象的<code class="fe lw lx ly lz b">__slots__</code>属性。这精确地指定了对象可能包含的属性列表。它还具有一些性能优势。下面是它的用法示例:</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="4c2e" class="no mi it lz b gy np nq l nr ns">class Car:<br/>    '''Contains information about a car such as make, model, etc.<br/>    '''<br/>    __slots__ = ['make', 'model', 'year', 'color']</span><span id="82eb" class="no mi it lz b gy nt nq l nr ns">    def __init__(self, make, model, year, color):<br/>        self.make = make<br/>        self.model = model<br/>        self.year = year<br/>        self.color = color</span></pre><p id="1a96" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在，你可以看到没有办法添加新的属性！</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="d85f" class="no mi it lz b gy np nq l nr ns">car = Car('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="4c6b" class="no mi it lz b gy nt nq l nr ns">print(car.make)<br/># output: 'Subaru'</span><span id="d5ac" class="no mi it lz b gy nt nq l nr ns">print(car.year)<br/># output: '2018'</span><span id="84b7" class="no mi it lz b gy nt nq l nr ns"># --&gt; try to set a new attribute, I dare you!<br/>car.all_wheel_drive = True<br/>---------------------------------------------------------------------------<br/>AttributeError                            Traceback (most recent call last)<br/>&lt;ipython-input-216-f3fe1ffbcb21&gt; in &lt;module&gt;<br/>----&gt; 1 car.all_wheel_drive = True</span><span id="ce09" class="no mi it lz b gy nt nq l nr ns">AttributeError: 'Car' object has no attribute 'all_wheel_drive'</span></pre><p id="a4e5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然而，你可能已经注意到了这里的一些东西。。。该对象不是不可变的。<strong class="kh iu">您仍然可以更改</strong> <code class="fe lw lx ly lz b">__slots__</code> <strong class="kh iu">中设置的所有值！！</strong></p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="3991" class="no mi it lz b gy np nq l nr ns">car = Car('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="39dd" class="no mi it lz b gy nt nq l nr ns">print(car.make)<br/># output: 'Subaru'</span><span id="439a" class="no mi it lz b gy nt nq l nr ns"># change existent value<br/>car.make = 'Ferrari'</span><span id="4f28" class="no mi it lz b gy nt nq l nr ns">print(car.make)<br/># output: 'Ferrari'</span></pre><p id="7086" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">啊哦。让我们试试另一种方法，好吗？</p><h1 id="95c2" class="mh mi it bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">方法2:“冷冻机”的子类</h1><figure class="ng nh ni nj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/37c463eeeb082a1f098709d683e80b1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dlx9zMiweqGQH8cshhREEw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Not that kind of frozen!</figcaption></figure><p id="71af" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这种方法中，我创建了一个名为<code class="fe lw lx ly lz b">Freezer</code>的父类。你要做的就是从<code class="fe lw lx ly lz b">Freezer</code>开始子类化。</p><p id="446e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在Python初始化之后，我通过覆盖对象上的<code class="fe lw lx ly lz b">__delattr__</code>和<code class="fe lw lx ly lz b">__setattr__</code>方法来“冻结”对象。我设置了<code class="fe lw lx ly lz b">_frozen = True</code>,表示实例现在已经“冻结”了。</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="f4ea" class="no mi it lz b gy np nq l nr ns">class Freezer:<br/>    '''Freeze any class, such that instantiated<br/>    objects become immutable.<br/>    '''<br/>    _frozen = False</span><span id="9704" class="no mi it lz b gy nt nq l nr ns">    def __init__(self):<br/>        self._frozen = True</span><span id="11f8" class="no mi it lz b gy nt nq l nr ns">    def __delattr__(self, *args, **kwargs):<br/>        if self._frozen:<br/>            raise AttributeError('This object is frozen!')<br/>        object.__delattr__(self, *args, **kwargs)</span><span id="7e44" class="no mi it lz b gy nt nq l nr ns">    def __setattr__(self, *args, **kwargs):<br/>        if self._frozen:<br/>            raise AttributeError('This object is frozen!')<br/>        object.__setattr__(self, *args, **kwargs)</span></pre><p id="c178" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这是我重新定义的<code class="fe lw lx ly lz b">FreezerCar</code>类，它是<code class="fe lw lx ly lz b">Freezer</code>的子类。</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="90cb" class="no mi it lz b gy np nq l nr ns">class FreezerCar(Freezer):<br/>    '''Contains information about a car such as make, model, etc.<br/>    '''<br/>    def __init__(self, make, model, year, color):<br/>        self.make = make<br/>        self.model = model<br/>        self.year = year<br/>        self.color = color</span><span id="ca89" class="no mi it lz b gy nt nq l nr ns">        # initialize parent class "Freezer"<br/>        super().__init__()</span></pre><p id="dff2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在，让我们确保这个工作！</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="e584" class="no mi it lz b gy np nq l nr ns">freezer_car = FreezerCar('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="df49" class="no mi it lz b gy nt nq l nr ns">print(freezer_car.make)<br/># output: 'Subaru'</span><span id="a71f" class="no mi it lz b gy nt nq l nr ns">print(freezer_car.year)<br/># output: '2018'</span><span id="3b38" class="no mi it lz b gy nt nq l nr ns"># --&gt; try to set a new attribute, I dare you!<br/>freezer_car.all_wheel_drive = True</span><span id="e053" class="no mi it lz b gy nt nq l nr ns"># you'll get an ERROR: AttributeError: This object is frozen!</span><span id="94fd" class="no mi it lz b gy nt nq l nr ns"># --&gt; try to change an existent attribute, I dare you!<br/>freezer_car.make = 'Ferrari'</span><span id="e06a" class="no mi it lz b gy nt nq l nr ns"># you'll get an ERROR: AttributeError: This object is frozen!</span></pre><p id="33da" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在<strong class="kh iu">这就是</strong>我说的！</p><h1 id="8838" class="mh mi it bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">方法3:为什么不两者都用？</h1><figure class="ng nh ni nj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/51e37a4aa9690450d989f6850ccff598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-LCZBXMlv7lGV5V3XFmQg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Not that kind of combine!</figcaption></figure><p id="0fd9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">“方法2”对于不变性是足够的。然而，如果我们同时使用<code class="fe lw lx ly lz b">__slots__</code>和<code class="fe lw lx ly lz b">Freezer</code>实现会怎么样呢？如果我们结合我们的方法呢？嗯。。。只有一个办法可以知道！让我们来调查一下:</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="5316" class="no mi it lz b gy np nq l nr ns">class SlotsFreezer:<br/>    '''Freeze any class such that instantiated<br/>    objects become immutable. Also use __slots__ for speed.<br/>    '''<br/>    __slots__ = []<br/>    _frozen = False</span><span id="5bf5" class="no mi it lz b gy nt nq l nr ns">    def __init__(self):<br/>        # generate __slots__ list dynamically<br/>        for attr_name in dir(self):<br/>            self.__slots__.append(attr_name)</span><span id="ba7a" class="no mi it lz b gy nt nq l nr ns">        self._frozen = True</span><span id="f385" class="no mi it lz b gy nt nq l nr ns">    def __delattr__(self, *args, **kwargs):<br/>        if self._frozen:<br/>            raise AttributeError('This object is frozen!')<br/>        object.__delattr__(self, *args, **kwargs)</span><span id="250d" class="no mi it lz b gy nt nq l nr ns">    def __setattr__(self, *args, **kwargs):<br/>        if self._frozen:<br/>            raise AttributeError('This object is frozen!')<br/>        object.__setattr__(self, *args, **kwargs)</span></pre><p id="c20c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这里是重新定义的<code class="fe lw lx ly lz b">SlotsFreezerCar</code>类，它是<code class="fe lw lx ly lz b">SlotsFreezer</code>的子类</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="0262" class="no mi it lz b gy np nq l nr ns">class SlotsFreezerCar(SlotsFreezer):<br/>    '''Contains information about a car such as make, model, etc.<br/>    '''<br/>    def __init__(self, make, model, year, color):<br/>        self.make = make<br/>        self.model = model<br/>        self.year = year<br/>        self.color = color</span><span id="6e4f" class="no mi it lz b gy nt nq l nr ns">        # initialize parent class "SlotsFreezer"<br/>        super().__init__()</span></pre><p id="e68b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">以下是时间表！注意:为了比较，我包含了一个基本的car类实现，没有插槽。</p><pre class="ng nh ni nj gt nk lz nl nm aw nn bi"><span id="e8e7" class="no mi it lz b gy np nq l nr ns"># SETUP<br/>class NormalCar:<br/>    def __init__(self, make, model, year, color):<br/>        self.make = make<br/>        self.model = model<br/>        self.year = year<br/>        self.color = color</span><span id="7d0b" class="no mi it lz b gy nt nq l nr ns">slots_freezer_car = SlotsFreezerCar('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="7bf5" class="no mi it lz b gy nt nq l nr ns">freezer_car = SlotsFreezerCar('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="0fe8" class="no mi it lz b gy nt nq l nr ns">car = SlotsFreezerCar('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="09bc" class="no mi it lz b gy nt nq l nr ns">normal_car = NormalCar('Subaru', 'Crosstrek', '2018', 'Blue')</span><span id="aec3" class="no mi it lz b gy nt nq l nr ns"># TIMING</span><span id="d413" class="no mi it lz b gy nt nq l nr ns">%timeit getattr(freezer_car, 'make')</span><span id="879c" class="no mi it lz b gy nt nq l nr ns"># 106 ns ± 0.457 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)</span><span id="75dc" class="no mi it lz b gy nt nq l nr ns">%timeit getattr(slots_freezer_car, 'make')</span><span id="c1ac" class="no mi it lz b gy nt nq l nr ns"># 106 ns ± 0.706 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)</span><span id="7bee" class="no mi it lz b gy nt nq l nr ns">%timeit getattr(car, 'make')</span><span id="7023" class="no mi it lz b gy nt nq l nr ns"># 106 ns ± 2.66 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)</span><span id="8ad4" class="no mi it lz b gy nt nq l nr ns">%timeit getattr(normal_car, 'make') # WINNER !!!!</span><span id="6edd" class="no mi it lz b gy nt nq l nr ns"># 97 ns ± 0.321 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)</span></pre><p id="b850" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">韦尔普，这很有趣。<strong class="kh iu">我猜在Python中聪明并不总是有回报的！</strong> <em class="ld">有时候简单其实更好。:)</em></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="2030" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对此有一些警告，它们是:</p><ol class=""><li id="a2be" class="nv nw it kh b ki kj km kn kq nx ku ny ky nz lc oa ob oc od bi translated">Python的<code class="fe lw lx ly lz b">dict</code>有其他方法<code class="fe lw lx ly lz b">__delitem__</code>和<code class="fe lw lx ly lz b">__setitem__</code>用来改变对象。如果您从<code class="fe lw lx ly lz b">dict</code>继承并且需要不变性，那么对于这两个方法，请遵循上面的模式</li><li id="9b9e" class="nv nw it kh b ki oe km of kq og ku oh ky oi lc oa ob oc od bi translated">更复杂的类在性能方面可能有不同的行为。请记住，更复杂的实现可能对您的情况有所帮助。</li><li id="57cc" class="nv nw it kh b ki oe km of kq og ku oh ky oi lc oa ob oc od bi translated">不变性可能会在以后伤害你，尤其是在复杂的类层次结构中。Python作者没有包含内置的<code class="fe lw lx ly lz b">make_immutable</code>函数是有原因的。:)</li></ol></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="cffe" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">你走之前还有一件事。以下是一些有用的链接:</p><ul class=""><li id="2c3e" class="nv nw it kh b ki kj km kn kq nx ku ny ky nz lc oj ob oc od bi translated"><a class="ae ok" href="https://medium.com/ibm-watson/incredibly-fast-random-sampling-in-python-baf154bd836a" rel="noopener">Python中难以置信的快速随机采样</a></li><li id="289f" class="nv nw it kh b ki oe km of kq og ku oh ky oi lc oj ob oc od bi translated"><a class="ae ok" href="https://www.ibm.com/cloud/machine-learning" rel="noopener ugc nofollow" target="_blank">用沃森机器学习训练机器学习模型</a></li><li id="5fa1" class="nv nw it kh b ki oe km of kq og ku oh ky oi lc oj ob oc od bi translated"><a class="ae ok" href="https://www.ibm.com/watson/services/natural-language-understanding/" rel="noopener ugc nofollow" target="_blank">使用沃森自然语言理解从文本中提取见解</a></li><li id="d970" class="nv nw it kh b ki oe km of kq og ku oh ky oi lc oj ob oc od bi translated"><a class="ae ok" href="https://blog.goodaudience.com/https-medium-com-ethankoch-how-to-become-an-nlp-expert-81cb94989612" rel="noopener ugc nofollow" target="_blank">了解如何成为NLP专家</a></li></ul><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ol om l"/></div></figure></div></div>    
</body>
</html>