<html>
<head>
<title>Production ready Architecture for fetching websites screenshots at scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于大规模获取网站截图的生产就绪型架构</h1>
<blockquote>原文：<a href="https://medium.datadriveninvestor.com/production-ready-architecture-for-fetching-websites-screenshots-at-scale-5094c31f6324?source=collection_archive---------14-----------------------#2020-06-12">https://medium.datadriveninvestor.com/production-ready-architecture-for-fetching-websites-screenshots-at-scale-5094c31f6324?source=collection_archive---------14-----------------------#2020-06-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="51c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="http://greendeck.co" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Greendeck </strong> </a>，我们还向我们的客户提供<strong class="jp ir">市场情报</strong>，为此，我们每天捕捉各种网站和时事通讯的数千张快照。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/46201c012879ffe094ec4d2edf721aea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*00i6SDPgMJdMsWJtYFTPOg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Greendeck Product offerings</figcaption></figure><p id="4b88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">市场情报和捕捉快照有什么关系？</strong></p><p id="77cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">电子商务商店需要跟踪如此多的变量，以设定其产品的定价、报价和销售。他们需要跟踪竞争对手产品的定价、他们正在进行的销售、他们的简讯、优惠以及他们在网站首页上展示的产品。</p><p id="2c4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么我们需要捕捉每个竞争对手网站的首页和他们发送的简讯的快照。</p><p id="8034" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">这对任何人都有帮助？</strong></p><p id="b32a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对<strong class="jp ir">营销人员很有帮助。</strong>因为营销人员可以很容易地知道这个特定的品牌在这个特定的日子进行销售，并且他们也通过他们的时事通讯推广他们的新产品。这有助于他们快速做出决定。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="a7b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://blog.greendeck.co/beyond-requests/" rel="noopener ugc nofollow" target="_blank">之前的博文</a>中，我讨论了Greendeck零售智能部分的数据端核心。</p><p id="fa8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这一篇中，我将涉及到跟踪电子商务商店的一些营销活动的数据方面。这些主要包括；跟踪他们的网站，他们的特色产品，他们正在进行的销售，以及他们发送给客户的简讯。</p><div class="lj lk gp gr ll lm"><a href="https://www.datadriveninvestor.com/2020/01/16/software-development-process-how-to-pick-the-right-process/" rel="noopener  ugc nofollow" target="_blank"><div class="ln ab fo"><div class="lo ab lp cl cj lq"><h2 class="bd ir gy z fp lr fr fs ls fu fw ip bi translated">软件开发过程:如何选择正确的过程？数据驱动的投资者</h2><div class="lt l"><h3 class="bd b gy z fp lr fr fs ls fu fw dk translated">软件是任何企业组织成功的生命线。没有软件的帮助，一个…</h3></div><div class="lu l"><p class="bd b dl z fp lr fr fs ls fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="lv l"><div class="lw l lx ly lz lv ma kw lm"/></div></div></a></div><p id="3fa5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建这项服务就像构建我们自己的小型网络存档机器一样。这非常有趣，我们将与您分享我们正在做的事情。</p><p id="4c8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主要是两个服务完成所有这些工作。一个是<strong class="jp ir">快照服务</strong>另一个是<strong class="jp ir">简讯服务。</strong></p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h2 id="6220" class="mb mc iq bd md me mf dn mg mh mi dp mj jy mk ml mm kc mn mo mp kg mq mr ms mt bi translated">快照服务</h2><p id="621b" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">简而言之，给定一个网站URL或HTML，该服务捕获整个页面的快照，并将其存储在亚马逊S3桶中。它24x7全天候运行，所有这些都是自动完成的。它处理弹出窗口出现的所有问题，并使用无头浏览器完成所有任务。在这篇博文中，我们将了解它是如何做到所有这些事情的。</p><h2 id="fcd7" class="mb mc iq bd md me mf dn mg mh mi dp mj jy mk ml mm kc mn mo mp kg mq mr ms mt bi translated">时事通讯服务</h2><p id="5025" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">这项服务跟踪电子商务商店发送给客户的所有简讯。在这项服务中，他们是许多活动的部分，但那是另外一天。</p><p id="baa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>该服务大量使用快照服务在无头浏览器上呈现HTML，然后捕获快照。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h2 id="b0f4" class="mb mc iq bd md me mf dn mg mh mi dp mj jy mk ml mm kc mn mo mp kg mq mr ms mt bi translated">快照服务</h2><p id="7f3a" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">快照服务是一个轻量级的flask应用程序，24x7全天候运行，主要有两个端点:/url和/html端点。</p><p id="fef0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">/url端点接受post请求中的url以及许多参数，如驱动程序必须等待页面呈现的时间。</p><p id="ebfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们尝试在一个无头浏览器中打开给定的URL，不做任何事情，然后捕获页面的快照。但是事情并不像预期的那样发展。以下是我们遇到的一些问题以及我们是如何解决的:</p><p id="fd62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有些网站根本打不开。为什么？网站屏蔽了我们，因为他们知道请求资源的是代码，而不是人。所以，我们用<strong class="jp ir">用户代理</strong>来解决这个问题。</p><pre class="kn ko kp kq gt mz na nb nc aw nd bi"><span id="a756" class="mb mc iq na b gy ne nf l ng nh">from selenium.webdriver.chrome.options import Options</span><span id="76a0" class="mb mc iq na b gy ni nf l ng nh">chrome_options = Options()<br/>chrome_options.add_argument('--headless')<br/>chrome_options.add_argument('--no-sandbox')<br/>chrome_options.add_argument('--disable-dev-shm-usage')</span><span id="1065" class="mb mc iq na b gy ni nf l ng nh">user_agent = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36'</span><span id="c463" class="mb mc iq na b gy ni nf l ng nh">chrome_options.add_argument('user-agent={0}'.format(user_agent))</span></pre><p id="57e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用用户代理后，我们遇到了另一个问题，那就是生成的页面没有按照我们想要的方式呈现。为什么？<strong class="jp ir">单页应用程序。</strong>这种使用像<strong class="jp ir"> Vue和React </strong>这样的框架构建单页面应用的革命在web开发行业非常普遍。驱动程序需要一些时间来组合服务器返回的所有沉重的javascript，以将其呈现为一个完整的页面。</p><p id="97c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案</strong>:等待几秒钟，让页面在浏览器中呈现。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nj"><img src="../Images/c91602a83cc521f029f32cb87e7e97e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*brTnlwXkYs2Xe3sN8rrxxA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Single-page app: working flow (Client-side rendering)</figcaption></figure><p id="f4c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> c)阻止或删除弹出窗口:</strong></p><p id="3b21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几乎我们访问的每个网站都会在你访问的时候闪现一些弹出窗口。它可以是一个正在运行的服务，或者只是一个嵌入式页面来订阅他们的时事通讯。我们还需要在截图之前删除它们。</p><p id="780b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案</strong>:在弹出窗口的<strong class="jp ir"> Xpath </strong>和弹出窗口的类名等相关的post请求中，传递所需的参数和网址，以便chrome驱动程序可以捕获弹出窗口元素，然后我们可以使用<code class="fe nk nl nm na b">click</code>函数将其移除。</p><pre class="kn ko kp kq gt mz na nb nc aw nd bi"><span id="fbe6" class="mb mc iq na b gy ne nf l ng nh">from selenium import webdriver<br/>from selenium.webdriver.support.ui import WebDriverWait<br/>from selenium.webdriver.support import expected_conditions as EC</span><span id="fd14" class="mb mc iq na b gy ni nf l ng nh">driver = webdriver.Chrome()</span><span id="75c6" class="mb mc iq na b gy ni nf l ng nh">element_present = EC.presence_of_element_located((By.XPATH, popup_xpath))</span><span id="141e" class="mb mc iq na b gy ni nf l ng nh">WebDriverWait(driver, time_delay).until(element_present)</span><span id="1eb0" class="mb mc iq na b gy ni nf l ng nh">driver.find_element_by_xpath(popup_xpath).click()</span></pre><p id="e1b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> d) </strong> <strong class="jp ir">捕捉页面的完整高度和宽度:</strong></p><p id="8e80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要捕捉一个单一的快照网站的完整页面。为此，我们需要通过从顶部<code class="fe nk nl nm na b">(0,0)</code>向下滚动到底部来计算页面的总高度和宽度，以便我们可以进一步设置chrome驱动程序的高度和宽度。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nn no l"/></div></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="4968" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">快照服务工作:</strong></p><ol class=""><li id="3d7e" class="np nq iq jp b jq jr ju jv jy nr kc ns kg nt kk nu nv nw nx bi translated">通过一个端点上的post请求接受url/html。</li><li id="559d" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">像设置用户代理一样，在打开驱动之前设置chrome选项。</li><li id="b2a3" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">打开驱动程序。</li><li id="bf78" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">提个要求。</li><li id="3fc5" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">由于是单页应用程序，请等待页面呈现。</li><li id="0a86" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">通过再次刷新页面或单击来删除弹出窗口。</li><li id="4889" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">从上到下(0，0)滚动到底部，以捕捉要捕捉的页面的完整高度和宽度。</li><li id="789f" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">设置驱动器的宽度和高度。</li><li id="d9d4" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">捕捉快照。</li><li id="6140" class="np nq iq jp b jq ny ju nz jy oa kc ob kg oc kk nu nv nw nx bi translated">将捕获的快照存储在S3存储桶中，然后返回存储文件的url。</li></ol><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi od"><img src="../Images/10a9b8bc936efc0dd17ef094c710fb07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RyeZKwjke0wng5sVkCmJSw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Snapshot service working</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="30f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这项服务需要每天捕获快照。为了实现这一点，我们使用了一个名为<a class="ae kl" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache airflow </a>的工作流管理工具。我们已经通过构建服务完成了我们的工作，剩下的调度部分全部由气流处理。</p><p id="df8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一篇文章将会介绍简讯服务是如何工作的，以及它是如何利用快照服务来完成这项工作的。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="oe no l"/></div></figure></div></div>    
</body>
</html>